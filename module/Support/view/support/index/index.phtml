<link rel="stylesheet" type="text/css" href="<?php echo $this->basePath(); ?>/public/css/assets.css">
<style>
    .btn {
    
    padding: 0px 0px;
  }

 /* ‚Äî‚Äî In Process table action buttons (override global .btn) ‚Äî‚Äî */
.inprocess-table td:last-child .btn {
  padding: 6px 12px !important;
  font-size: 12px !important;
  font-weight: 700;
  border-radius: 9999px;
  border: 1px solid #e5e7eb;
  background: #f3f4f6;
  color: #111827;
  line-height: 1;
  cursor: pointer;
  transition: transform .04s ease, background .15s ease, box-shadow .15s ease;
}
/* add/replace */
.action-dd__menu.is-floating{
  position: fixed !important;
  top: 0; left: 0;                 /* JS will set exact coords */
  right: auto !important;          /* ‚¨ÖÔ∏è kill the full-width stretch */
  width: max-content;              /* size to content */
  min-width: 200px;
  max-width: 320px;                /* keep it tidy */
  z-index: 100000;
}

/* spacing in the action cell */
.inprocess-table td:last-child > div {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* ‚ÄúBack to Pending‚Äù = ghost style */
.inprocess-table .back-to-pending {
  background: #ffffff !important;
  border-color: #d1d5db !important;
  color: #374151 !important;
}
.inprocess-table .back-to-pending:hover {
  background: #f9fafb !important;
  box-shadow: 0 1px 2px rgba(0,0,0,.06);
}
/* Optional: global reset ko mellow karo */
.btn { padding: 0; } /* keep as-is */
.inprocess-table .btn { padding: 6px 12px !important; } /* specificity fix */

/* ‚ÄúResolve‚Äù = solid success */
.inprocess-table .mark-resolved {
  background: #10b981 !important;
  border-color: #10b981 !important;
  color: #ffffff !important;
}
.inprocess-table .mark-resolved:hover {
  filter: brightness(0.95);
  box-shadow: 0 2px 8px rgba(16,185,129,.25);
}

/* small press effect */
.inprocess-table td:last-child .btn:active {
  transform: translateY(1px);
}

/* disabled state (AJAX during click) */
.inprocess-table td:last-child .btn[disabled],
.inprocess-table td:last-child .btn:disabled {
  opacity: .6;
  cursor: not-allowed;
  box-shadow: none !important;
}

/* badges look */
.inprocess-table .badge {
  display: inline-block;
  border-radius: 9999px;
  padding: 4px 10px;
  font-size: 12px;
  font-weight: 700;
}


  /* Resolved issues wrapper */
#issueCardsWrapper {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
  gap: 20px;
}

/* Each issue card full responsive block */
#issueCardsWrapper .issueCard {
  flex: unset !important;    /* remove old flex */
  max-width: 100% !important;
}

  /* ‚Äî‚Äî‚Äî FULL VIEW OVERRIDES ‚Äî‚Äî‚Äî */

/* 1) Global: koi horizontal scroll nahi, full-bleed width */
html, body {
  width: 100%;
  max-width: 100%;
  overflow-x: hidden;
}

/* 2) Wrapper: full width; center padding minimal/optional */
.wrapper {
  max-width: none !important;
  width: 100% !important;
  margin: 0 !important;
  padding-left: 0 !important;
  padding-right: 0 !important;
}

/* 3) Section card: thoda compact padding, full feel */
.section-card {
  border-radius: 0;                 /* full-bleed look */
  padding: 24px 24px !important;    /* optional: 0 0 if bilkul edge chahiye */
  box-shadow: none;                 /* subtle/none */
}

/* 4) Inner cap hatao ‚Äî already centered feel aa jayega */
.card-inner {
  max-width: none !important;
  width: 100% !important;
  padding-left: 0 !important;
  padding-right: 0 !important;
}

/* 5) Grids/tables ko puri width use karne do */
.rights-table,
.admin-rights-table {
  width: 100% !important;
  table-layout: fixed;
}

/* 6) Overview ke quick cards ko screen ke hisaab se wrap hone do */
div[style*="grid-template-columns"] {
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)) !important;
}

/* 7) Side panel width thodi badi on desktop (optional) */
@media (min-width: 1280px) {
  #sidePanel {
    width: 480px !important;
    right: -480px; /* closed state match */
  }
}

/* 8) Resolved issue cards: 2 ‚Üí auto-fit columns on big screens */
.issueCard {
  flex: 1 1 420px !important;
  max-width: 100% !important;
  border: 1px solid #e5e7eb;
}

/* 9) Tables ki long cells better wrap */
.rights-table td:nth-child(3),
.rights-table td:nth-child(4),
.rights-table td:nth-child(5),
.rights-table td:nth-child(6) {
  max-width: none !important;
  word-break: break-word;
}

/* 10) Mobile padding thoda rakho so content chipke nahi */
@media (max-width: 768px) {
  .section-card { padding: 16px !important; }
}

/* ‚Äî‚Äî‚Äî BUG FIX: malformed comment thik karo ‚Äî‚Äî‚Äî */
/* üü° If only one card, center it and fix its width */
#issueCardsWrapper:has(.issueCard:nth-child(1):last-child) {
  justify-content: center;
}
#issueCardsWrapper:has(.issueCard:nth-child(1):last-child) .issueCard {
  flex: 0 0 500px;
  max-width: 500px;
}

  body {
    margin: 0;
    padding: 0;
    background: #f8f9fc;
    font-family: 'Inter', sans-serif;
    color: #1f2937;
  }
/* üéØ Wrapper with soft centered max-width for large screens */
.wrapper {
  max-width: 1440px;
  margin: 0 auto;
  padding: 20px 40px;
  width: 100%;
}

/* üéØ Section card with subtle padding and shadow, full-width feeling */
.section-card {
  background: #fff;
  border-radius: 16px;
  padding: 30px 40px;
  /*box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);*/
  margin-bottom: 40px;
}
  .section-header {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
  }
  .section-header .avatar {
    width: 60px;
    height: 60px;
    background-color: #6b44cb;
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 600;
    margin-right: 20px;
  }
  .section-header .info h2 {
    font-size: 22px;
    font-weight: 700;
    margin: 0;
  }
  .section-header .info p {
    font-size: 14px;
    color: #6b7280;
    margin: 4px 0 0;
  }
  .alert-box {
    background: #eef4ff;
    border-left: 4px solid #3b82f6;
    padding: 16px 20px;
    border-radius: 8px;
    color: #1e3a8a;
    margin-bottom: 30px;
    font-size: 15px;
  }
  .tab-nav {
    display: flex;
    gap: 30px;
    margin-bottom: 30px;
    border-bottom: 2px solid #e5e7eb8f;
  }
  .tab-nav button {
    background: none;
    border: none;
    font-weight: 600;
    font-size: 14px;
    padding: 10px 0;
    cursor: pointer;
    color: #6b7280;
    position: relative;
  }
  .tab-nav button.active {
    color: #6b44cb;
  }
  .tab-nav button.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: #6b44cb;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }

  .rights-subtab-btn {
    padding: 8px 18px;
    font-weight: 600;
    font-size: 13px;
    border-radius: 20px;
    border: 1px solid #ccc;
    background: #fff;
    color: #6b7280;
    cursor: pointer;
  }
  .rights-subtab-btn.rights-active {
    background: #eef2ff;
    color: #4f46e5;
    border-color: #c7d2fe;
  }
  .rights-subtab-content {
    display: none;
  }
  .rights-subtab-content.active {
    display: block;
  }
  .rights-subtab-content table tbody tr:hover {
    background-color: #fef3c7;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .hover-box:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: 0.2s;
  }

  /* üéØ Bar fill animation */
  .bar-fill {
    height: 16px;
    border-radius: 8px;
    background-color: currentColor;
    width: 0;
    transition: width 1.4s ease-out;
    margin: 6px 0;
  }
  
  .rights-table {
  table-layout: fixed;
  width: 100%;
}

.rights-table th,
.rights-table td {
  padding: 10px;
  text-align: left;
  font-size: 12px;
  vertical-align: top;
  word-wrap: break-word;
  word-break: break-word;
}

.rights-table td:nth-child(3), /* Asset Title */
.rights-table td:nth-child(4), /* Asset Link */
.rights-table td:nth-child(5), /* Artist */
.rights-table td:nth-child(6)  /* UPC */ {
  max-width: 200px;
}
  
  .rights-table td.limit-text {
  max-height: 48px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: normal;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  line-height: 1.4em;
  max-width: 200px;
}
  
.admin-rights-table {
  table-layout: fixed;
  width: 100%;
}


.admin-rights-table td:nth-child(3),
.admin-rights-table td:nth-child(5) {
  max-width: 180px;
  white-space: normal;
}

.admin-rights-table td:nth-child(8) {
  min-width: 160px;
}

textarea.reject-reason-box {
  max-width: 200px;
  resize: vertical;
}  
.admin-rights-table .status-form {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
  max-width: 100%;
}

.admin-rights-table .status-form select,
.admin-rights-table .status-form button {
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 4px;
}

.admin-rights-table .status-form .reject-reason-box {
  width: 100%;
  margin-top: 6px;
  font-size: 12px;
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.admin-rights-table .status-form > div {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: flex-start;
}

.action-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  align-items: center;
  justify-content: center;
}

.action-modal.active {
  display: flex !important;
}

  .card-inner {
  max-width: 1280px;
  width: 100%;
  margin: 0 auto;
  padding: 0 10px;
  box-sizing: border-box;
}
 .status-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 14px;
  font-size: 12px;
  font-weight: 600;
  margin-top: 6px;
  text-transform: capitalize;
}

.status-approved {
  background: #d1fae5;
  color: #065f46;
}

.status-rejected {
  background: #fee2e2;
  color: #991b1b;
}

.status-pending {
  background: #fef3c7;
  color: #92400e;
}
.link-copy-box {
  background: #f9fafb;
  border: 1px solid #d1d5db;
  padding: 10px 12px;
  border-radius: 6px;
  font-size: 13px;
  color: #1f2937;
  width: 100%;
  overflow-wrap: break-word;
  margin-bottom: 8px;
  position: relative;
}

.copy-btn-small {
  position: absolute;
  top: 6px;
  right: 10px;
  background: none;
  border: none;
  font-size: 13px;
  cursor: pointer;
  color: #6b7280;
}
.category-badge {
  display: inline-block;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 12px;
  font-weight: 600;
  text-transform: capitalize;
  margin-top: 4px;
}

.category-release {
  background-color: #e0f2fe;
  color: #0284c7;
}

.category-monetize {
  background-color: #ecfdf5;
  color: #059669;
}

.category-takedown {
  background-color: #fef2f2;
  color: #dc2626;
}

.category-infringement {
  background-color: #f3e8ff;
  color: #7c3aed;
}
.flag-label {
  background: #fef08a;
  color: #92400e;
  font-size: 11px;
  font-weight: 600;
  padding: 2px 6px;
  margin-left: 6px;
  border-radius: 6px;
}
.custom-tooltip-btn {
  position: relative;
}

.custom-tooltip-btn::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  background: #111;
  color: #fff;
  padding: 6px 10px;
  font-size: 12px;
  border-radius: 6px;
  white-space: nowrap;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease-in-out;
  z-index: 1000;
}

.custom-tooltip-btn:hover::after {
  opacity: 1;
}
.range-btn {
  background: #f3f4f6;
  color: #111827;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 20px;
  text-decoration: none;
  transition: 0.3s ease;
}
.range-btn:hover {
  background: #e5e7eb;
}
.range-btn.active {
  background: #7d2491;
  color: #fff;
}


/* Small lock pill */
.lock-pill {
    display: inline-block;
    margin-top: 6px;
    padding: 1px 3px;
    font-size: 10px;
    font-weight: 700;
    color: #92400e;
    background: #fef3c7;
    border: 1px solid #fcd34d;
    border-radius: 10px;
}

/* Non-admin ke liye locked row me clickable cheezen visually disabled */
.is-locked .open-action-modal,
.is-locked .open-links,
.is-locked .mark-in-process,
.is-locked .back-to-pending,
.is-locked .mark-resolved{
  opacity:.45;
  cursor:not-allowed !important;
  pointer-events:none;
}

/* Row ke cursor ko neutral karo jab lock + non-admin */
body:not(.is-admin) .is-locked{
  cursor: default !important;
}

#issueCardsWrapper {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start; /* default */
  gap: 20px;
}

.issueCard {
  flex: 1 1 calc(50% - 20px);
  max-width: calc(50% - 20px);
}

/* Agar sirf ek card ho to bhi left aligned */
#issueCardsWrapper:has(.issueCard:nth-child(1):last-child) {
  justify-content: start !important;
}
 üü° If only one card, center it and fix its width */
*/#issueCardsWrapper:has(.issueCard:nth-child(1):last-child) {
  justify-content: center;
}

#issueCardsWrapper:has(.issueCard:nth-child(1):last-child) .issueCard {
  flex: 0 0 500px; /* or 100%, or 400px - whatever looks good */
  max-width: 500px;
}
/* Side panel: use transform for slide */
#sidePanel{
  position: fixed;
  top: 0;
  right: 0;                 /* <- always 0 */
  width: 420px;
  height: 100%;
  background: #fff;
  box-shadow: -4px 0 24px rgba(0,0,0,0.06);
  z-index: 10000;
  overflow-y: auto;
  padding: 24px 20px;
  font-family: 'Inter', sans-serif;

  transform: translateX(100%);   /* closed */
  transition: transform .3s ease-in-out;
}
#sidePanel.open{                 /* open state */
  transform: translateX(0);
}

/* (optional) desktop width */
@media (min-width:1280px){
  #sidePanel{ width:480px; }
}

/* üßæ Sidebar heading (if used) */
#sidePanel h4 {
  font-size: 16px;
  font-weight: 600;
  color: #0f172a;
  margin-bottom: 20px;
}

/* ‚ú® Main boxed container */
#sidePanel .asset-main-box {
  border: 1px solid #e5e7eb;
  background: #f9fafb;
  border-radius: 14px;
  padding: 18px;
  margin-bottom: 24px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.03);
}

/* üî† Each field inside the box */
#sidePanel .asset-field {
  margin-bottom: 16px;
}

#sidePanel .asset-field small {
    display: block;
    font-size: 11px;
  font-weight: 700;
    color: #585858;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
#sidePanel .asset-field .value {
  font-size: 14px;
  font-weight: 700;
  color: #1f2937;
  word-break: break-word;
}
.action-dd{position:relative;display:inline-block}
.action-dd__btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:6px 10px;font-weight:700;font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;line-height:1}
.action-dd__btn .dot{width:3px;height:3px;background:#6b7280;border-radius:9999px;display:inline-block}
.action-dd__menu{position:absolute;top:36px;right:0;min-width:200px;z-index:10000;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.08);padding:6px;display:none}
.action-dd.open .action-dd__menu{display:block}
.action-dd__item{width:100%;text-align:left;background:#fff;border:0;cursor:pointer;padding:10px 12px;border-radius:10px;font-size:13px;font-weight:600;color:#374151;display:flex;align-items:center;gap:10px}
.action-dd__item:hover{background:#f3f4f6}
.action-dd__sep{height:1px;background:#eef2f7;margin:6px 4px;border-radius:1px}

/* üè∑Ô∏è Category badge */
#sidePanel .asset-category {
  font-size: 13px;
  font-weight: 500;
  background: #eff6ff;
  color: #1d4ed8;
  padding: 6px 12px;
  border-radius: 6px;
  display: inline-block;
}

/* üü° Status badge */
#sidePanel .asset-status {
  background: #fef3c7;
  color: #92400e;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  display: inline-block;
}

/* ‚ùå Reject reason block */
#sidePanel .rejection-box {
  background: #fef2f2;
  padding: 12px;
  border-radius: 6px;
  color: #991b1b;
  font-size: 13px;
  line-height: 1.5;
}

/* üîó Link box container */
#sidePanel .asset-link-box {
  background: #f1f5f9;
  border: 1px solid #e5e7eb;
  padding: 10px 12px;
  border-radius: 6px;
  font-size: 13px;
  margin-bottom: 18px;
  position: relative;
  word-break: break-all;
}

/* üìã Copy button */
#sidePanel .copy-btn-small {
  position: absolute;
  right: 10px;
  top: 8px;
  font-size: 14px;
  background: none;
  border: none;
  cursor: pointer;
  color: #6b7280;
}
#sidePanel .copy-btn-small:hover {
  color: #1f2937;
}

/* ‚öôÔ∏è Admin action button */
#sidePanel .open-action-modal {
  width: 100%;
  font-size: 14px;
  font-weight: 600;
  background: #4f46e5;
  color: white;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 20px;
  transition: 0.2s;
}
#sidePanel .open-action-modal:hover {
  background: #4338ca;
}
.release-album {
  font-size: 13px;
  color: #334155;
  font-weight: 500;
}

  
/* === Borders for Pending Rights table === */
.rights-table{
  width:100%;
  table-layout:fixed;
  border-collapse: separate !important; /* allow radius */
  border-spacing: 0;                    /* no gaps */
  border: 1px solid rgb(237, 238, 245);           /* outer border */
  border-radius: 12px;                   /* rounded corners */
  overflow: hidden;                      /* clip corners */
}

/* header row */
.rights-table thead th{
  background:#f8fafc;
  border-bottom:1px solid #e5e7eb;
  font-weight:600;
}

/* hover state ‚Äì keep soft even when row has bg */
.rights-table tbody tr:hover{
  background:#ffdddd !important;
}




  

  
</style>





<div class="wrapper">
  <div class="section-card">
    <div class="card-inner">
    <div class="section-header" style="justify-content: space-between;">
  <div style="display: flex; align-items: center;">
    <div class="avatar">RM</div>
    <div class="info">
      <h2>Rights Manager</h2>
      <p>Submit or manage your ticket requests</p>
    </div>
  </div>
  <div>
    <?php if ($_SESSION['user_id'] == 0 || $_SESSION['STAFFUSER'] == '1'): ?>
  <!-- Admin View -->
  <a href="/support/rights-wizard" style="text-decoration: none;">
    <button style="padding: 11px 20px; background: linear-gradient(to right, #7d2491, #0082ff); color: white; font-weight: 500; border: none; border-radius: 8px; cursor: pointer;">
      Send Notice
    </button>
  </a>
<?php else: ?>
  <!-- User View -->
  <a href="/support/rights-wizard" style="text-decoration: none;">
    <button style="padding: 11px 20px; background: linear-gradient(to right, #7d2491, #0082ff); color: white; font-weight: 500; border: none;  border-radius: 8px; cursor: pointer;">
      Send Request Form
    </button>
  </a>
<?php endif; ?>

  </div>
</div>

    
 <div style="background: #fff; border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,0.03);">
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px;">
          <div class="hover-box" style="background: #e1f0ff; padding: 16px 18px; border-radius: 10px;">üéØ <strong>Release Claim</strong><br><small>Release copyrigh Claim From Videos?</small></div>
          <div class="hover-box" style="background: #e1f0ff; padding: 16px 18px; border-radius: 10px;">üö´ <strong>TakeDown Video</strong><br><small>Remove unauthorized Video content.</small></div>
          <div class="hover-box" style="background: #e1f0ff; padding: 16px 18px; border-radius: 10px;">üéµ <strong>Monetize Video</strong><br><small>You can manually claim any video using your music.?</small></div>
           <div class="hover-box" style="background: #e1f0ff; padding: 16px 18px; border-radius: 10px;">¬©Ô∏è <strong>Copyright Infringement</strong><br><small>You‚Äôve received a copyright claim. View and manage it here.</small></div>

        </div>
      </div><br>
      
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="overview">Overview</button>
    </div>

    <!-- OVERVIEW TAB -->
    <div class="tab-content active" id="overview">
     

      <!-- üîΩ Rights Manager Below Overview -->
      <div style="background: #fff; border-radius: 16px;  margin-top: 40px;">
        <div class="rights-subtabs" style="display: flex; gap: 20px; margin-bottom: 0px;">
          <button class="rights-subtab-btn rights-active" data-subtab="rights-overview">Analytics</button>
          <button class="rights-subtab-btn" data-subtab="rights-pending">Pending rights issues</button>
        </div>

<div class="rights-subtab-content active" id="rights-overview">
  <p style="text-align:right; font-size: 13px; color: #6b7280;">
  Showing issues from past <?= $selectedRange ?> days
</p>
<?php $selectedRange = $this->DATE_RANGE ?? 90; ?>
  <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 10px;">
  <button class="range-btn" data-range="90">90D</button>
  <button class="range-btn" data-range="180">180D</button>
  <button class="range-btn" data-range="365">365D</button>
</div>

  <h3 style="font-size: 21px; font-weight: 700; 16px;">üéØ Analytics of Rights Issues</h3><br>
  <div style="margin-bottom: 20px;">
    <?php
    $types = [
  '<strong>Takedown Video</strong>' => 'takedown',
  '<strong>Claim UGC Video</strong>' => 'ugc',
  '<strong>Release Claim</strong>' => 'release',
  '<strong>Copyright Infringement</strong>' => 'infringement'
];

$colors = [
  'takedown' => '#0ea5e9',
  'ugc' => '#1d4ed8',
  'release' => '#facc15',
  'infringement' => '#ef4444' // üî¥ red for copyright
];

foreach ($types as $label => $key):
  $count = $this->RIGHTS_COUNTS[$key] ?? 0;
  $px = min(500, $count * 20); // bar width logic
?>
  <div style="margin-bottom: 12px; font-size: 15px; color: #374151;">
    <?= $label ?> &nbsp;(<strong><?= $count ?></strong>)
    <div class="bar-fill" data-width="<?= $px ?>px" style="background: <?= $colors[$key] ?>;"></div>
  </div>
<?php endforeach; ?>
    <br>
 
    

     
<?php
  $isAdmin = ($_SESSION['user_id'] == 0 || $_SESSION['STAFFUSER'] == 1);
?>

<?php if (!$isAdmin): ?>
  
     <div class="tab-nav">
      <button class="tab-btn active" data-tab="overview">Rights History</button>
    </div> 
  <h3 style="font-size: 21px; font-weight: 700; margin-bottom: 16px;">üéØ Last Resolved Rights Issues</h3><br>
   

  <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">

  <select id="issueFilter" style="
    padding: 10px 14px;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    color: #374151;
    background: #fff url('data:image/svg+xml;utf8,<svg fill=\'gray\' height=\'18\' viewBox=\'0 0 24 24\' width=\'18\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M7 10l5 5 5-5z\'/></svg>') no-repeat right 12px center;
    background-size: 14px;
    appearance: none;
    min-width: 220px;
    transition: all 0.2s ease;
  " 
  onfocus="this.style.border='1px solid #6366f1'; this.style.boxShadow='0 0 0 2px rgba(99,102,241,0.15)'"
  onblur="this.style.border='1px solid #d1d5db'; this.style.boxShadow='none'">
    <option value="">All Issues</option>
    <option value="release">Release Claim</option>
    <option value="takedown">Takedown Video</option>
    <option value="monetize">Claim UGC Video</option>
    <option value="infringement">Copyright Infringement</option>
    <option value="ownership">Ownership Conflict</option>
  </select>

  <select id="statusFilter" style="
    padding: 10px 14px;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    color: #374151;
    background: #fff url('data:image/svg+xml;utf8,<svg fill=\'gray\' height=\'18\' viewBox=\'0 0 24 24\' width=\'18\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M7 10l5 5 5-5z\'/></svg>') no-repeat right 12px center;
    background-size: 14px;
    appearance: none;
    min-width: 180px;
    transition: all 0.2s ease;
  "
  onfocus="this.style.border='1px solid #6366f1'; this.style.boxShadow='0 0 0 2px rgba(99,102,241,0.15)'"
  onblur="this.style.border='1px solid #d1d5db'; this.style.boxShadow='none'">
    <option value="">All Status</option>
    <option value="approved">Approved</option>
    <option value="confirmed">Confirmed</option>
    <option value="resolved">Resolved</option>
    <option value="rejected">Rejected</option>
    <option value="takedown">Takedown</option>
  </select>

</div>

<style>
/* ‚Äî‚Äî tokens ‚Äî‚Äî */
:root{
  --b-text:#1c2430; --b-muted:#6b7280; --b-border:#e7eaf2;
  --b-chip:#ffffff; --b-bg:#fff; --b-shadow:0 8px 24px rgba(16,24,40,.06);
  --b-radius:12px; --b-blue:#2563eb; --b-pill:#f3f4f6; --b-pill-active:#eef2ff; --b-outline:#d9dfff;
}
.plaB-wrapper{max-width:1300px;margin:2px auto;color:var(--b-text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}

/* top */
.plaB-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.plaB-top h1{margin:0;font-weight:800;font-size:28px;letter-spacing:-.02em;}

/* segmented range */
.plaB-range{display:inline-grid;grid-auto-flow:column;gap:6px;background:#fff;border:1px solid var(--b-border);border-radius:999px;padding:4px 6px;box-shadow:0 1px 2px rgba(16,24,40,.04);}
.plaB-range input{display:none;}
.plaB-range label{min-width:52px;text-align:center;font-weight:700;font-size:12px;color:#334155;padding:8px 12px;border-radius:999px;cursor:pointer;}
.plaB-range input:checked+label{background:#4f46e5;color:#fff;box-shadow:0 2px 6px rgba(79,70,229,.25);}

/* platform bar */
.plaB-platforms{display:flex;gap:10px;align-items:center;margin:14px 0 18px;}
.plaB-platforms--bar{
  /* existing */
  background:#F4F6FF;
  
  border-radius:9999px;
  padding:5px 10px;
  gap:5px;
  box-shadow: inset 0 -1px 0 rgba(16,24,40,.02);
  /* NEW: width control */
  width: var(--pla-bar-width, max-content); /* default = content width */
  max-width: 100%;
}
.plaB-platforms input{display:none;}
.plaB-platforms .pill{display:inline-flex;gap:8px;align-items:center;padding:5px 12px;border-radius:9999px;background:transparent;border:0;font-weight:800;font-size:13px;color:#3c3b3b;letter-spacing:.02em;}
.plaB-platforms svg{width:18px;height:18px;display:block;}
.plaB-platforms input:checked+label.pill{background:#fff;box-shadow:0 1px 2px rgba(16,24,40,.06);}

/* empty state */
.plaB-empty{border-radius:16px;background:#d7e2f914; height:450px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;margin-bottom:70px;}
.plaB-empty .illu-img{width:120px;height:auto;opacity:.95;margin-bottom:8px;}
.plaB-empty h3{margin:0px 0 6px;font-size:20px;font-weight:800;}
.plaB-empty p{margin:0;color:var(--b-muted);}

/* cards */
.plaB-cards{display:grid;gap:20px;grid-template-columns:repeat(3,1fr);margin-bottom:12px;}
.card{background:var(--b-bg);border:1px solid var(--b-border);border-radius:14px;box-shadow:var(--b-shadow);overflow:hidden;}
.card img{display:block;width:100%;height:140px;object-fit:cover;}
.card .meta{padding:10px 14px 4px;color:#4b5563;font-weight:600;font-size:13px;}
.card .link{display:block;padding:0 14px 12px;font-weight:700;font-size:13px;color:var(--b-blue);text-decoration:none;}
.card .link:hover{text-decoration:underline;}
.card .chips{display:flex;gap:8px;flex-wrap:wrap;padding:0 14px 14px;}
.card .chip{background:#fff;border:1px solid var(--b-border);border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;color:#475467;box-shadow:var(--b-shadow);}

/* responsive */
@media (max-width:1024px){.plaB-cards{grid-template-columns:repeat(2,1fr);} }
@media (max-width:640px){
  .plaB-top{flex-direction:column;gap:10px;align-items:flex-start;}
  .plaB-cards{grid-template-columns:1fr;}
}
</style>
  <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>

  <?php if (empty($RESOLVED_ISSUES)): ?>
    <div class="plaB-empty">
  <!-- Lottie Animation -->
  <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
  <dotlottie-wc 
    src="https://lottie.host/3d7c4d75-1a05-4934-8ccb-8427acd4b50a/0we5XTd6ZY.lottie" 
    style="width: 300px; height: 300px;" 
    speed="1" 
    autoplay 
    loop>
  </dotlottie-wc>
      

 <h3>No Resolved Rights Issues</h3>
  <p>Once your rights issues are closed or resolved,
  they will appear here in your history.</p>
</div>


  <?php endif; ?>

  <div id="issueCardsWrapper" >
    
    <?php
    $typeMap = [
      'release' => 'Release Claim',
      'infringement' => 'Copyright Infringement',
      'takedown' => 'Takedown Video',
      'monetize' => 'Claim UGC Video',
      'ownership' => 'Ownership Conflict'
    ];
    ?>
    <?php foreach ($RESOLVED_ISSUES as $item): ?>
      <?php
        $status = strtolower(trim($item['status']));
$issueType = strtolower(trim($item['request_type']));

// ‚úÖ Convert approved/confirmed to 'resolved' for display
$displayStatus = in_array($status, ['approved', 'confirmed']) ? 'resolved' : $status;

$color = match ($displayStatus) {
  'resolved' => '#10b981',
  'rejected', 'takedown' => '#ef4444',
  'pending', 'in progress' => '#f97316',
  default => '#6b7280'
};

$label = $typeMap[$issueType] ?? ucwords($issueType);

      ?>
      <div class="issueCard"
           data-issue="<?= $issueType ?>"
           data-status="<?= $status ?>"
           style="flex: 1 1 calc(50% - 20px); background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); display: flex; gap: 14px; padding: 16px 20px; align-items: center;">

        <img src="<?= !empty($item['release_image']) ? $item['release_image'] : '/public/img/placeholder.png' ?>"
             style="width: 48px; height: 48px; object-fit: cover; border-radius: 8px;" />

        <div style="flex: 1;">
          <div style="font-weight: 600;"><?= htmlspecialchars($item['release_title'] ?: '-') ?></div>
          <div style="font-size: 13px; color: #6b7280;">
            <?= htmlspecialchars($item['release_artist'] ?: '-') ?>
          </div>
          <div style="font-size: 13px; margin-top: 6px;">
            <span>UPC: <?= htmlspecialchars($item['release_upc']) ?></span> ‚Ä¢ 
            <span>Closing date: <?= !empty($item['closed_at']) ? date('M d, Y', strtotime($item['closed_at'])) : '-' ?></span>
          </div>
          
          <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
            <?= $label ?>
          </div>
        </div>

        <div style="padding-left: 10px;">
          <div style="background: <?= $color ?>20; color: <?= $color ?>; font-size: 12px; padding: 4px 10px; border-radius: 8px; font-weight: 600; white-space: nowrap;">
            <?= ucwords($displayStatus) ?>

          </div>
        </div>
        
      </div>
    <?php endforeach; ?>
  </div>
<?php endif; ?>

  <!-- ‚úÖ Footer -->
<div style="
  margin-top: 80px;
  padding: 30px 40px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  color: #6b7280;
  text-align: center;
">
  <div style="margin-bottom: 10px;">
    Need help? <a href="https://www.primebackstage.in/tickets" style="color: #3b82f6; text-decoration: none; font-weight: 500;">Contact Support</a> or visit our <a href="https://www.primebackstage.in/faq" style="color: #3b82f6; text-decoration: none; font-weight: 500;">FAQ</a>.
  </div>
  <div style="font-size: 13px; color: #9ca3af;">
    &copy; <?php echo date('Y'); ?> Prime Digital Arena. All rights reserved.
  </div>
</div>
  </div>
</div>

<div class="rights-subtab-content" id="rights-pending">
  <h3>Pending Rights Requests</h3>
  <div style="margin-bottom: 20px;">
    <a href="/support/rights-wizard" style="text-decoration: none;">
    </a>
  </div>
 
  <table class="rights-table <?php if ($_SESSION['user_id'] == '0' || $_SESSION['STAFFUSER'] == '1') echo 'admin-rights-table'; ?>" style="border-collapse: collapse;">

    <thead>
      <tr style="background: #f3f4f6;">
        <th style="text-align: left; padding: 12px;">Store</th>
        <th>Category</th>
        <th>Asset Title</th>
        <th>Album Track Title</th>
        <?php if ($_SESSION['user_id'] == 0 || $_SESSION['STAFFUSER'] == '1'): ?>
  <th>Asset Info</th>
<?php endif; ?>

        <th>Artist</th>
        <th>UPC</th>
        <th>Label/Artist</th>
        <th>Status</th>
        <?php if ($_SESSION['user_id'] == 0 || $_SESSION['STAFFUSER'] == '1'): ?>
    <th>YTAF</th>
    <th>Action</th>
<?php endif; ?>
      </tr>
    </thead>
   
           <!-- üîß Action Modal -->
<div id="actionModal" class="action-modal">
  <div id="actionModalContent" style="background:#fff; padding:28px 30px; border-radius:6px; width:320px; position:relative; box-shadow:0 15px 40px rgba(0,0,0,0.2);">
    <h3 style="margin:0 0 18px; font-size:20px; font-weight:600;">Manage Request</h3>

    <input type="hidden" id="modalRequestId">

    <label>Status:</label>
    <select id="modalStatus" style="width:100%; margin:8px 0 16px; padding:10px; border-radius:6px; border:1px solid #ccc;">
      <option value="pending">In Review</option>
      <option value="confirmed">Approved</option>
      <option value="rejected">Rejected</option>
    </select>
<select id="predefinedReasons" style="display:none; width:100%; margin-bottom:10px; padding:10px; border-radius:6px; border:1px solid #ccc;">
  <option value="">‚¨á Select a reason...</option>
  <option value="This request doesn't match our rights ownership records.">Ownership does not match</option>
  <option value="The video does not include your claimed content.">Video doesn't contain claimed content</option>
  <option value="We only accept requests for YouTube videos, not for Topic Channel videos. Send copyright notice.">We only accept requests for YouTube videos.</option>
  <option value="Insufficient metadata provided to verify claim.">Insufficient metadata</option>
  <option value="YouTube link appears to be unavailable or invalid.">Invalid YouTube link</option>
  <option value="Claim request type was incorrectly selected.">Wrong claim type</option>
  <option value="Rights ownership information is missing or incomplete.">Missing ownership info</option>
  <option value="Repeated submission with no new justification.">Repeated request</option>
  <option value="Request refers to content we do not represent.">We don't represent this content</option>
  <option value="Misuse of Rights Manager for unrelated content.">Misuse of system</option>
  <option value="Duplicate request already processed earlier.">Already processed</option>
  <option value="Please contact your Label Manager directly regarding this matter.
the request may involve legal or other associated issues with this track.">request cannot be processed - LM.</option>
</select>
   <!-- REMOVE this block -->
<textarea id="modalReason" placeholder="Enter reject reason" ... ></textarea>

    <div style="display:flex; justify-content:space-between;">
      <button id="modalUpdateBtn" style="background:#10b981; color:#fff; padding:10px 16px; border:none; border-radius:6px;">‚úÖ Save</button>
      <button id="modalDeleteBtn" style="background:#ef4444; color:#fff; padding:10px 16px; border:none; border-radius:6px;">üóëÔ∏è Delete</button>
    </div>

    <button id="modalCloseBtn" style="position:absolute; top:10px; right:14px; background:none; border:none; font-size:22px;">√ó</button>
  </div>
</div>
    <tbody>
     <?php if (!empty($r['album'])): ?>
  <div class="meta-row">
    <strong>Album:</strong> <?= htmlspecialchars($r['album']) ?>
  </div>
<?php endif; ?>

<?php
$hasData = false;
foreach ($this->RIGHTS_LIST as $row):
    $status = strtolower($row['status']);
    if ($status === 'confirmed') continue; // Hide confirmed
    $hasData = true;
    $color = $status === 'rejected' ? '#fee2e2' : '#fef2f2';
?>
      <?php
$typesMap = [
  'release' => 'Release Claim',
  'takedown' => 'Takedown Video',
  'monetize' => 'Claim UGC Video',
  'infringement' => 'Copyright Infringement'
];

$requestTypeKey = strtolower(trim($row['request_type']));
$requestTypeLabel = $typesMap[$requestTypeKey] ?? ucfirst($requestTypeKey);
?>
<?php
  $isAdmin  = ($_SESSION['user_id'] == 0 || $_SESSION['STAFFUSER'] == '1');
  $isFlagged = (strtolower((string)$row['flag_status']) === 'flagged');
?>
<tr class="open-right-panel <?= $isFlagged ? 'is-locked' : '' ?>"
  data-id="<?= $row['id'] ?>"
  data-locked="<?= $isFlagged ? '1' : '0' ?>"
  data-title="<?= htmlspecialchars($row['release_title']) ?>"
  data-artist="<?= htmlspecialchars($row['release_artist']) ?>"
  data-upc="<?= $row['release_upc'] ?>"
  data-isrc="<?= $row['isrc_code'] ?>"
  data-album="<?= htmlspecialchars($row['album'] ?? '') ?>"
  data-category="<?= $requestTypeLabel ?>"
  data-status="<?= $status ?>"
  data-reason="<?= htmlspecialchars($row['reject_reason'], ENT_QUOTES, 'UTF-8') ?>"
  data-links="<?= htmlspecialchars($row['youtube_links']) ?>"
  style="background: <?= $color ?>; cursor: pointer;">


  <td style="padding: 12px;">
    <?php if (strtolower($row['platform']) == 'youtube'): ?>
      <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/YouTube_Logo_2017.svg" style="height: 16px;">
    <?php elseif (strtolower($row['platform']) == 'facebook'): ?>
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Facebook_logo_%282023%29.svg/2560px-Facebook_logo_%282023%29.svg.png" style="height: 15px;">
    <?php elseif (strtolower($row['platform']) == 'email'): ?>
      <img src="https://upload.wikimedia.org/wikipedia/commons/4/4e/Mail_%28iOS%29.svg" style="height: 16px;">
    <?php elseif (strtolower($row['platform']) == 'spotify'): ?>
      <img src="https://1000logos.net/wp-content/uploads/2017/11/Spotify-Logo.png" style="height: 40px;">
    <?php else: ?>
      <?= ucfirst($row['platform']) ?>
    <?php endif; ?>
  </td>
  
  <td><?= $requestTypeLabel ?></td>

  <td><?= !empty($row['album']) ? htmlspecialchars($row['album']) : '-' ?></td>
  <td><?= $row['release_title'] ?></td>
  
<?php if ($_SESSION['user_id'] == 0 || $_SESSION['STAFFUSER'] == '1'): ?>
  <td style="padding: 12px; text-align: left;">
    <button class="open-links"
            data-links="<?= htmlspecialchars($row['youtube_links']) ?>"
            style="background: none; border: none; cursor: pointer; padding: 0; margin: 0; font-size: 14px; color: #4f46e5; text-decoration: underline; text-align: left;">
      Open
    </button>
  </td>
  <?php endif; ?>
  <td class="limit-text" title="<?= htmlspecialchars($row['release_artist']) ?>">
    <?= $row['release_artist'] ?>
  </td>

  <td><?= $row['release_upc'] ?></td>
  <td><?= !empty($row['staff_name']) ? $row['staff_name'] : 'N/A' ?></td>
  <td>
    <?php if ($_SESSION['user_id'] == '0' || $_SESSION['STAFFUSER'] == '1'): ?>
      <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
        <span style="color:#4b5563; font-size:12px;"><strong><?= ucfirst($status) ?> </strong></span>
        <td><span style="color:#6366f1; font-size:12px;"><strong><?= $row['yt_ugc_status'] ?? 'N/A' ?></strong></span><td>
        <!-- ‚ñº REPLACE THIS WHOLE BUTTON GROUP WITH: -->
<div class="action-dd" data-id="<?= (int)$row['id'] ?>">
  <button type="button" class="action-dd__btn action-dd__toggle" aria-haspopup="true" aria-expanded="false" title="Actions">
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
  </button>

  <div class="action-dd__menu">
    <!-- Manage (‚öôÔ∏è) -->
    <button
      class="action-dd__item open-action-modal"
      data-id="<?= (int)$row['id'] ?>"
      data-status="<?= $status ?>"
      data-reason="<?= htmlspecialchars($row['reject_reason'], ENT_QUOTES, 'UTF-8') ?>">
      ‚öôÔ∏è <span>Manage request</span>
    </button>

    <!-- Flag/Unflag (üü°/‚õî) -->
    <?php if ($_SESSION['user_id'] == 0 || $_SESSION['STAFFUSER'] == '1'): ?>
      <button
        class="action-dd__item flag-entry-btn"
        data-id="<?= (int)$row['id'] ?>"
        title="<?= $row['flag_status'] === 'flagged' ? 'Flagged for Review' : 'Mark as Flagged' ?>">
        <?= $row['flag_status'] === 'flagged' ? '‚õî' : 'üü°' ?>
        <span><?= $row['flag_status'] === 'flagged' ? 'Unflag entry' : 'Flag entry' ?></span>
      </button>
    <?php endif; ?>

    <div class="action-dd__sep"></div>

    <!-- Mark In Process (üîÑ) -->
    <?php if ($_SESSION['user_id'] == 0 || $_SESSION['STAFFUSER'] == '1'): ?>
      <button
        class="action-dd__item mark-in-process"
        data-id="<?= (int)$row['id'] ?>">
        üîÑ <span>Mark In Process</span>
      </button>
    <?php endif; ?>
    
  </div>
  <?php if ($isFlagged): ?>
  <span class="lock-pill" title="Locked by Admin">üîí Unverified</span>
<?php endif; ?>
</div>
<!-- ‚ñ≤ END -->


    <?php else: ?>
      <?php if ($status === 'rejected' && !empty($row['reject_reason'])): ?>
        <div class="custom-tooltip-trigger" 
             data-tooltip="<?= htmlspecialchars($row['reject_reason'], ENT_QUOTES, 'UTF-8') ?>" 
             style="color:#dc2626; font-size: 12px; position: relative; cursor: pointer;">
          Status: <strong><?= ucfirst($status) ?>&nbspüì©</strong>
        </div>
      <?php else: ?>
        <div style="color:#4b5563; font-size:12px;">
          Status: <strong><?= ucfirst($status) ?></strong>
        </div>
      <?php endif; ?>
    <?php endif; ?>
  </td>
</tr>
<?php endforeach; ?>

<?php
  // Count columns dynamically for colspan
  $colspan = ($_SESSION['user_id'] == '0' || $_SESSION['STAFFUSER'] == '1') ? 11 : 8;
?>

<?php if (!$hasData): ?>
<tr>
  <td colspan="<?= $colspan ?>" style="text-align: center; padding: 100px; color: #6b7280; font-size: 16px;">
    <div style="display: inline-block; text-align: center;">
              
      <div style="font-size: 50px; margin-bottom: 10px;">üì≠</div>
      <div>There are no rights requests to display</div>
    </div>
  </td>
</tr>

<?php endif; ?>

      
<div id="sidePanel">  <div style="padding: 1px 1px 10px 1px; border-bottom: 1px solid #eeeeeead; display: flex; justify-content: space-between; align-items: center;">
    <h3 style="margin: 1; font-size: 20px; font-weight: 600;">üîè Asset Details</h3>
    <button onclick="closeRightPanel()" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úñ</button>
  </div>
  <div id="sidePanelContent" style="padding: 0px; font-size: 14px; color: #374151;">
    Loading...
  </div>
</div>

      </tbody>
    </table>
  <?php if ($isAdmin): ?>
  <div style="margin-top:40px;"></div>
  <h3 style="font-size:21px; font-weight:700; margin: 24px 0 14px;">In Process Requests</h3>

  <?php if (empty($this->IN_PROCESS_LIST)): ?>
    <div class="empty-state" style="padding:14px 16px; border:1px solid #e5e7eb; border-radius:10px; background:#fff;">
      <div style="font-size:14px; color:#6b7280;">No items are currently marked as <strong>In Process</strong>.</div>
    </div>
  <?php else: ?>
    <div class="table-responsive">
      <table class="rights-table admin-rights-table inprocess-table" style="width:100%; background:#fff;">
        <thead>
          <tr>
            <th>Cover</th><th>Asset Title</th><th>Album Title</th><th>Artist</th>
            <th>UPC</th><th>Category</th><th>Created</th><th>Status</th><th>Action</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($this->IN_PROCESS_LIST as $r): ?>
          <?php
$typesMap = [
  'release'      => 'Release Claim',
  'takedown'     => 'Takedown Video',
  'monetize'     => 'Claim UGC Video',
  'infringement' => 'Copyright Infringement',
];
?>

           <?php
    $requestTypeKey   = strtolower(trim($r['request_type'] ?? ''));
    $requestTypeLabel = $typesMap[$requestTypeKey] ?? ucfirst($requestTypeKey ?: '‚Äî');
  ?>
            <tr data-id="<?= (int)$r['id'] ?>">
              
              <td>
                <?php if (!empty($r['release_image'])): ?>
                  <img src="<?= htmlspecialchars($r['release_image']) ?>" style="width:42px;height:42px;object-fit:cover;border-radius:6px;">
                <?php else: ?>
                  <div style="width:42px;height:42px;border-radius:6px;background:#f3f4f6;"></div>
                <?php endif; ?>
              </td>
              <td style="max-width:280px;">
                <div style="font-weight:600;"><?= htmlspecialchars($r['release_title'] ?: '‚Äî') ?></div>
                <div style="font-size:12px;color:#6b7280;">by <?= htmlspecialchars($r['user_name'] ?: '‚Äî') ?></div>
              </td>
               <td><?= htmlspecialchars($r['album'] ?? ($r['release_title'] ?? '‚Äî')) ?></td>
              <td><?= htmlspecialchars($r['release_artist'] ?: '‚Äî') ?></td>
              <td><?= htmlspecialchars($r['release_upc'] ?: '‚Äî') ?></td>
              <td><?= htmlspecialchars($requestTypeLabel) ?></td>
              <td><?= htmlspecialchars($r['created_at'] ?: '‚Äî') ?></td>
              <td><span class="badge" style="background:#fde68a;color:#92400e;padding:4px 8px;border-radius:9999px;">In&nbsp;Process</span></td>
              <td>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn small back-to-pending" data-id="<?= (int)$r['id'] ?>">Back&nbsp;to&nbsp;Pending</button>
                  <button class="btn small mark-resolved" data-id="<?= (int)$r['id'] ?>">Resolve</button>
                </div>
              </td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
    </div>
  <?php endif; ?>
<?php endif; ?>

  <br>
  <select id="rightsPerPage"
        style="
          padding: 10px 14px;
          border: 1px solid #d1d5db;
          border-radius: 10px;
          font-size: 13px;
          font-weight: 500;
          color: #374151;
          background: #fff url('data:image/svg+xml;utf8,<svg fill=\'gray\' height=\'18\' viewBox=\'0 0 24 24\' width=\'18\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M7 10l5 5 5-5z\'/></svg>') no-repeat right 12px center;
          background-size: 14px;
          appearance: none;
          min-width: 140px;
          transition: all 0.2s ease;
          margin-bottom: 16px;
        "
        onfocus="this.style.border='1px solid #6366f1'; this.style.boxShadow='0 0 0 2px rgba(99,102,241,0.15)'"
        onblur="this.style.border='1px solid #d1d5db'; this.style.boxShadow='none'">
  <option value="10" <?= $this->PER_PAGE == 10 ? 'selected' : '' ?>>10 per page</option>
  <option value="15" <?= $this->PER_PAGE == 15 ? 'selected' : '' ?>>15 per page</option>
  <option value="20" <?= $this->PER_PAGE == 20 ? 'selected' : '' ?>>20 per page</option>
</select>

   <?php if (!empty($this->RIGHTS_LIST) && $this->TOTAL_PAGES > 1): ?>
  <div style="margin-top: 24px; display: flex; gap: 6px; flex-wrap: wrap;">
    <?php for ($i = 1; $i <= $this->TOTAL_PAGES; $i++): ?>
      <a href="?page=<?= $i ?>&per_page=<?= $this->PER_PAGE ?>#rights"
         style="
           padding: 6px 14px;
           border-radius: 8px;
           font-size: 14px;
           font-weight: 500;
           border: 1px solid <?= ($this->CURRENT_PAGE == $i) ? '#000' : '#d1d5db' ?>;
           background: <?= ($this->CURRENT_PAGE == $i) ? '#000' : '#f3f4f6' ?>;
           color: <?= ($this->CURRENT_PAGE == $i) ? '#fff' : '#111827' ?>;
           text-decoration: none;
         ">
        <?= $i ?>
      </a>
    <?php endfor; ?>
  </div>
<?php endif; ?>
<div id="toast" style="position: fixed; bottom: 30px; right: 30px; background: #19211b; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); font-size: 14px; font-weight: 500; display: none; z-index: 99999;">
  Deleted successfully!
</div>


<!-- üîó Enhanced Best-Looking Modal to show asset links -->
<div id="linkModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.6); z-index: 1000; display: flex; align-items: center; justify-content: center;">
  <div id="linkModalContent" style="background: #ffffff; padding: 25px 30px; border-radius: 5px; max-width: 550px; width: 90%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; transform: scale(1); opacity: 1;">
    
    
    <!-- Modal Title (Enhanced) -->
    <h3 style="margin: 0; font-size: 22px; font-weight: 600; color: #111827; text-align: center;">Asset Info</h3>
    
    <!-- Links Container (Styled) -->
    <div id="modalLinks" style="margin-top: 20px; max-height: 300px; overflow-y: auto; padding: 10px 0; font-size: 15px; color: #374151; border-top: 1px solid #E5E7EB;">
      <p style="text-align: center; color: #9CA3AF;">No info available.</p>
    </div>
  </div>
</div>
    
<script>
  const issueFilter = document.getElementById('issueFilter');
  const statusFilter = document.getElementById('statusFilter');

  function applyFilter() {
    const selectedIssue = issueFilter.value;
    const selectedStatus = statusFilter.value;

    let hasVisible = false;

    document.querySelectorAll('.issueCard').forEach(card => {
      const cardIssue = card.getAttribute('data-issue');
      const cardStatus = card.getAttribute('data-status');

      const matchesIssue = !selectedIssue || cardIssue === selectedIssue;
      const matchesStatus = !selectedStatus || cardStatus === selectedStatus;

      const show = matchesIssue && matchesStatus;
      card.style.display = show ? 'flex' : 'none';
      if (show) hasVisible = true;
    });

    const noResultsWrapper = document.getElementById('noFilteredResults');
    if (!hasVisible) {
      if (noResultsWrapper) {
        noResultsWrapper.style.display = 'flex';
      } else {
        const newDiv = document.createElement('div');
        newDiv.id = 'noFilteredResults';
        newDiv.style.cssText = "display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; width: 100%;";
        newDiv.innerHTML = `
          <dotlottie-wc
            src="https://lottie.host/3614e953-f72e-4b9e-9cc1-4a299b684fac/ti78GpRyMq.lottie"
            style="width: 200px; height: 200px; margin-bottom: 20px;"
            speed="1" autoplay loop>
          </dotlottie-wc>
          <h4 style="color: #6b7280; font-weight: 500; text-align: center;">No rights issues match your filter.</h4>
        `;
        document.getElementById('issueCardsWrapper').after(newDiv);
      }
    } else {
      if (noResultsWrapper) {
        noResultsWrapper.style.display = 'none';
      }
    }
  }

  issueFilter.addEventListener('change', applyFilter);
  statusFilter.addEventListener('change', applyFilter);
</script>

<script>
function openRightPanel(html, id = null){
  document.getElementById('sidePanelContent').innerHTML = html || 'Loading...';
  const panel = document.getElementById('sidePanel');
  panel.classList.add('open');
  $('#sidePanel').data('id', id || null);
}
function closeRightPanel(){
  document.getElementById('sidePanel').classList.remove('open');
}
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('sidePanel')?.classList.remove('open');
});
$(document).on('keydown', e => { if (e.key === 'Escape') closeRightPanel(); });

// ===== Admin flag =====
const IS_ADMIN = <?php echo (($_SESSION['user_id'] == 0) || ($_SESSION['STAFFUSER'] == '1')) ? 'true' : 'false'; ?>;

// ===== Action dropdown (bubbling only) =====
(function(){
  function closeAll(except){
    document.querySelectorAll('.action-dd.open').forEach(dd=>{
      if(dd!==except) dd.classList.remove('open');
      dd.querySelector('.action-dd__toggle')?.setAttribute('aria-expanded','false');
    });
  }

  // Toggle open/close
  document.addEventListener('click', function(e){
    const root   = e.target.closest('.action-dd');
    const toggle = e.target.closest('.action-dd__toggle');

    if (toggle && root){
      e.preventDefault();
      e.stopPropagation();                     // don't reach row click
      const open = root.classList.contains('open');
      closeAll();
      if(!open){ root.classList.add('open'); toggle.setAttribute('aria-expanded','true'); }
      return;
    }

    // Click on any menu item: perform action + close (and don't reach row)
    if (e.target.closest('.action-dd__item')){
      e.preventDefault();
      e.stopPropagation();                     // don't reach row click
      const r = e.target.closest('.action-dd');
      r?.classList.remove('open');
      r?.querySelector('.action-dd__toggle')?.setAttribute('aria-expanded','false');
      // actual handlers (open-action-modal / flag-entry-btn / mark-in-process) will run separately
      return;
    }

    // Click outside ‚Üí close menus
    if (!root) closeAll();
  });

  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAll(); });
})();

// ===== Row click ‚Üí open side panel (safe guards inside) =====
$(document).on('click', 'tr.open-right-panel', function(e){
  // If click came from dropdown/menu/toggle/items or action buttons ‚Üí ignore
  if ($(e.target).closest('.action-dd, .action-dd__toggle, .action-dd__menu, .action-dd__item').length) return;
  if ($(e.target).closest('.open-action-modal, .open-links, .mark-in-process, .back-to-pending, .mark-resolved, .flag-entry-btn').length) return;

  // Non-admin lock guard
  const $tr = $(this);
  const isLocked = String($tr.attr('data-locked')) === '1';
  if (!IS_ADMIN && isLocked){
    if (typeof showLockToast === 'function') showLockToast('Action locked until Admin unflags.');
    return;
  }

  // Collect data
  const id        = $tr.data('id');
  const assetTitle= $tr.data('title')  || '‚Äî';
  const artist    = $tr.data('artist') || '‚Äî';
  const upc       = $tr.data('upc')    || '‚Äî';
  const isrc      = $tr.data('isrc')   || '‚Äî';
  const album     = $tr.data('album')  || '‚Äî';
  const category  = $tr.data('category') || '‚Äî';
  const status    = $tr.data('status') || '‚Äî';
  const reason    = $tr.data('reason') || '';
  const linksRaw  = ($tr.data('links') || '').toString();

  // Build links box
  let linksHtml = '';
  if (linksRaw.trim()){
    const links = linksRaw.split(/\r?\n|\|/);
    let linkItems = '';
    links.forEach(link=>{
      const clean = (link || '').trim();
      if (!clean) return;
      if (IS_ADMIN){
        linkItems += `
          <div class="link-copy-box" style="position: relative;">
            ${clean}
            <button onclick="copyToClipboard('${clean.replace(/'/g,"\\'")}', this)"
                    class="copy-btn-small" title="Copy">üìã</button>
          </div>`;
      }else{
        linkItems += `<div style="margin-bottom: 2px;"><a href="${clean}" target="_blank" style="color:#3B82F6;">${clean}</a></div>`;
      }
    });
    if (linkItems){
      linksHtml = `
        <div class="asset-link-box">
          <div style="font-weight:600; margin-bottom:10px;">Asset Summary:</div>
          ${linkItems}
        </div>`;
    }
  }

  // Admin controls
  const adminControls = IS_ADMIN ? `
    <div style="margin-top:20px;">
      <button class="open-action-modal"
              data-id="${id}"
              data-status="${status}"
              data-reason="${reason}"
              style="background:#4f46e5; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">
        ‚öôÔ∏è Manage Request
      </button>
    </div>` : '';

  // Panel HTML
  const html = `
    <br>
    <div class="asset-field">
      <small>Category :</small>
      <div class="asset-category">${category}</div>
    </div>

    <div class="asset-main-box">
      <div class="asset-field"><small>Title :</small><div class="value">${album}</div></div>
      <div class="asset-field"><small>Album :</small><div class="value">${assetTitle}</div></div>
      <div class="asset-field"><small>Artist :</small><div class="value">${artist}</div></div>
      <div class="asset-field"><small>UPC :</small><div class="value">${upc}</div></div>
      <div class="asset-field"><small>ISRC :</small><div class="value">${isrc}</div></div>
      <div class="asset-field"><small>Status :</small><div class="asset-status">${status}</div></div>
    </div>

    ${reason ? `
      <div class="asset-main-box">
        <div class="asset-field">
          <small>Reject Reason</small>
          <div class="rejection-box">${reason}</div>
        </div>
      </div>` : ''}

    ${linksHtml}
    ${adminControls}
  `;

  openRightPanel(html, id);
});




function updatePanelStatus() {
  const id = $('#sidePanel').data('id');
  const status = $('#panelStatus').val();
  let reason = '';

  if (status === 'rejected') {
    const dropdown = $('#rejectReasonDropdown').val();
    const custom = $('#customRejectReason').val();
    reason = dropdown === 'Other' ? custom : dropdown;
  }

  $.post('/support/update-status', { id, status, reject_reason: reason }, function (res) {
    if (res.status === 'success') {
      alert('Status updated!');
      location.reload();
    } else {
      alert('Failed to update status.');
    }
  }, 'json');
}

function deletePanelRequest() {
  const id = $('#sidePanel').data('id');
  if (!confirm('Are you sure you want to delete this request?')) return;

  $.post('/support/delete-request', { id }, function (res) {
    if (res.status === 'success') {
      alert('Deleted successfully!');
      location.reload();
    } else {
      alert('Failed to delete request.');
    }
  }, 'json');
}

function copyToClipboard(text, btn) {
  navigator.clipboard.writeText(text).then(() => {
    const original = btn.innerHTML;
    btn.innerHTML = "‚úÖ";
    setTimeout(() => {
      btn.innerHTML = original;
    }, 1300);
  });
}

// Toggle reject fields on status or reason dropdown
$(document).on('change', '#panelStatus', function () {
  const isRejected = $(this).val() === 'rejected';
  $('#rejectReasonBlock').toggle(isRejected);
});

$(document).on('change', '#rejectReasonDropdown', function () {
  const showCustom = $(this).val() === 'Other';
  $('#customRejectReason').toggle(showCustom);
});
</script>

    
<script>

  $(document).ready(function () {
    // ‚úÖ Handle Update
    $('.update-btn').click(function () {
      const $form = $(this).closest('form');
      const formData = $form.serialize();
      $.post('/support/update-status', formData, function (res) {
        if (res.status === 'success') {
          alert('Status updated!');
          location.reload();
        } else {
          alert('Failed to update status.');
        }
      }, 'json');
    });

    // ‚úÖ Handle Delete
    $('.delete-btn').click(function () {
      const id = $(this).data('id');
      if (!confirm('Are you sure to delete this request?')) return;

      $.post('/support/delete-request', { id: id }, function (res) {
        if (res.status === 'success') {
          alert('Request deleted!');
          location.reload();
        } else {
          alert('Failed to delete request.');
        }
      }, 'json');
    });

     // ‚úÖ Close Link Modal Function (Smooth)
  function closeLinkModal() {
    $('#linkModal').fadeOut(200);
    $('#modalLinks').html('');
  }

  $(document).ready(function () {
    // ‚úÖ Open Links Modal with Numbered URLs
    $('.open-links').off('click').on('click', function () {
      const linksRaw = $(this).data('links') || '';
      const links = linksRaw.split(/\r?\n|\|/);
      let html = '';
      const validLinks = links.filter(link => link.trim() !== '');

      if (validLinks.length === 0) {
        $('#modalLinks').html('<p style="text-align: center; color: #9CA3AF;">No links available.</p>');
        $('#linkModal').fadeIn();
        return;
      }

      validLinks.forEach((link, index) => {
        const clean = link.trim();
        const isURL = /^https?:\/\//i.test(clean);
        const label = `${index + 1}. ${clean}`;

        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #E5E7EB;">
            ${isURL 
              ? `<a href="${clean}" target="_blank" style="color:#3B82F6; font-weight: 500; text-decoration: none;">${label}</a>` 
              : `<span style="color:#374151;">${label}</span>`}
            <button onclick="copyLink('${clean}', this)" 
                    style="background: #7d2491; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: background 0.2s;">
              üìã Copy
            </button>
          </div>`;
      });

      $('#modalLinks').html(html);
      $('#linkModal').fadeIn();
    });

    // ‚úÖ Copy Link Function with Confirmation
    window.copyLink = function(link, button) {
      navigator.clipboard.writeText(link).then(() => {
        button.textContent = "‚úÖ Copied!";
        setTimeout(() => {
          button.textContent = "üìã Copy";
        }, 1500);
      });
    }

    // ‚úÖ Close Modal on Outside Click
    $(document).on('click', function (e) {
      if ($(e.target).closest('#linkModalContent').length === 0 && $(e.target).is('#linkModal')) {
        closeLinkModal();
      }
    });

    // ‚úÖ ESC key to close
    $(document).on('keydown', function (e) {
      if (e.key === 'Escape') {
        closeLinkModal();
      }
    });
  });

    // ‚úÖ Tab switcher
    $('.tab-btn').click(function () {
      const tab = $(this).data('tab');
      $('.tab-btn').removeClass('active');
      $(this).addClass('active');
      $('.tab-content').removeClass('active');
      $('#' + tab).addClass('active');
    });

    // ‚úÖ Rights sub-tab switcher
    $('.rights-subtab-btn').click(function () {
      const subtab = $(this).data('subtab');
      $('.rights-subtab-btn').removeClass('rights-active');
      $(this).addClass('rights-active');
      $('.rights-subtab-content').removeClass('active').hide();
const $newTab = $('#' + subtab);
$newTab.css('display', 'block').hide().fadeIn(200).addClass('active');


      // üßº Close any leftover modal when switching tab
      closeLinkModal();
    });



    // ‚úÖ Animate bars
    setTimeout(function () {
      document.querySelectorAll('.bar-fill').forEach(function (el) {
        el.style.width = el.dataset.width;
      });
    }, 300);
  });

  // ‚úÖ Update status AJAX
  $('.update-btn').click(function () {
    const $form = $(this).closest('form');
    const formData = $form.serialize();

    $.post('/support/update-status', formData, function (res) {
      if (res.status === 'success') {
        alert('Status updated!');
        location.reload();
      } else {
        alert('Failed to update status.');
      }
    }, 'json');
  });

  // ‚úÖ Delete request AJAX
  $('.delete-btn').click(function () {
    const id = $(this).data('id');
    if (!confirm('Are you sure to delete this request?')) return;

    $.post('/support/delete-request', { id: id }, function (res) {
      if (res.status === 'success') {
        alert('Request deleted!');
        location.reload();
      } else {
        alert('Failed to delete request.');
      }
    }, 'json');
  });

 
  // ‚úÖ Tab navigation logic
  $(document).ready(function () {
    $('.tab-btn').click(function () {
      const tab = $(this).data('tab');
      $('.tab-btn').removeClass('active');
      $(this).addClass('active');
      $('.tab-content').removeClass('active');
      $('#' + tab).addClass('active');
    });

    $('.rights-subtab-btn').click(function () {
  const subtab = $(this).data('subtab');
  $('.rights-subtab-btn').removeClass('rights-active');
  $(this).addClass('rights-active');
  $('.rights-subtab-content').removeClass('active').hide();
  $('#' + subtab).fadeIn().addClass('active');

  // ‚úÖ Save to localStorage
  localStorage.setItem('activeRightsSubTab', subtab);
});


    $('#showSupportForm').click(function () {
      $('#supportFormWrap').slideDown();
      $(this).hide();
    });

    $('iframe').on('load', function () {
      $('.nf-loader').fadeOut();
      $('.support-form-frame-container').fadeIn();
    });

    setTimeout(function () {
      $('.nf-loader').fadeOut();
      $('.support-form-frame-container').fadeIn();
    }, 10000);

    // ‚úÖ Handle redirect to Rights tab
    if (window.location.hash === '#rights') {
      $('.tab-btn[data-tab="overview"]').click();

      setTimeout(function () {
        $('.rights-subtab-btn[data-subtab="rights-pending"]').click();
        document.getElementById('rights-pending')?.scrollIntoView({ behavior: 'smooth' });
      }, 400);
    }

    // ‚úÖ Animate analytics bars
    setTimeout(function () {
      document.querySelectorAll('.bar-fill').forEach(function (el) {
        el.style.width = el.dataset.width;
      });
    }, 300);
  });
  
  // Show/hide reject reason textarea
$(document).on('change', '.status-select', function () {
  const $form = $(this).closest('form');
  if ($(this).val() === 'rejected') {
    $form.find('.reject-reason-box').slideDown();
  } else {
    $form.find('.reject-reason-box').slideUp();
  }
});
  
</script>
<script>
$(document).ready(function () {
  // ‚úÖ Admin gear icon opens modal
  $(document).on('click', '.open-action-modal', function (e) {
    e.preventDefault();
    e.stopPropagation();

    const id = $(this).data('id');
    const status = $(this).data('status');
    const reason = $(this).data('reason');

    $('#modalRequestId').val(id);
    $('#modalStatus').val(status);
    $('#modalReason').val(reason || '');
    $('#modalReason').toggle(status === 'rejected');
    $('#actionModal').addClass('active');
  });

  $('#modalCloseBtn').on('click', function () {
    $('#actionModal').removeClass('active');
  });

  $(document).on('click', function (e) {
    if ($(e.target).is('#actionModal')) {
      $('#actionModal').removeClass('active');
    }
  });

  $(document).on('keydown', function (e) {
    if (e.key === 'Escape') {
      $('#actionModal').removeClass('active');
    }
  });

  $('#modalStatus').on('change', function () {
    $('#modalReason').slideToggle($(this).val() === 'rejected');
  });

  $('#modalUpdateBtn').click(function () {
    const id = $('#modalRequestId').val();
    const status = $('#modalStatus').val();
    const reason = $('#modalReason').val();

    $.post('/support/update-status', { id, status, reject_reason: reason }, function (res) {
      if (res.status === 'success') {
        alert('Status updated!');
        location.reload();
      } else {
        alert('Failed to update.');
      }
    }, 'json');
  });

  $('#modalDeleteBtn').click(function () {
  const id = $('#modalRequestId').val();
  const $row = $('.issueRow[data-id="' + id + '"]');

  // Immediately close the action modal
  $('#actionModal').removeClass('active');

  $.post('/support/delete-request', { id }, function (res) {
    if (res.status === 'success') {
      // Optional: remove the row instantly (without reload)
      $row.fadeOut(300, function () {
        $(this).remove();
      });

      
      // Show toast
      $('#toast')
        .text('Deleted successfully!')
        .css('background', '#19211b')
        .fadeIn(200)
        .delay(1500)
        .fadeOut(400, function () {
          location.reload(); // fallback reload if needed
        });
    } else {
      alert('Failed to delete.');
    }
  }, 'json');
});


  // ‚úÖ Rights tab redirect only for admin
  <?php if ($_SESSION['user_id'] == '0' || $_SESSION['STAFFUSER'] == '1'): ?>
    if (window.location.hash === '#rights') {
      $('.tab-btn[data-tab="overview"]').click();
      setTimeout(function () {
        $('.rights-subtab-btn[data-subtab="rights-pending"]').click();
        document.getElementById('rights-pending')?.scrollIntoView({ behavior: 'smooth' });
      }, 400);
    }
  <?php else: ?>
    // Non-admin: force default overview tab only
    if (window.location.hash === '#rights') {
      $('.tab-btn[data-tab="overview"]').click();
      $('.rights-subtab-btn').removeClass('rights-active');
      $('.rights-subtab-btn[data-subtab="rights-overview"]').addClass('rights-active');
      $('.rights-subtab-content').removeClass('active').hide();
      $('#rights-overview').fadeIn().addClass('active');
    }
  <?php endif; ?>
});
</script>
    <style>
.tooltip-box {
  position: absolute;
  background: #111827;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 11px;
  white-space: pre-wrap;
  max-width: 260px;
  z-index: 9999;
  display: none;
}
</style>

<script>
$(document).ready(function () {
  let tooltipDiv = $('<div class="tooltip-box"></div>').appendTo('body');

  $(document).on('mouseenter', '.custom-tooltip-trigger', function (e) {
    let text = $(this).data('tooltip');
    if (!text) return;

    tooltipDiv.text(text).fadeIn(150);
    $(this).on('mousemove.tooltip', function (e) {
      tooltipDiv.css({
        top: e.pageY + 12,
        left: e.pageX + 12
      });
    });
  });

  $(document).on('mouseleave', '.custom-tooltip-trigger', function () {
    tooltipDiv.fadeOut(100);
    $(this).off('mousemove.tooltip');
  });
});
  
  
  $('#modalStatus').on('change', function () {
  const isRejected = $(this).val() === 'rejected';
  $('#modalReason').slideToggle(isRejected);
  $('#predefinedReasons').slideToggle(isRejected);
});

$('#predefinedReasons').on('change', function () {
  const selectedReason = $(this).val();
  if (selectedReason) {
    $('#modalReason').val(selectedReason);
  }
});
</script>
    <script>
  $('#rightsPerPage').on('change', function () {
    const perPage = $(this).val();
    const url = new URL(window.location.href);
    url.searchParams.set('per_page', perPage);
    url.searchParams.set('page', 1);
    window.location.href = url.toString() + '#rights';
  });

      $(document).on('click', '.flag-entry-btn', function (e) {
  e.stopPropagation();
  const btn = $(this);
  const id = btn.data('id');
  const row = btn.closest('tr');

  $.post('/support/flag-entry', { id }, function (res) {
    if (res.status === 'success') {
      if (res.new_status === 'flagged') {
        btn.html('‚õî').attr('title', 'Flagged for Review');
        row.css('background-color', '#fef9c3'); // yellow
        if (!btn.next('.flag-label').length) {
          btn.after('<span class="flag-label">Flagged</span>');
        }
      } else {
        btn.html('üü°').attr('title', 'Flag this Entry');
        btn.next('.flag-label').remove();

        // Restore original row color based on status badge
        const statusText = row.find('span.badge').text().trim().toLowerCase();
        let bgColor = '#fef2f2'; // default (pending)
        if (statusText === 'rejected') bgColor = '#fee2e2';
        if (statusText === 'active') bgColor = '#dcfce7';

        row.css('background-color', bgColor);
      }

      // ‚úÖ Reload page after 300ms delay to show effect
      setTimeout(() => {
        location.reload();
      }, 300);
    } else {
      alert('Failed to update flag status.');
    }
  }, 'json');
});

$(document).ready(function () {
  const url = new URL(window.location.href);
  const range = url.searchParams.get('range') || '90';

  $('.range-btn').removeClass('active');
  $(`.range-btn[data-range="${range}"]`).addClass('active');

  $('.range-btn').click(function () {
  const selectedRange = $(this).data('range');
  url.searchParams.set('range', selectedRange);
  window.location.href = url.toString();
});


});

</script>
<script>
  document.getElementById('issueFilter').addEventListener('change', function () {
    const selected = this.value.toLowerCase();
    document.querySelectorAll('.resolved-card').forEach(card => {
      const type = card.getAttribute('data-type');
      if (!selected || type.includes(selected)) {
        card.style.display = 'flex';
      } else {
        card.style.display = 'none';
      }
    });
  });
</script>
<script>
(function(){
  function isOK(res){
    if(!res) return false;
    try{ if(typeof res==='string') res=JSON.parse(res); }catch(e){}
    return !!(res.ok===true || res.status==='success' || res.result==='ok');
  }

  function postStatus(id,status,extra){
    const body=new URLSearchParams();
    body.set('id',id);
    body.set('status',status);
    if(extra&&extra.reject_reason) body.set('reject_reason',extra.reject_reason);
    return fetch('<?= $this->url("support",["action"=>"update-status"]); ?>',{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
      body:body.toString(),
      credentials:'same-origin'
    }).then(r=>r.json());
  }

  document.addEventListener('click',e=>{
    const btn=e.target.closest('.mark-in-process');
    if(!btn) return;
    e.stopPropagation(); // ‚õî prevent side panel open
    const id=btn.dataset.id;
    btn.disabled=true;
    postStatus(id,'in_process').then(res=>{
      if(isOK(res)){
        btn.closest('tr')?.remove();
        location.reload();
      }else{
        alert((res&&(res.msg||res.error))||'Failed');
        btn.disabled=false;
      }
    }).catch(()=>{alert('Network error');btn.disabled=false;});
  });

  document.addEventListener('click',e=>{
    const btn=e.target.closest('.back-to-pending');
    if(!btn) return;
    e.stopPropagation(); // ‚õî prevent side panel open
    const id=btn.dataset.id;
    btn.disabled=true;
    postStatus(id,'back_to_pending').then(res=>{
      if(isOK(res)){
        btn.closest('tr')?.remove();
        location.reload();
      }else{
        alert((res&&(res.msg||res.error))||'Failed');
        btn.disabled=false;
      }
    }).catch(()=>{alert('Network error');btn.disabled=false;});
  });

  document.addEventListener('click',e=>{
    const btn=e.target.closest('.mark-resolved');
    if(!btn) return;
    e.stopPropagation(); // ‚õî prevent side panel open
    const id=btn.dataset.id;
    btn.disabled=true;
    postStatus(id,'resolved').then(res=>{
      if(isOK(res)){
        btn.closest('tr')?.remove();
        location.reload();
      }else{
        alert((res&&(res.msg||res.error))||'Failed');
        btn.disabled=false;
      }
    }).catch(()=>{alert('Network error');btn.disabled=false;});
  });
})();
</script>

<script>
  const UPDATE_URL = '<?= $this->url("support", ["action"=>"update-status"]); ?>';
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const IS_ADMIN = <?php echo ($_SESSION['user_id'] == 0) ? 'true' : 'false'; ?>;

  /* =========================
   *  UX: disable look (optional)
   * ========================= */
  if (!IS_ADMIN) {
    document.querySelectorAll('tr.open-right-panel[data-locked="1"] .action-dd__toggle')
      .forEach(btn => {
        btn.classList.add('is-disabled');
        btn.setAttribute('aria-disabled','true');
        btn.setAttribute('title','Locked by Admin');
      });
  }

  /* =======================================================
   *  HARD BLOCKS (capture phase) ‚Äî row and inner actions
   * ======================================================= */
  // Row click block for non-admin on locked rows
  document.addEventListener('click', function (e) {
    const tr = e.target.closest('tr.open-right-panel');
    if (!tr || IS_ADMIN) return;
    if (tr.getAttribute('data-locked') === '1') {
      e.stopImmediatePropagation();
      e.preventDefault();
      showLockToast('This track is locked by Admin.');
    }
  }, true);

  // Links/buttons (including action items) blocked inside locked rows
  document.addEventListener('click', function (e) {
    if (IS_ADMIN) return;
    const actionable = e.target.closest(
      'a,button,.open-links,.open-action-modal,.mark-in-process,.back-to-pending,.mark-resolved,.action-dd__item'
    );
    if (!actionable) return;

    const tr = actionable.closest('tr.open-right-panel');
    if (tr && tr.getAttribute('data-locked') === '1') {
      e.stopImmediatePropagation();
      e.preventDefault();
      showLockToast('Action locked until Admin unflags.');
    }
  }, true);

  /* ===========================================
   *  FLOATING DROPDOWN (single consolidated)
   * =========================================== */
  let currentMenu = null;
  let currentToggle = null;

  function placeMenuFixed(menu, toggle) {
    menu.style.display = 'block';
    const r = toggle.getBoundingClientRect();
    const mw = menu.offsetWidth, mh = menu.offsetHeight;
    let top = r.bottom + 8, left = r.left;

    if (left + mw > innerWidth - 8) left = Math.max(8, r.right - mw);
    if (top + mh > innerHeight - 8) top = Math.max(8, r.top - mh - 8);
    left = Math.max(8, Math.min(left, innerWidth - mw - 8));
    top  = Math.max(8, Math.min(top,  innerHeight - mh - 8));

    menu.style.left = left + 'px';
    menu.style.top  = top  + 'px';
  }

  function openMenu(root, toggle, menu) {
    menu.classList.add('is-floating');
    menu.style.right = 'auto';
    menu.style.width = 'max-content';
    menu.style.minWidth = '200px';
    menu.style.maxWidth = '320px';
    menu.__owner = root;

    document.body.appendChild(menu);
    placeMenuFixed(menu, toggle);

    currentMenu = menu;
    currentToggle = toggle;
    toggle.setAttribute('aria-expanded', 'true');

    const closer = (ev) => {
      if (ev === true) return;
      if (ev.type === 'click' &&
          (ev.target.closest('.action-dd__menu') || ev.target.closest('.action-dd__toggle'))) return;
      closeMenu(menu);
      removeClosers();
    };
    function removeClosers(){
      document.removeEventListener('click', closer, true);
      window.removeEventListener('scroll', closer, true);
      window.removeEventListener('resize', closer, true);
    }
    menu.__removeClosers = removeClosers;

    document.addEventListener('click', closer, true);
    window.addEventListener('scroll', closer, true);
    window.addEventListener('resize', closer, true);
  }

  function closeMenu(menu) {
    if (!menu) return;
    menu.style.display = 'none';
    menu.classList.remove('is-floating');
    menu.style.left = menu.style.top = menu.style.right =
      menu.style.width = menu.style.minWidth = menu.style.maxWidth = '';

    if (menu.__owner) menu.__owner.appendChild(menu);
    if (menu.__removeClosers) menu.__removeClosers();

    if (currentToggle) currentToggle.setAttribute('aria-expanded', 'false');
    currentMenu = null;
    currentToggle = null;
  }

  function closeAll(except){
    document.querySelectorAll('.action-dd.open').forEach(dd=>{
      if(dd!==except) dd.classList.remove('open');
      dd.querySelector('.action-dd__toggle')?.setAttribute('aria-expanded','false');
    });
  }

  // Single global click handler (capture) for toggles/menus
  document.addEventListener('click', function (e) {
    const toggle = e.target.closest('.action-dd__toggle');
    const root   = e.target.closest('.action-dd');

    // Guard: team + locked row => block opening
    if (toggle && root && !IS_ADMIN) {
      const tr = root.closest('tr.open-right-panel');
      if (tr && tr.getAttribute('data-locked') === '1') {
        e.preventDefault(); e.stopPropagation();
        showLockToast('Action locked until Admin unflags.');
        return;
      }
    }

    // Prefer the floating menu if it belongs to this root
    let menu = null;
    if (root) {
      const inPlace = root.querySelector('.action-dd__menu');
      const floatingOwned = (currentMenu && currentMenu.__owner === root) ? currentMenu : null;
      menu = floatingOwned || inPlace;
    }

    // Toggle handling
    if (toggle && root && menu) {
      e.preventDefault();
      e.stopPropagation();

      if (currentMenu === menu) { // same menu -> close
        closeMenu(currentMenu);
        return;
      }
      if (currentMenu && currentMenu !== menu) closeMenu(currentMenu); // another open -> close first

      // If menu is inline dropdown (non-floating usage), also support class toggle
      if (menu && !menu.classList.contains('is-floating')) {
        // open as floating for consistent clipping-avoidance
        openMenu(root, toggle, menu);
      } else {
        openMenu(root, toggle, menu);
      }
      return;
    }

    // Menu item clicked ‚Üí close menu; allow delegated handlers
    if (e.target.closest('.action-dd__item')) {
      const owner = currentMenu?.__owner || root;
      owner?.classList.remove('open');
      owner?.querySelector('.action-dd__toggle')?.setAttribute('aria-expanded','false');
      if (currentMenu) closeMenu(currentMenu);
      // no stopPropagation -> let actual click handler run
      return;
    }

    // Clicked outside ‚Üí close all
    if (!root) {
      closeAll();
      if (currentMenu) closeMenu(currentMenu);
    }
  }, true);

  // ESC to close
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      closeAll();
      if (currentMenu) closeMenu(currentMenu);
    }
  }, true);
});
</script>
