<?php
/** @var \Zend\View\Renderer\PhpRenderer $this */

/* 1) SOURCE OF TRUTH â€” artist ko pehle set karo */
$artist = $this->artist ?? [
  'id' => 0,
  'name' => 'Artist Name',
  'image_url' => '/public/img/demo/artist-placeholder.png',
  'country' => 'IN',
  'spotify_id' => '',
  'apple_id' => '',
  'apple_url' => '',
  'followers' => 0,
  'popularity' => 0,
  'bio' => '',
  'badge_icon' => '',
  'all_time_streams' => 0,
  'monthly_listeners' => 0,
];
/* hero background (use banner then image; make absolute; fallback) */
$heroBg = trim((string)($artist['banner_url'] ?? ''));
if ($heroBg === '') $heroBg = trim((string)($artist['image_url'] ?? ''));
if ($heroBg !== '' && stripos($heroBg,'http') !== 0) $heroBg = $this->basePath($heroBg);
if ($heroBg === '') $heroBg = $this->basePath('/public/img/demo/artist-placeholder.png');
/* optional helpers you already use later */
$songs    = (isset($this->songs) && (is_array($this->songs) || $this->songs instanceof Countable)) ? $this->songs : [];
$period   = $this->period ?? 'Current Month';
$account  = $this->account ?? ['id'=>'â€”'];
$artistId = (int)($artist['id'] ?? 0);

/* 2) MODAL PAYLOAD â€” ab $artist se banao */
$artistPayload = [
  'id'         => (int)($artist['id'] ?? 0),
  'name'       => (string)($artist['name'] ?? ''),
  'image_url'  => (string)($artist['image_url'] ?? ''),
  'country'    => (string)($artist['country'] ?? ''),
  'spotify_id' => (string)($artist['spotify_id'] ?? ''),
  'apple_id'   => (string)($artist['apple_id'] ?? ''),
  'followers'  => (int)($artist['followers'] ?? 0),
  'popularity' => (int)($artist['popularity'] ?? 0),
  'bio'        => (string)($artist['bio'] ?? ''),
];
$artistJson = htmlspecialchars(
  json_encode($artistPayload, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE),
  ENT_QUOTES,
  'UTF-8'
);

/* 3) COUNTRY FLAG â€” ab $artist ke baad */
$countryRaw = trim((string)($artist['country'] ?? ''));
$countryMap = [
  'India'=>'in','INDIA'=>'in','IN'=>'in',
  'United States'=>'us','USA'=>'us','US'=>'us',
  'United Kingdom'=>'gb','UK'=>'gb','GB'=>'gb',
  'Pakistan'=>'pk','PK'=>'pk',
];
$cc = null;
if ($countryRaw !== '') {
  if (isset($countryMap[$countryRaw])) {
    $cc = $countryMap[$countryRaw];
  } elseif (preg_match('/^[A-Z]{2}$/', $countryRaw)) {
    $cc = strtolower($countryRaw);
  }
}
$webDir  = '/public/img/flags';
$tryExts = ['svg','png','webp','jpg','jpeg'];
$flagRel = null;
if ($cc) {
  foreach ($tryExts as $ext) {
    $candidate = "$webDir/$cc.$ext";
    if (@file_exists(rtrim($_SERVER['DOCUMENT_ROOT'],'/').$candidate)) { $flagRel = $candidate; break; }
  }
}
$flagUrl = $flagRel ? $this->basePath($flagRel) : null;

/* 4) SOCIAL + KPI HELPERS â€” ab $artist ready hai */
$spotifyId  = trim((string)($artist['spotify_id'] ?? ''));
$spotifyUrl = $spotifyId !== ''
  ? (strpos($spotifyId, 'http') === 0 ? $spotifyId : "https://open.spotify.com/artist/".rawurlencode($spotifyId))
  : '';

$appleId  = trim((string)($artist['apple_id'] ?? $artist['apple_artist_id'] ?? $artist['apple_music_id'] ?? ''));
$appleUrl = trim((string)($artist['apple_url'] ?? ''));
$appleArtistUrl = '';
if ($appleUrl !== '') {
  $appleArtistUrl = $appleUrl;
} elseif ($appleId !== '') {
  $appleArtistUrl = ctype_digit($appleId) ? "https://music.apple.com/artist/".$appleId : $appleId;
}

$rawBadge = trim((string)($artist['badge_icon'] ?? ''));
if ($rawBadge !== '') {
  if (stripos($rawBadge, 'data:image/') === 0) {
    $badgeSrc = $rawBadge;
  } elseif (preg_match('~^https?://~i', $rawBadge)) {
    $badgeSrc = $rawBadge;
  } else {
    $rel = ($rawBadge[0] === '/') ? $rawBadge : '/uploads/'.$rawBadge;
    $badgeSrc = $this->basePath($rel);
  }
} else {
  $badgeSrc = $this->basePath('/public/img/icons/tick.svg');
}

$followers  = (int)($artist['followers']  ?? 0);
$popularity = (int)($artist['popularity'] ?? 0);
?>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"/>

<style>
  /* Header */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.breadcrumb{display:flex;gap:8px;align-items:center;color:var(--muted);font-weight:500}
.icon-btn{display:grid;place-items:center;width:38px;height:38px;border-radius:12px;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);cursor:pointer}
.avatar{width:38px;height:38px;border-radius:999px;object-fit:cover;border:2px solid #fff;box-shadow:var(--shadow)}

:root{ --bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;
  --accent:#6d28d9;--accent-2:#2563eb;--good:#16a34a;--bad:#dc2626;--chip:#f3f4f6;
  --radius:14px;--shadow:0 10px 24px rgba(15,23,42,.06) }
*{box-sizing:border-box}
body{font-family:'Inter',system-ui,Arial,sans-serif;color:var(--ink);background:var(--bg)}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
a{text-decoration:none;color:inherit}
.header-crumb{display:flex;align-items:center;gap:10px;color:var(--muted);font-weight:600;font-size:13px;margin-bottom:8px}
.header-crumb .dot{width:4px;height:4px;background:#cbd5e1;border-radius:50%}
.artist-hero{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:18px 18px;display:flex;align-items:center;justify-content:space-between;gap:16px;box-shadow:var(--shadow)}
.artist-left{display:flex;align-items:center;gap:14px}
.artist-avatar{width:80px;height:80px;border-radius:999px;object-fit:cover;border:1px solid var(--line)}
.artist-meta .name{font-size:21px;font-weight:800;display:flex;align-items:center;gap:6px}
.badge-verified{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;margin-left:6px;line-height:0}
.artist-meta .sub{color:var(--muted);font-size:12px;display:flex;gap:8px;align-items:center}
.artist-right{display:grid;grid-auto-flow:column;gap:14px;align-items:center; margin-bottom: 55;}
.kpi{display:flex;flex-direction:column-reverse;align-items:flex-end}
.kpi .v{font-size:19px;font-weight:800;color: #ffffff;}
.kpi .l{font-size:12px;color: #ffffff; font-weight: 700}
.kpi.small .v{font-size:19px;color: #ffffff;}
.kpi.small .l{font-size:12px;}
.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:var(--chip);font-weight:700}
.btn.primary{background:var(--accent-2);border-color:#1d4ed8;color:#fff}
.tabs{margin-top:14px}.tabbar{display:flex;gap:18px;align-items:center;border-bottom:1px solid var(--line)}
.tabbar button{appearance:none;background:none;border:none;padding:12px 2px;font-weight:700;color:var(--muted);cursor:pointer;position:relative}
.tabbar button.active{color:var(--ink)}
.tabbar button.active::after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:3px;border-radius:3px;background:var(--accent)}
.filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 0;margin-top:10px}
.filter{display:flex;align-items:center;gap:6px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px 10px}
.filter label{font-size:12px;color:var(--muted);font-weight:700}
.filter select,.filter input{border:none;outline:none;background:transparent;font:600 13px/1 'Inter',sans-serif;color:var(--ink)}
.filter input{width:200px}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
.chart-wrap{padding:4px 6px 12px}
.chart-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.chart-head .title{font-size:14px;font-weight:800}
.legend{display:flex;gap:12px;font-size:12px;color:var(--muted)}
.legend .key{display:flex;align-items:center;gap:6px}
.legend .dot{width:10px;height:10px;border-radius:50%}
.aw-canvas{width:100%;height:240px;border:1px dashed #e5e7eb;border-radius:12px;position:relative;overflow:hidden}
.statrow{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:12px}
.stat{background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:10px}
.stat .l{font-size:11px;color:var(--muted);font-weight:700}
.stat .v{font-size:16px;font-weight:800}
.bar{height:6px;border-radius:999px;background:#e5e7eb;overflow:hidden;margin-top:6px}
.bar > span{display:block;height:100%;background:var(--accent-2)}
.table-card{margin-top:16px}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.row{display:grid;grid-template-columns: 1.2fr .6fr .4fr .4fr .5fr;align-items:center;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px}
.song{display:flex;align-items:center;gap:10px}
.song img{width:44px;height:44px;border-radius:8px;border:1px solid var(--line);object-fit:cover}
.song .t{font-weight:700;font-size:13px}.song .s{font-size:12px;color:var(--muted)}
.chg.up{color:var(--good);font-weight:800}.chg.down{color:var(--bad);font-weight:800}
.pager{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-top:12px;font-size:12px;color:var(--muted)}
.pager .btn{padding:8px 10px}
.hidden{display:none}
.artist-links{display:flex;gap:10px;align-items:center;margin-top:2px}
.artist-links a { display:inline-flex; }
.artist-links a:hover{background:#eef2ff;border-color:#c7d2fe}
.artist-links .ico{width:14px;height:14px;display:inline-block}
@media (max-width:1000px){ .row{grid-template-columns:1.4fr .7fr .5fr .5fr .7fr} .statrow{grid-template-columns:repeat(3,1fr)} }
@media (max-width:720px){ .artist-hero{flex-direction:column;align-items:flex-start} .row{grid-template-columns:1fr} .filters{gap:8px} .statrow{grid-template-columns:repeat(2,1fr)} }
.artist-meta .name{display:inline-flex;align-items:center;gap:6px; color: white;}
.verified-badge{display:inline-flex;align-items:center;justify-content:center;flex:0 0 auto}
.verified-badge img{width:18px;height:18px;object-fit:contain}
.artist-right .kpi{ position:relative; padding-right:18px; margin-right:6px; }
.artist-right .kpi::after{ content:""; position:absolute; right:0; top:50%; transform:translateY(-50%); width:1px; height:40px; background:var(--line); border-radius:1px; }
@media (max-width: 720px){ .artist-right .kpi{ padding-right:0; margin-right:0; } .artist-right .kpi::after{ display:none; } }
.artist-meta .meta-top{ display:flex; gap:8px; align-items:center; margin-bottom:6px; }
.chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:3px; background:var(--chip); font:700 11px/1 'Inter',sans-serif; color:#475569; }
.chip-role { background:#e6e6e6; }
.chip-country .flag{ font-size:14px; line-height:1; }
.artist-meta .name{ margin-top:2px; }
.pill-artist { display:inline-flex; align-items:center; font-weight:700; color: #ffffff; letter-spacing:.2px; }
.meta-top .vsep { display:inline-block; width:1px; height:15px; background:#d6d6d6; margin:0 4px; vertical-align:middle; border-radius:1px; }
.artist-bio { font-size:13px; color: white; margin-top:4px; max-width:520px; line-height:1.5; font-weight:500; }
@media (max-width:720px){ .meta-top .vsep{ display:none; } }
/* ==== icon-only edit button ==== */
.btn-icon { display:inline-flex; align-items:center; justify-content:center; width:38px; height:38px; border-radius:12px; border:1px solid var(--line); background:var(--chip); box-shadow:var(--shadow); transition:all .2s; }
.btn-icon:hover { background:var(--accent-2); border-color:#1d4ed8; transform:translateY(-1px); }
.btn-icon img { width:30px; height:30px; object-fit:contain; filter:brightness(0) saturate(100%) invert(18%) sepia(72%) saturate(1000%) hue-rotate(220deg); }
.btn-icon:hover img { filter:brightness(0) invert(1); }
/* ===== Playlists grid ===== */
.pl-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.pl-title{font-weight:800;font-size:16px}
.pl-actions{display:flex;gap:8px;align-items:center}
.pl-input{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;font:600 13px/1 'Inter',sans-serif;width:220px}

.pl-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:1000px){ .pl-grid{grid-template-columns:repeat(2,1fr)} }
@media (max-width:640px){ .pl-grid{grid-template-columns:1fr} }

.pl-card{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
.pl-cover{width:100%;aspect-ratio:1/1;object-fit:cover;background:#eef2ff}
.pl-body{padding:10px 12px;display:grid;gap:6px}
.pl-name{font:700 13px/1.25 'Inter',sans-serif}
.pl-meta{font:600 12px/1.2 'Inter',sans-serif;color:#6b7280;display:flex;gap:10px;flex-wrap:wrap}
.pl-foot{display:flex;gap:8px;align-items:center;padding:10px 12px;border-top:1px solid var(--line)}
.pl-open{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#f3f4f6;font:800 12px/1 'Inter',sans-serif}
.pl-open:hover{background:#eef2ff;border-color:#c7d2fe}

.pl-empty,.pl-error{padding:20px;border:1px dashed var(--line);border-radius:12px;color:#6b7280;text-align:center;margin-top:10px}

/* skeleton */
.pl-grid--skeleton .pl-card.sk{height:220px;background:linear-gradient(90deg,#f3f4f6 0%,#edeef3 50%,#f3f4f6 100%);background-size:200% 100%;animation:plShimmer 1.1s linear infinite;border-radius:14px}
@keyframes plShimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* base hero needs to be a stacking context */
.artist-hero {
    position: relative;
    overflow: hidden;
    border-radius: 18px;
    border: 1px solid #c5c5c5;
    box-shadow: inset 0 10px 24px 3px rgb(0 0 0);
}

/* blurred image layer using the CSS var from inline style */
.artist-hero__bg{
  position: absolute; inset: 0;
  background-image: var(--bg, none);
  background-size: cover; background-position: center;
  filter: blur(16px) saturate(120%);
  transform: scale(1.05);
}

/* soft dark gradient like Chartmetric */
.artist-hero__overlay {
    position: absolute;
    inset: 0;
    background: radial-gradient(1000px 360px at 20% -10%, rgba(255, 255, 255, .35), transparent 60%), linear-gradient(180deg, rgb(15 23 42 / 20%), rgba(15, 23, 42, .8));
}

/* your existing content must be above the layers */
.artist-hero__content{
  position: relative;
  z-index: 2;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: var(--hero-gap, 16px);
  padding: 12px;
}

/* when bio present */
.artist-hero.has-bio { --hero-gap: 16px; }

/* when no bio */
.artist-hero.no-bio  { --hero-gap: 260px; }

/* optional: mobile me gap kam kar do */
@media (max-width: 720px){
  .artist-hero.has-bio  { --hero-gap: 16px; }
  .artist-hero.no-bio   { --hero-gap: 20px; }
}
/* name text ko inline hi rehne do */
.artist-meta .name{ display: inline; }

/* âœ… badge hamesha name ke baseline ke saath chipke */
.verified-badge{
  display:inline-block;
  vertical-align:baseline;
  line-height:0;
  margin-left:6px;
  position:relative;
  top:-2px;
}

/* img ko block bana do taaki extra gap na aaye */
.verified-badge img{
  display:block;
  width:18px;
  height:18px;
}
/* left/right items predictable width */
.artist-left  { flex: 0 1 auto; min-width: 0; }
.artist-right { flex: 0 0 auto; }

/* name ko inline flow me lao */
.artist-meta .name{
  display: inline;
  font-size: 21px;
  font-weight: 800;
  color: #fff;
}

/* badge inline */
.verified-badge{
  display: inline-block;
  vertical-align: middle;
  margin-left: 6px;
  line-height: 0;
}
.verified-badge img{ width:18px; height:18px; transform: translateY(1px); }

/* ===================== TOP TRACKS â€” GRID (ADDED) ===================== */
.tt-wrap{margin-bottom:8px}
.tt-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.tt-title{font:800 16px/1 'Inter',sans-serif;margin:0}
.tt-skel{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.tt-skel-row{height:200px;border-radius:14px;background:linear-gradient(90deg,#f3f4f6 0%,#edeef3 50%,#f3f4f6 100%);background-size:200% 100%;animation:plShimmer 1.1s linear infinite}
@media (max-width:1200px){ .tt-skel{grid-template-columns:repeat(5,1fr)} }
@media (max-width:1000px){ .tt-skel{grid-template-columns:repeat(4,1fr)} }
@media (max-width:760px){  .tt-skel{grid-template-columns:repeat(2,1fr)} }

.tt-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media (max-width:1200px){ .tt-grid{grid-template-columns:repeat(5,1fr)} }
@media (max-width:1000px){ .tt-grid{grid-template-columns:repeat(4,1fr)} }
@media (max-width:760px){  .tt-grid{grid-template-columns:repeat(2,1fr)} }

.tt-card{border:1px solid var(--line);background:#fff;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
.tt-cover-wrap{position:relative}
.tt-cover{width:100%;aspect-ratio:1/1;object-fit:cover;background:#eef2ff;display:block}
.tt-play{position:absolute;inset:auto 8px 8px auto;padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;font:800 12px/1 'Inter',sans-serif;cursor:pointer}
.tt-play[aria-pressed="true"]{background:#111827;color:#fff;border-color:#111827}
.tt-body{padding:10px 12px;display:grid;gap:4px}
.tt-name{font:700 13px/1.25 'Inter',sans-serif}
.tt-artist{font:600 12px/1.2 'Inter',sans-serif;color:#6b7280}
.tt-foot{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-top:1px solid var(--line)}
.tt-dur{font:700 12px/1 'Inter',sans-serif;color:#475569}
.tt-open{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#f3f4f6;font:800 12px/1 'Inter',sans-serif}
/* Top Tracks meta badges */
.tt-meta { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:4px; }
.pill {
  display:inline-flex; align-items:center; gap:6px;
  padding: 2px 8px; border:1px solid var(--line); border-radius:3px;
  background:#f8fafc; color:#111; font:600 11px/1 'Inter',sans-serif;
}
.pill.ep     { background: #ecfff2;
    border-color: #00c93f; }
.pill.album  { background: #ecfff2;
    border-color: #00c93f; }
.pill.single { background: #ecfff2;
    border-color: #00c93f; }
/* ===== Pretty empty-state for Playlists ===== */
.empty-block{
  position: relative;
  border: 1px dashed var(--line);
  border-radius: 14px;
  background: linear-gradient(180deg,#fafbff, #f6f7fb);
  padding: 28px 18px;
  text-align: center;
  color: #475569;
}
.empty-art{ display:flex; align-items:center; justify-content:center; margin-bottom:12px; }
.empty-art img{ width:180px; height:auto; object-fit:contain; opacity:.95; }
.empty-art svg{ width:180px; height:auto; opacity:.95; }
.empty-title{ font:800 16px/1.2 'Inter',sans-serif; color:#0f172a; margin:0 0 6px; }
.pl-empty__msg{ font:600 13px/1.5 'Inter',sans-serif; margin:0 auto 12px; max-width:620px; color:#64748b; }
.empty-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
.empty-actions .btn{ padding:8px 12px; border-radius:10px; border:1px solid var(--line);
  background:#fff; font:800 12px/1 'Inter',sans-serif; }
.empty-actions .btn.primary{ background:var(--accent-2); color:#fff; border-color:#1d4ed8; }
/* ===== Top Tracks : Hover effects ===== */

/* base */
.tt-card{
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  will-change: transform;
}

/* lift + glow */
.tt-card:hover{
  transform: translateY(-4px);
  box-shadow: 0 14px 28px rgba(15,23,42,.12), 0 6px 12px rgba(15,23,42,.06);
  border-color: #d1d5db;
}

/* cover zoom + soft overlay */
.tt-cover-wrap{ position: relative; overflow: hidden; }
.tt-cover{
  transition: transform .25s ease, filter .25s ease;
}
.tt-card:hover .tt-cover{
  transform: scale(1.04);
  filter: saturate(1.08);
}
.tt-cover-wrap::before{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(60% 60% at 70% 80%, rgba(0,0,0,.0), rgba(0,0,0,.18));
  opacity:0; transition: opacity .25s ease;
}
.tt-card:hover .tt-cover-wrap::before{ opacity:1; }

/* play button: fade in on hover (if present) */
.tt-play{
  opacity:0; transform: translateY(4px);
  transition: opacity .18s ease, transform .18s ease, background .15s ease, border-color .15s ease;
}
.tt-card:hover .tt-play{
  opacity:1; transform: translateY(0);
}
.tt-play:hover{ background:#111827; color:#fff; border-color:#111827; }

/* footer button subtle change */
.tt-open{
  transition: background .15s ease, border-color .15s ease, color .15s ease;
}
.tt-card:hover .tt-open{
  background:#eef2ff; border-color:#c7d2fe; color:#111827;
}
.tt-grid{ contain: layout paint; }

/* title underline on hover */
.tt-name{ transition: color .15s ease, text-decoration-color .15s ease; }
.tt-card:hover .tt-name{ color:#0f172a; }

/* reduced motion friendly */
@media (prefers-reduced-motion: reduce){
  .tt-card, .tt-cover, .tt-play, .tt-cover-wrap::before, .tt-open, .tt-name{
    transition: none !important;
  }
}

</style>

<div class="container" data-artist="<?= $artistId ?>">
  <div class="page">
  <div class="header">
    <div class="breadcrumb">
      <a href="https://www.primebackstage.in/analytics/charts">Chart</a><span>â€º</span><a href="#">Artist Overview</a>
    </div>
    <div style="display:flex;gap:10px;align-items:center"></div>
  </div>


 <?php $hasBio = trim((string)($artist['bio'] ?? '')) !== ''; ?>
<div class="artist-hero <?= $hasBio ? 'has-bio' : 'no-bio' ?>"
     style="--bg: url('<?= $this->escapeHtmlAttr($heroBg) ?>')">
  <div class="artist-hero__bg"></div>
  <div class="artist-hero__overlay"></div>
  <div class="artist-hero__content">

   <div class="artist-left">
  <img class="artist-avatar" src="<?= $this->escapeHtmlAttr($artist['image_url']) ?>" alt="">
  <div class="artist-meta">

    <!-- NEW: pills above the name -->
    <div class="meta-top">
      <span class="chip chip-role">Artist</span>
     <span class="pill-artist" aria-label="Artist">Country:</span>
<?php if ($flagUrl): ?>
  <img class="flag"
       src="<?= $this->escapeHtmlAttr($flagUrl) ?>"
       width="18" height="13"
       alt="<?= $this->escapeHtmlAttr($countryRaw ?: 'Country') ?>"
       loading="lazy">
<?php else: ?>
  <span class="pill-artist" style="opacity:.7">â€”</span>
<?php endif; ?>

      <span class="vsep"></span>
      <span class="pill-artist" aria-label="Artist">Social Links:</span>
       <?php if ($spotifyUrl || $appleArtistUrl): ?>
      <div class="artist-links">
        <?php if ($spotifyUrl): ?>
          <a href="<?= $this->escapeHtmlAttr($spotifyUrl) ?>" target="_blank" rel="noopener">
            <span class="ico">
              <!-- spotify svg -->
              <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="#1ED760" d="M12 0a12 12 0 1 0 0 24 12 12 0 0 0 0-24Zm5.4 17.1a.9.9 0 0 1-1.25.3c-3.43-2.1-7.76-2.57-12.18-1.34a.9.9 0 1 1-.47-1.73c4.83-1.3 9.61-.8 13.43 1.56a.9.9 0 0 1 .47 1.21Zm.6-3.01a1.1 1.1 0 0 1-1.53.36c-3.93-2.41-9.9-3.11-14.53-1.62a1.1 1.1 0 0 1-.64-2.11c5.17-1.58 11.6-.8 15.97 1.87.52.32.68 1 .34 1.5Zm.14-3.15a1.3 1.3 0 0 1-1.8.42c-4.49-2.73-12.02-2.98-16.3-1.57a1.3 1.3 0 0 1-.79-2.48c4.95-1.58 13.25-1.31 18.34 1.8.62.38.82 1.2.55 1.83Z"/></svg>
            </span>
          </a>
        <?php endif; ?>
        <?php if ($appleArtistUrl): ?>
  <a href="<?= $this->escapeHtmlAttr($appleArtistUrl) ?>" target="_blank" rel="noopener">
    <span class="ico">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="#111" d="M16.36 1.64c0 1.2-.49 2.32-1.28 3.21-.81.9-2.14 1.6-3.29 1.5-.14-1.11.44-2.32 1.21-3.15.82-.9 2.26-1.58 3.36-1.56Zm4.14 16.31c-.64 1.49-1.42 2.95-2.56 4.08-1 .99-2.22 2.02-3.64 1.97-1.43-.06-1.9-.64-3.53-.64-1.63 0-2.14.62-3.56.66-1.42.03-2.51-1.06-3.52-2.05-1.91-1.85-3.39-4.85-3.42-7.74-.03-1.66.35-3.29 1.25-4.68 1.15-1.78 3.08-2.91 5.22-2.95 1.37-.03 2.66.7 3.53.7.86 0 2.45-.86 4.14-.74 1.41.06 2.7.58 3.67 1.52-1.45.88-2.33 2.42-2.31 4.07.03 1.63.86 3.16 2.19 4.02.65.42 1.38.71 2.12.79Z"/></svg>
    </span>
  </a>
<?php endif; ?>

      </div>
    <?php endif; ?>
</div>

    <div class="name">
      <?= $this->escapeHtml($artist['name']) ?>
      <span class="verified-badge" title="Verified" aria-label="Verified">
        <img src="<?= $this->escapeHtmlAttr($badgeSrc) ?>?v=1"
             width="18" height="18" alt="Verified"
             onerror="this.style.display='none'">
      </span>
    </div>

<?php if (!empty($artist['bio'])): ?>
  <div class="artist-bio">
    <?= nl2br($this->escapeHtml($artist['bio'])) ?>
  </div>
<?php endif; ?>

  </div>
</div>

    <div class="artist-right">
      <div class="kpi">
        <div class="v" id="kpi-alltime"><?= number_format((int)$artist['all_time_streams']) ?></div>
        <div class="l">All Time Streams</div>
      </div>

      <div class="kpi small">
        <div class="v"><?= number_format($followers) ?></div>
        <div class="l">Monthly Followers</div>
      </div>

      <div class="kpi small">
        <div class="v"><?= (int)$popularity ?></div>
        <div class="l">Popularity</div>
      </div>

    <a href="#!"
   class="btn-icon js-open-artist-edit"
   role="button" aria-haspopup="dialog"
   title="Edit Artist"
   data-artist="<?= $artistJson ?>">
  <img src="<?= $this->basePath('/public/img/icons/add.png'); ?>"
       alt="Edit Artist" width="22" height="22" loading="lazy"
       onerror="this.src='<?= $this->basePath('/public/img/icons/add.svg'); ?>'">
</a>

    </div>
  </div>
</div>
  <div class="tabs">
    <div class="tabbar" role="tablist" aria-label="Artist sections">
      <button class="tab active" data-tab="playlists">Playlists</button>
      <button class="tab" data-tab="social">Social</button>
    </div>
  </div>

  <div class="filters"></div>

  <!-- placeholders -->
<section id="tab-playlists" class="card hidden" aria-hidden="true">
  <!-- ðŸ”Š TOP TRACKS (Spotify-style) -->
  <div class="tt-wrap">
    <div class="tt-head">
      <h3 class="tt-title">Top Tracks</h3>
    </div>

    <!-- loader -->
    <div id="ttLoader" class="tt-skel" aria-hidden="true">
      <div class="tt-skel-row"></div>
      <div class="tt-skel-row"></div>
      <div class="tt-skel-row"></div>
      <div class="tt-skel-row"></div>
    </div>

    <!-- list (container same rakha, andar grid inject hoga) -->
    <div id="ttList"></div>

    <!-- empty / error -->
    <div id="ttEmpty" class="pl-empty" hidden>No top tracks found.</div>
    <div id="ttError" class="pl-error" hidden>Couldnâ€™t load top tracks.</div>
  </div>

  <!-- â€”â€” Featured On (existing playlists grid) â€”â€” -->
  <div class="pl-head" style="margin-top:14px">
    <div class="pl-title">Featured On</div>
    <div class="pl-actions"></div>
  </div>

  <!-- loader -->
  <div id="plLoader" class="pl-grid pl-grid--skeleton" aria-hidden="true">
    <div class="pl-card sk"></div><div class="pl-card sk"></div><div class="pl-card sk"></div>
    <div class="pl-card sk"></div><div class="pl-card sk"></div><div class="pl-card sk"></div>
  </div>

  <!-- results grid -->
  <div id="plGrid" class="pl-grid" hidden></div>

  <!-- empty / error -->
  <!-- Empty / error state -->
<div id="plEmpty" class="pl-empty empty-block" hidden>
  <div class="empty-art">
    <!-- INLINE SVG illustration -->
    <svg viewBox="0 0 260 160" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs>
        <linearGradient id="bgGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#f9fbff"/>
          <stop offset="1" stop-color="#eef2ff"/>
        </linearGradient>
      </defs>
      <rect x="15" y="25" width="230" height="110" rx="14" fill="url(#bgGrad)" stroke="#c7d2fe"/>
      <circle cx="75" cy="80" r="24" fill="#e0e7ff" stroke="#93b4ff"/>
      <path d="M63 80l10 8 12-16" stroke="#2563eb" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      <rect x="115" y="60" width="90" height="8" rx="4" fill="#c7d2fe"/>
      <rect x="115" y="78" width="70" height="8" rx="4" fill="#dbe7ff"/>
      <rect x="115" y="96" width="50" height="8" rx="4" fill="#e6edff"/>
      <!-- floating sparkle -->
      <g transform="translate(200 30)">
        <circle cx="18" cy="18" r="18" fill="#e8faff" stroke="#9ae6b4"/>
        <path d="M12 18l6 6 10-12" fill="none" stroke="#16a34a" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
      </g>
      <g fill="#a5b4fc">
        <path d="M35 38l3 6 6 1-5 4 1 6-5-3-5 3 1-6-5-4 6-1z" opacity=".6"/>
        <path d="M210 125l2 4 4 1-3 3 1 4-4-2-4 2 1-4-3-3 4-1z" opacity=".4"/>
      </g>
    </svg>
  </div>

  <h4 class="empty-title">No playlisting activity found</h4>
  <p class="pl-empty__msg">
    Your tracks havenâ€™t been featured on any Spotify playlists yet.
    Try promoting your top tracks or connect Spotify to update data.
  </p>

  <div class="empty-actions">
    <a class="btn" href="/faq/playlisting" target="_blank" rel="noopener">Read guide</a>
    <button type="button" class="btn" id="plRetry">Retry</button>
    <a class="btn primary" id="plConnect" href="/settings/integrations?connect=spotify" style="display:none">Connect Spotify</a>
  </div>
</div>

</section>


  <section id="tab-social" class="card hidden" aria-hidden="true"><div style="color:var(--muted)">Social view coming soonâ€¦</div></section>
</div>

<div class="ae-overlay" id="aeOverlay"></div>
<div class="ae-modal" id="aeModal" aria-hidden="true">
  <div class="ae-card" role="dialog" aria-modal="true" aria-labelledby="aeTitle">

   <!-- Header with banner + avatar + name like screenshot -->
<div class="ae-head">
  <img class="ae-banner" src="<?= $this->basePath('/public/img/icons/banner.png') ?>" alt="">
  <div class="ae-toprow">
    <img class="ae-avatar" id="aeAvatar" src="<?= $this->basePath('/public/img/users.png') ?>" alt="">
    <div class="ae-name-wrap">
      <div class="ae-name" id="aeTitle">Artist</div>
      <div class="ae-pills">
        <span class="ae-pill">Artist</span>
        <span class="ae-pill" id="aeCountryPill">Country: â€”</span>
        <span class="ae-pill" id="aeFollowersPill">Followers: â€”</span>
        <span class="ae-pill" id="aePopularityPill">Popularity: â€”</span>
      </div>
    </div>
  </div>
</div>

<form id="aeForm">
  <div class="ae-body">
    <input type="hidden" name="id" id="ea_id">

    <!-- (A) Basic two fields -->
    <div class="ae-grid">
      <div class="ae-field">
        <label class="ae-label">Artist Name</label>
        <input class="ae-input" id="ea_name" name="name" readonly>
      </div>
      <div class="ae-field">
        <label class="ae-label">Country</label>
        <input class="ae-input" id="ea_country" name="country" placeholder="IN / US / GB â€¦">
      </div>
    </div>

    <!-- (B) IDs row â€” popularity field REMOVED -->
    <div class="ae-row" style="margin-top:12px;grid-template-columns:1fr 1fr">
      <div class="ae-field">
        <label class="ae-label">Spotify ID / URL</label>
        <input class="ae-input" id="ea_spotify" name="spotify_id" placeholder="37i9dQZ... or full URL">
      </div>
      <div class="ae-field">
        <label class="ae-label">Apple ID / URL</label>
        <input class="ae-input" id="ea_apple" name="apple_id" placeholder="203709341 or full URL">
      </div>
    </div>

    <!-- (C) Social links row â€” followers field REMOVED -->
    <div class="ae-row" style="margin-top:12px;grid-template-columns:1fr 1fr">
      <div class="ae-field">
        <label class="ae-label ae-muted">Social Links</label>
        <input class="ae-input" value="Auto from IDs" readonly>
      </div>
      <div class="ae-field">
        <label class="ae-label ae-muted">â€”</label>
        <input class="ae-input" value="â€”" readonly>
      </div>
    </div>

    <!-- (D) Bio -->
    <div class="ae-field" style="margin-top:12px">
      <label class="ae-label">Artist Bio</label>
      <textarea class="ae-text" id="ea_bio" name="bio" placeholder="Write a short artist biographyâ€¦"></textarea>
    </div>

    <!-- Hidden fields so backend ko same data mile (visible fields remove kiye gaye) -->
    <input type="hidden" id="ea_followers"  name="followers">
    <input type="hidden" id="ea_popularity" name="popularity">
  </div>

  <div class="ae-foot">
    <button type="button" class="ae-btn" id="aeCancel">Cancel</button>
    <button type="submit" class="ae-btn primary" id="aeSave">Save Changes</button>
  </div>
</form>

  </div>
</div>

<script>
// ---------- tabs & first paint (CLEAN) ----------
(function(){
  // show active section on first paint
  const activeBtn = document.querySelector('.tabbar .tab.active');
  if (activeBtn) {
    const id = 'tab-' + activeBtn.dataset.tab;
    const sec = document.getElementById(id);
    if (sec) { sec.classList.remove('hidden'); sec.setAttribute('aria-hidden','false'); }
  }

  // click -> switch section
  document.querySelectorAll('.tabbar .tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tabbar .tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id='tab-'+btn.dataset.tab;
      document.querySelectorAll('section[id^="tab-"]').forEach(s=>{
        const on = (s.id===id);
        s.classList.toggle('hidden', !on);
        s.setAttribute('aria-hidden', on ? 'false':'true');
      });
    });
  });
})();
</script>


<style>
  /* â€”â€”â€” overlay */
  .ae-overlay{
    position:fixed; inset:0;
    background:rgba(15,23,42,.45);
    display:none; z-index:9990;
  }
  .ae-overlay.show{ display:block; }

  /* â€”â€”â€” modal (single definition; no duplicates) */
  .ae-modal{
    position:fixed; inset:0;
    display:none;                 /* hidden by default */
    place-items:center;
    pointer-events:none;
    z-index:9991;
    /* iPad safe-area padding so card never touches bars */
    padding: max(12px, env(safe-area-inset-top)) 12px
             max(12px, env(safe-area-inset-bottom)) 12px;
  }
  .ae-modal.show{
    display:grid;
    pointer-events:auto;
  }

  /* card: clamp height to viewport; body scrolls inside */
  .ae-card{
    width:min(680px,92vw);
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:18px;
    box-shadow:0 24px 60px rgba(15,23,42,.18);
    overflow:hidden;
    display:flex;                 /* <- column layout */
    flex-direction:column;
    max-height:88svh;             /* iPad-friendly viewport */
  }

  .ae-head{position:relative;height:140px;margin:8px;background:linear-gradient(180deg,#f4f6fb,#e9eefc)}
  .ae-banner{position:absolute;inset:0;object-fit:cover;width:100%;height:100%;border-radius:15px}
  .ae-toprow{align-items:center;gap:12px;position:absolute;left:20px;bottom:-80px}
  .ae-avatar{width:95px;height:95px;border-radius:999px;border:3px solid #fff;object-fit:cover;box-shadow:0 6px 24px rgba(0,0,0,.18)}
  .ae-name-wrap{display:flex;flex-direction:column}
  .ae-name{font:800 20px/1.2 Inter,system-ui;color:#0f172a;display:flex;align-items:center;gap:8px}
  .ae-verified{display:inline-flex;width:18px;height:18px}
  .ae-pills{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
  .ae-pill{font:700 10px/1 Inter;background:#f3f4f6;border:1px solid #e5e7eb;color:#475569;padding:6px 10px;border-radius:9999px}

  /* body scrolls; footer sticks */
  .ae-body{
    padding:100px 20px 18px;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    flex:1 1 auto;
  }
  .ae-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .ae-field{display:flex;flex-direction:column;gap:6px}
  .ae-label{font:700 12px/1 Inter;color:#6b7280}
  .ae-input,.ae-text{width:100%;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font:600 13px/1.3 Inter;color:#0f172a;padding:10px 12px}
  .ae-input[readonly]{background:#f8fafc;color:#64748b}
  .ae-text{min-height:92px;resize:vertical}
  .ae-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .ae-muted{color:#94a3b8}

  .ae-foot{
    display:flex;justify-content:flex-end;gap:10px;
    padding:12px 20px;border-top:1px solid #eef2f7;background:#fafafa;
    flex:0 0 auto;
  }
  .ae-btn{padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font:800 13px/1 Inter;color:#0f172a;cursor:pointer}
  .ae-btn.primary{background:#111827;color:#fff;border-color:#111827}
  .ae-btn:disabled{opacity:.6;pointer-events:none}

  @media (max-width:820px){
    .ae-toprow{ bottom:-72px; } /* slight lift on iPad widths */
  }
  @media (max-width:640px){
    .ae-grid,.ae-row{grid-template-columns:1fr}
    .ae-toprow{left:16px}
  }
</style>

<script>
(function () {
  var overlay = document.getElementById('aeOverlay');
  var modal   = document.getElementById('aeModal');
  var btnCancel = document.getElementById('aeCancel');

  // start closed
  overlay && overlay.classList.remove('show');
  modal   && modal.classList.remove('show');
  modal   && modal.setAttribute('aria-hidden', 'true');

  // expose helpers
  window.aeShow = function(){
    if (!overlay || !modal) return;
    overlay.classList.add('show');
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
  };
  window.aeHide = function(){
    if (!overlay || !modal) return;
    overlay.classList.remove('show');
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
  };

  // close handlers
  overlay && overlay.addEventListener('click', window.aeHide);
  btnCancel && btnCancel.addEventListener('click', window.aeHide);
})();
</script>

<script>
window.aePrefill = function(p){
  p = p || {};

  // header
  document.getElementById('aeTitle').textContent = p.name || 'Artist';
  document.getElementById('aeCountryPill').textContent   = 'Country: '   + (p.country || 'â€”');
  if (p.image_url) document.getElementById('aeAvatar').src = p.image_url;

  // pills
  const followersVal  = (p.followers ?? '') === '' ? 'â€”' : Number(p.followers||0).toLocaleString();
  const popularityVal = (p.popularity ?? '') === '' ? 'â€”' : p.popularity;

  const fPill = document.getElementById('aeFollowersPill');
  const pPill = document.getElementById('aePopularityPill');
  if (fPill) fPill.textContent = 'Followers: ' + followersVal;
  if (pPill) pPill.textContent = 'Popularity: ' + popularityVal;

  // form fields
  const set = (id, v)=>{ const el=document.getElementById(id); if(el) el.value = (v ?? ''); };
  set('ea_id',      p.id);
  set('ea_name',    p.name);
  set('ea_country', p.country);
  set('ea_spotify', p.spotify_id);
  set('ea_apple',   p.apple_id);
  set('ea_bio',     p.bio);

  // hidden (backend compatibility)
  set('ea_followers',  p.followers);
  set('ea_popularity', p.popularity);
};
</script>

<script>
(function(){
  if (window.__AE_CLICK_BOUND) return; window.__AE_CLICK_BOUND = true;

  function parsePayload(el){
    try { return JSON.parse(el.getAttribute('data-artist') || '{}'); }
    catch(e){ return {}; }
  }

  document.addEventListener('click', function(ev){
    const btn = ev.target.closest('.js-open-artist-edit');
    if (!btn) return;

    ev.preventDefault();
    ev.stopImmediatePropagation();
    ev.stopPropagation();

    if (btn.tagName === 'A') btn.setAttribute('href', '#');

    const payload = parsePayload(btn);
    if (window.aePrefill) window.aePrefill(payload);
    if (window.aeShow)    window.aeShow();
  }, true);
})();
</script>

<script>
  // ---- API endpoints (adjust to your route names) ----
  const AE_SAVE_URL = "<?= $this->url('analytics-artist-save') ?: $this->url('artists', ['action'=>'save']) ?>";

  // helper: get value
const gv = id => {
  const el = document.getElementById(id);
  if (!el) return '';
  const v = el.value;
  return (v === undefined || v === null) ? '' : String(v).trim();
};

   (function bindAeSubmit(){
    const form = document.getElementById('aeForm');
    const btn  = document.getElementById('aeSave');
    if (!form || !btn) return;

    const gv = id => {
      const el = document.getElementById(id);
      if (!el) return '';
      const v = el.value;
      return (v === undefined || v === null) ? '' : String(v).trim();
    };

    form.addEventListener('submit', async function(e){
      e.preventDefault();

      const payload = {
        id:         gv('ea_id'),
        name:       gv('ea_name'),
        country:    gv('ea_country'),
        spotify_id: gv('ea_spotify'),
        apple_id:   gv('ea_apple'),
        followers:  gv('ea_followers'),
        popularity: gv('ea_popularity'),
        bio:        gv('ea_bio')
      };

      const oldTxt = btn.textContent;
      btn.textContent = 'Saving...';
      btn.disabled = true;

      try{
        const res = await fetch(AE_SAVE_URL, {
          method:'POST',
          headers:{
            'X-Requested-With':'XMLHttpRequest',
            'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'
          },
          body:new URLSearchParams(payload)
        });

        const json = await res.json();

        if(!json.ok){
          alert(json.error || 'Save failed');
        }else{
          if (window.aeHide) aeHide();
          const u = new URL(window.location.href);
          u.searchParams.set('t', Date.now());
          window.location.replace(u.toString());
          return;
        }
      }catch(err){
        console.error(err);
        alert('Network error while saving');
      }finally{
        btn.textContent = oldTxt;
        btn.disabled = false;
      }
    });
  })();
</script>

<script>
(function(){
  const $ = sel => document.querySelector(sel);

  const container = document.querySelector('[data-artist]');
  if (!container) return;
  const ARTIST_ID = parseInt(container.getAttribute('data-artist') || '0', 10) || 0;

  // endpoints
  const STREAM_URL   = '/analytics/stream-playlists';   // Featured On (playlists)
  const TOP_URL      = '/analytics/stream-toptracks';   // Top Tracks (tracks)

  // Featured On els
  const elLoader = $('#plLoader');
  const elGrid   = $('#plGrid');
  const elEmpty  = $('#plEmpty');
  const elError  = $('#plError');

  // Top Tracks els
  const ttLoader = $('#ttLoader');
  const ttList   = $('#ttList');
  const ttEmpty  = $('#ttEmpty');
  const ttError  = $('#ttError');

  // debug passthrough (optional)
  const PAGE_DEBUG = new URLSearchParams(location.search).get('debug') === '1';

  let playlistsLoaded = false;
  let topLoaded       = false;

  const safe = (el, fn) => { if (el) { try { fn(el); } catch(_) {} } };

  // ====== Featured On (Playlists) ======
  function showPlState({loading=false, empty=false, error=false}){
    safe(elLoader, el => el.style.display = loading ? '' : 'none');
    safe(elGrid,   el => el.hidden       = !!(loading || empty || error));
    safe(elEmpty,  el => el.hidden       = !empty);
    safe(elError,  el => el.hidden       = !error);
  }
  function setPlError(text){
    safe(elError, el => { el.textContent = text; });
    showPlState({error:true});
  }
  function plCardTpl(row){
    const img   = row.image || 'https://picsum.photos/seed/playlist_'+encodeURIComponent(row.id||Math.random())+'/400/400';
    const name  = row.name  || 'Untitled Playlist';
    const owner = row.owner || 'â€”';
    const cnt   = (row.tracks||0);
    const url   = row.spotify_url || '#';
    const hasScore = (row.score !== undefined && row.score !== null && !isNaN(row.score));
    const badge = (row.related && hasScore) ? `<span class="chip" style="margin-left:auto">Related â€¢ ${Math.round(Number(row.score))}%</span>` : '';
    return `
      <article class="pl-card" title="${name.replace(/"/g,'&quot;')}">
        <img class="pl-cover" src="${img}" alt="">
        <div class="pl-body">
          <div class="pl-name"><span>${name}</span>${badge}</div>
          <div class="pl-meta"><span>Owner: ${owner}</span><span>â€¢</span><span>${cnt} tracks</span></div>
        </div>
        <div class="pl-foot"><a class="pl-open" href="${url}" target="_blank" rel="noopener">Open in Spotify</a></div>
      </article>
    `;
  }
  async function parseJsonSafe(res){
    try { return await res.clone().json(); } catch(_){}
    const text = await res.text();
    if (res.redirected || /<\s*html/i.test(text)) return { __redirect__: true, __html__: text, status: res.status };
    try { return JSON.parse(text); } catch(_){ return { __raw__: text, status: res.status }; }
  }
  async function loadFeaturedOn(){
    if (ARTIST_ID <= 0){ setPlError('Artist ID missing (data-artist is 0).'); return; }

    const u = new URL(STREAM_URL, window.location.origin);
    u.searchParams.set('artist_id',           String(ARTIST_ID));
    u.searchParams.set('verify',              '1');          // deep track scan
    u.searchParams.set('only_related',        '1');          // only playlists that include this artist
    u.searchParams.set('require_full_name',   '1');          // full-name equality (strict)
    u.searchParams.set('owner_mode',          'prefer_spotify');
    u.searchParams.set('per_playlist_tracks', '150');
    u.searchParams.set('max_playlists',       '36');
    u.searchParams.set('market',              'GLOBAL');
    u.searchParams.set('_',                   Date.now());
    if (PAGE_DEBUG) u.searchParams.set('debug','1');

    showPlState({loading:true});
    safe(elGrid, el => el.innerHTML='');

    try{
      const res  = await fetch(u.toString(), {
        headers:{ 'X-Requested-With':'XMLHttpRequest', 'Accept':'application/json' },
        credentials: 'same-origin'
      });
      const json = await parseJsonSafe(res);

      if (json?.__redirect__ || res.status === 302) { return setPlError('Session redirect detected. Please log in again.'); }
      if (res.status === 401 || json?.error === 'unauthorized' || json?.error === 'no_token' || json?.error?.message === 'No token provided') {
        return setPlError('Spotify token missing/expired. Connect or refresh your Spotify token.');
      }
      if (json?.note === 'no_token') { return setPlError('Spotify token not configured. Connect Spotify to fetch playlists.'); }
      if (json?.error === 'missing_artist_id') { return setPlError('Backend says: missing_artist_id.'); }
      if (json?.error === 'artist_not_found')   { return setPlError('Artist not found in DB.'); }

      if (!json || json.ok !== true || !Array.isArray(json.rows)){
        if (json?.note){
          const reason = (json.note.reason || json.note).toString().replace(/[_-]/g,' ');
          return setPlError('No playlists. Reason: ' + reason.toUpperCase());
        }
        return setPlError(json?.error || 'Endpoint did not return valid JSON.');
      }

      if (!json.rows.length){
  const reason = json?.note?.reason ? (' Reason: ' + String(json.note.reason).replace(/[_-]/g,' ')) : '';
  if (elEmpty){
    const msg = elEmpty.querySelector('.pl-empty__msg');
    if (msg) msg.textContent = 'No playlists found featuring this artist.' + reason;
  }
  showPlState({empty:true});
  return;
}


      safe(elGrid, el => el.innerHTML = json.rows.map(plCardTpl).join(''));
      showPlState({loading:false});
      playlistsLoaded = true;
    }catch(err){
      console.error('Featured On load error', err);
      setPlError('Network error while loading playlists.');
    }
  }

  // ====== Top Tracks (with direct play) â€” GRID RENDER (ADDED) ======
  function showTtState({loading=false, empty=false, error=false}){
    safe(ttLoader, el => el.style.display = loading ? '' : 'none');
    safe(ttList,   el => el.hidden       = !!(loading || empty || error));
    safe(ttEmpty,  el => el.hidden       = !empty);
    safe(ttError,  el => el.hidden       = !error);
  }
  const pick = (o,p)=>p.split('.').reduce((x,k)=>x&&x[k],o);
  const dur  = (ms)=>{ const s=Math.max(0,Math.round((+ms||0)/1000)); const m=Math.floor(s/60), r=s%60; return `${m}:${String(r).padStart(2,'0')}`; };
 const cover = (t) =>
  t.album?.image || t.image || t.cover || t.album_image ||
  (t.album?.images?.[0]?.url) ||
  (t.track?.album?.images?.[0]?.url) ||
  `https://picsum.photos/seed/track_${encodeURIComponent(t.id||Math.random())}/300/300`;


  // NEW: card template for grid
  function ttCardTpl(t,i){
    const id   = t.id || pick(t,'track.id') || `row_${i}`;
    const name = t.name || pick(t,'track.name') || 'Untitled';
    const artists = Array.isArray(t.artists) ? t.artists.join(', ')
                   : (t.artist || pick(t,'track.artists.0.name') || '');
    const url  = t.url || t.spotify_url || pick(t,'external_urls.spotify') || (pick(t,'track.id') ? `https://open.spotify.com/track/${pick(t,'track.id')}` : '#');
    const preview = t.preview_url || pick(t,'track.preview_url') || '';
    const d    = t.duration_ms || pick(t,'track.duration_ms');
     const album     = t.album || {}; // backend se aa raha hai
  const typeLabel = album.type_label || t.album_type_label || ''
 const typeClass = (album.type === 'single' && typeLabel === 'EP') ? 'ep'
                    : (album.type === 'album' ? 'album'
                    : (album.type === 'single' ? 'single' : ''));
    return `
      <article class="tt-card" data-track="${id}">
        <div class="tt-cover-wrap">
          <img class="tt-cover" src="${cover(t)}" alt="">
          ${preview ? `<button class="tt-play" data-audio="${preview}" aria-pressed="false">Play</button>` : ``}
        </div>
        <div class="tt-body">
          <div class="tt-name" title="${name.replace(/"/g,'&quot;')}">${name} </div>
          <div class="tt-artist" title="${(artists||'').replace(/"/g,'&quot;')}">${artists||'â€”'}- ${typeLabel ? `<span class="pill ${typeClass}">${typeLabel}</span>` : ``}</div>
        </div>
        <div class="tt-foot">
          <div class="tt-dur">${d?dur(d):'0:00'}</div>
          <a class="tt-open" href="${url}" target="_blank" rel="noopener">Open</a>
        </div>
      </article>`;
  }

  async function loadTopTracks(){
    if (ARTIST_ID <= 0){ if (ttError) ttError.textContent = 'Artist ID missing.'; return showTtState({error:true}); }
    showTtState({loading:true}); if (ttList) ttList.innerHTML = '';

    const u=new URL(TOP_URL,location.origin);
    u.searchParams.set('artist_id',String(ARTIST_ID));
    u.searchParams.set('limit','12'); // grid fill
    u.searchParams.set('_',Date.now());
    if (PAGE_DEBUG) u.searchParams.set('debug','1');

    try{
      const r=await fetch(u.toString(),{headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'},credentials:'same-origin'});
      const j=await parseJsonSafe(r);

      if (r.status===401 || j?.error==='unauthorized' || j?.error?.message==='No token provided'){ if(ttError) ttError.textContent='Spotify token missing/expired.'; return showTtState({error:true}); }
      if (!j || j.ok!==true || !Array.isArray(j.rows)){ if(ttError) ttError.textContent=j?.error||'Endpoint did not return valid JSON.'; return showTtState({error:true}); }
      if (!j.rows.length) return showTtState({empty:true});

      const cards = j.rows.map(ttCardTpl).join('');
      if (ttList) ttList.innerHTML = `<div class="tt-grid">${cards}</div>`;
      showTtState({loading:false});
      topLoaded = true;
    }catch(e){
      console.error('Top Tracks load error', e);
      if (ttError) ttError.textContent = 'Network error while loading top tracks.';
      showTtState({error:true});
    }
  }

  // single shared audio player for Play/Pause
  let audio = document.getElementById('ttAudio');
  if (!audio){
    audio = document.createElement('audio');
    audio.id = 'ttAudio';
    audio.preload = 'none';
    document.body.appendChild(audio);
  }
  let currentBtn = null;
  function resetPlays(){
    document.querySelectorAll('.tt-play[aria-pressed="true"]').forEach(b=>{
      b.setAttribute('aria-pressed','false'); b.textContent='Play';
    });
  }
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tt-play');
    if (!btn) return;
    const src = btn.getAttribute('data-audio') || '';
    if (!src) return;

    if (currentBtn === btn && !audio.paused){
      audio.pause();
      btn.setAttribute('aria-pressed','false');
      btn.textContent='Play';
      return;
    }
    resetPlays();
    currentBtn = btn;
    btn.setAttribute('aria-pressed','true');
    btn.textContent='Pause';
    if (audio.src !== src) audio.src = src;
    audio.play().catch(()=>{ btn.setAttribute('aria-pressed','false'); btn.textContent='Play'; });
  });
  audio.addEventListener('ended', ()=>{ if(currentBtn){ currentBtn.setAttribute('aria-pressed','false'); currentBtn.textContent='Play'; }});
  audio.addEventListener('pause', ()=>{ if(currentBtn){ currentBtn.setAttribute('aria-pressed','false'); currentBtn.textContent='Play'; }});

  // ====== Tab triggers ======
  function ensureLoads(id){
    if (id==='tab-playlists'){
      if (!topLoaded)       loadTopTracks();
      if (!playlistsLoaded) loadFeaturedOn();
    }
  }
  document.querySelectorAll('.tabbar .tab').forEach(btn=>{
    btn.addEventListener('click', ()=> ensureLoads('tab-'+btn.dataset.tab));
  });

  // If Playlists is already active on first paint
  if (document.querySelector('.tabbar .tab.active')?.dataset.tab === 'playlists') {
    ensureLoads('tab-playlists');
  }
})();
</script>
