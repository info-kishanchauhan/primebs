<?php
$taxData          = $this->taxInfo ?? null;
$taxCountryVal    = $taxData['tax_country']      ?? '';
$taxProfileVal    = $taxData['tax_profile_type'] ?? 'individual';
$taxPanFullName   = $taxData['pan_full_name']    ?? '';
$taxPanNumber     = $taxData['pan_number']       ?? '';
$taxAddress       = $taxData['address']          ?? '';
$taxState         = $taxData['state']            ?? '';
$taxPincode       = $taxData['pincode']          ?? '';
$taxBusinessName  = $taxData['business_name']    ?? '';
$taxGstin         = $taxData['gstin']            ?? '';
$taxCompanyPan    = $taxData['company_pan']      ?? '';
$taxCompanyAddress= $taxData['company_address']  ?? '';
$taxCompanyState  = $taxData['company_state']    ?? '';
$taxCompanyPincode= $taxData['company_pincode']  ?? '';
?>

<?php
$isAdmin = ($_SESSION['STAFFUSER'] == '1' || $_SESSION['user_id'] == 0);

$methodRaw = strtolower(trim($this->user['payment_method'] ?? ''));

if (strpos($methodRaw, 'payoneer') !== false) {
  $method = 'payoneer';
} elseif (strpos($methodRaw, 'paypal') !== false) {
  $method = 'paypal';
} elseif (strpos($methodRaw, 'bank') !== false || strpos($methodRaw, 'transfer') !== false) {
  // cover 'bank transfer' / 'manual transfer' / 'banktransfer'
  $method = 'bank';
} else {
  $method = '';
}


$submitted = isset($this->submitted) ? $this->submitted : false;


$status = $submitted ? strtolower($this->payoutData['status']) : null;

function label($text, $tooltip = '') {
  return '<div class="field-label">' . htmlspecialchars($text) .
         ($tooltip ? '<span class="tooltip-icon" data-tooltip="' . htmlspecialchars($tooltip) . '">?</span>' : '') .
         '</div>';
}

function boxedField($label, $value) {
  return '<div class="field-box">
            <div class="field-label">'.htmlspecialchars($label).'</div>
            <div class="field-value">'.htmlspecialchars($value).'</div>
          </div>';
}

?>


<style>
  .profile-container { max-width: 1200px; margin: 60px auto; background: white; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); padding: 40px 50px; font-family: 'Inter', sans-serif; }
  .profile-header { display: flex; align-items: center; margin-bottom: 30px; }
  .profile-container.admin-profile {
  max-width: 1500px;
}
  .profile-avatar { width: 60px; height: 60px; background-color: #6b44cb; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600; margin-right: 20px; }
  .form-section input, .form-section select, .form-section textarea { width: 100%; padding: 10px; margin-top: 5px; border-radius: 6px; border: 1px solid #d1d5db; margin-bottom: 15px; }
  .status-block { background: #f9fafb; border-left: 4px solid #cbd5e1; padding: 15px; margin-top: 30px; border-radius: 8px; font-size: 14px; color: #1e293b; }
  .status-active { background: #dcfce7; color: #166534; }
  .status-rejected { background: #fee2e2; color: #991b1b; }
  .admin-controls { margin-top: 40px; padding: 20px; border-top: 1px dashed #ccc; }
  .field-box { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px 16px; margin-bottom: 15px; }
  .field-label { font-size: 13px; color: #6b7280; margin-bottom: 4px; }
  .field-value { font-weight: 500; font-size: 15px; color: #111827; }
</style>
<!-- TOOLTIP STYLE (Put this once on top in your layout or page) -->
<style>
.tooltip-icon {
  display: inline-block;
  width: 18px;
  height: 18px;
  background-color: #f8fafc;
  color: #1e293b;
  font-size: 12px;
  font-weight: bold;
  border-radius: 50%;
  text-align: center;
  line-height: 18px;
  cursor: help;
  margin-left: 6px;
  position: relative;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.tooltip-icon:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  background: #ffffff;
  color: #1e293b;
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 6px;
  white-space: nowrap;
  z-index: 1000;
  box-shadow: 0 4px 14px rgba(0,0,0,0.12);
}
.tooltip-icon:hover::before {
  content: '';
  position: absolute;
  bottom: 115%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: #ffffff;
}
  
    #bs-main {
  background-color: #f7f7f8 !important;
}
</style>
<style>
.field-label {
  font-weight: 600;
  display: flex;
  align-items: center;
  margin-top: 18px;
  font-family: 'Inter', sans-serif;
}

.tooltip-icon {
  margin-left: 6px;
  background: #0087f5;
  color: #ffffff;
  font-size: 12px;
  font-weight: bold;
  width: 15px;
  height: 15px;
  text-align: center;
  border-radius: 50%;
  line-height: 16px;
  cursor: pointer;
  position: relative;
}

.tooltip-icon:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  top: -38px;
  left: 50%;
  transform: translateX(-50%);
  background: #111;
  color: #fff;
  padding: 6px 10px;
  font-size: 12px;
  white-space: nowrap;
  border-radius: 6px;
  z-index: 1000;
  white-space: nowrap;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
</style>


<!-- DARK INFO HEADER BLOCK -->
<?php
$status = strtolower($this->payoutData['status'] ?? '');
$showInfoBlock = ($_SESSION['STAFFUSER'] != '1' && $_SESSION['user_id'] != 0); // User only

if ($showInfoBlock):
  
  $countryCode = strtolower(trim($this->user['isoCountry'] ?? ''));
  $flagPath = $this->basePath() . '/img/flags/' . $countryCode . '.png';
  $currency = $this->user['currency'] ?? 'EURO';
  $accountType = !empty($this->user['user_type']) ? $this->user['user_type'] : '‚Äî';
  $companyName = !empty($this->user['company_name']) ? $this->user['company_name'] : 'Not Provided';
?>
  <div style="
    display: flex;
    flex-wrap: wrap;
    gap: 28px;
    justify-content: space-between;
    align-items: flex-start;
    background: linear-gradient(135deg, #1f2937 0%, #2b3552 100%);
    color: #f8fafc;
    padding: 24px 32px;
    border-radius: 5px;
    margin-bottom: 0;
    font-family: 'Inter', sans-serif;
    box-shadow: 0 10px 28px rgba(0, 0, 0, 0.12);
    transition: all 0.3s ease;
  ">
    <!-- Payment Method -->
    <div style="flex: 1; min-width: 200px;">
      <div style="font-size: 13px; color: #cbd5e1; margin-bottom: 4px;">Payment Method</div>
      <div style="font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
        <?= ucfirst($method) ?>
        <?php if ($method === 'payoneer'): ?>
  <span style="background:#fff;padding:2px 4px;border-radius:4px;display:inline-flex;align-items:center;">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Payoneer_logo.svg/512px-Payoneer_logo.svg.png" alt="Payoneer" style="height:14px;">
  </span>

        <?php elseif ($method === 'paypal'): ?>
  <span style="background:#fff;padding:2px 4px;border-radius:4px;display:inline-flex;align-items:center;">
    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" style="height:14px;">
  </span>

        <?php elseif ($method === 'bank'): ?>
  <span style="background:#fff;padding:2px;border-radius:4px;display:inline-flex;align-items:center;">
    <img src="https://www.svgrepo.com/show/132764/bank-transfer-logo.svg" alt="Bank" style="height:14px;">
  </span>

        <?php endif; ?>
        <span class="tooltip-icon" data-tooltip="You‚Äôll be paid via this method.">?</span>
      </div>
    </div>

    <!-- Company Name -->
    <div style="flex: 1; min-width: 200px;">
      <div style="font-size: 13px; color: #cbd5e1; margin-bottom: 4px;">Account Name</div>
      <div style="font-size: 16px; font-weight: 600; display: flex; align-items: center;">
        <?= htmlspecialchars($companyName) ?>
        <span class="tooltip-icon" data-tooltip="Your Label/band Name.">?</span>
      </div>
    </div>

    <!-- Account ID -->
    <div style="flex: 1; min-width: 200px;">
      <div style="font-size: 13px; color: #cbd5e1; margin-bottom: 4px;">Account ID</div>
      <div style="font-size: 16px; font-weight: 600; display: flex; align-items: center;">
        PDA|<?= str_pad($_SESSION['user_id'], 5, '0', STR_PAD_LEFT) ?>
        <span class="tooltip-icon" data-tooltip="Your unique system ID used in support and payouts.">?</span>
      </div>
    </div>

  <?php
$countryCode = strtolower(trim($this->user['isoCountry'] ?? ''));
$countryMap = [
  'in' => 'India',
  'us' => 'United States',
  'pk' => 'Pakistan',
  'gb' => 'United Kingdom',
  'fr' => 'France',
  'de' => 'Germany',
  'bd' => 'Bangladesh',
  'ca' => 'Canada',
  'ae' => 'United Arab Emirates',
  'sa' => 'Saudi Arabia'
];
$countryFullName = $countryMap[$countryCode] ?? strtoupper($countryCode);

// ‚úÖ Force full image URL ‚Äî no basePath, no assumptions
$flagUrl = 'http://www.primebackstage.in/public/img/flags/' . $countryCode . '.png';
?>
<div style="flex: 1; min-width: 200px;">
  <div style="font-size: 13px; color: #cbd5e1; margin-bottom: 4px;">Country</div>
  <div style="font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
    <?php if (!empty($countryCode)): ?>
      <img src="<?= $flagUrl ?>" alt="<?= $countryFullName ?>" style="height: 14px; border-radius: 2px;">
    <?php endif; ?>
    <?= htmlspecialchars($countryFullName) ?>
    <span class="tooltip-icon" data-tooltip="Based on your payout profile">?</span>
  </div>
</div>
    

    <!-- Account Type -->
    <div style="flex: 1; min-width: 200px;">
      <div style="font-size: 13px; color: #cbd5e1; margin-bottom: 4px;">Account Type</div>
      <div style="font-size: 16px; font-weight: 600; display: flex; align-items: center;">
        <?= htmlspecialchars($accountType) ?>
        <span class="tooltip-icon" data-tooltip="Shows if you‚Äôre Label/Artist/Enterprise.">?</span>
      </div>
    </div>

    <!-- Currency -->
    <div style="flex: 1; min-width: 200px;">
      <div style="font-size: 13px; color: #cbd5e1; margin-bottom: 4px;">Currency</div>
      <div style="font-size: 16px; font-weight: 600; display: flex; align-items: center;">
        <?= htmlspecialchars($currency) ?>
        <span class="tooltip-icon" data-tooltip="Your preferred currency for payout transactions.">?</span>
      </div>
    </div>
  </div>
<?php
$flagUrlPk = 'http://www.primebackstage.in/public/img/flags/pk.png';
?>


<?php endif; ?>

<div class="profile-container <?= $isAdmin ? 'admin-profile' : '' ?>">

  <div class="profile-header">
    <div class="profile-avatar">B</div>
    <div>
      <h2><?= $isAdmin ? 'User Requests' : 'Banking & Tax' ?></h2>
      <p><?= $isAdmin ? 'Review and manage users requests' : 'Manage your payout method and tax information' ?></p>

    </div>
  </div>


  <!-- UI Tabs Styled like Backstage -->
  <div class="toggle-tabs">
    <div id="tab-banking" class="tab active" onclick="switchTab('banking')">Bank Details</div>
    <div id="tab-tax" class="tab" onclick="switchTab('tax')">Tax Information</div>
  </div>

  <!-- Banking Section -->
  <div id="banking-section" class="tab-section">
  <?php if ((!$submitted || $isResubmitting) && !$isAdmin): ?>
  
  <?php if (!$submitted && !$isAdmin): ?>


    <!-- Notice block -->
    
    <div id="noPayoutWarning" style="background: #f9fafb; border: 1px solid #dbeafe; padding: 30px; border-radius: 16px; margin-bottom: 30px; display: flex; align-items: center; gap: 20px;">
  <video autoplay muted loop playsinline style="width: 90px; height: auto; border-radius: 7px;">
    <source src="https://cdn-icons-mp4.flaticon.com/512/16104/16104537.mp4" type="video/mp4">
    <img src="https://cdn-icons-png.flaticon.com/512/16104/16104537.png" alt="Add Details">
  </video>

  <div style="flex-grow:1;">
    <h3 style="margin:0 0 10px; color:#1e3a8a;">üëã You haven‚Äôt added your payout details yet</h3>
    <p style="margin: 0 0 15px; color: #475569;">Add your payout method below to activate your account for withdrawals.</p>
    <button onclick="showPayoutForm()" style="background:#3b82f6; color:white; padding:10px 20px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">+ Add Payout Details</button>
  </div>
</div>

    <!-- Visual Steps -->
<?php if ($method === 'payoneer' || $method === 'paypal' || $method === 'bank'): ?>
  <div id="howItWorks" style="background:  margin-bottom: 40px; font-family: 'Inter', sans-serif; box-shadow: 0 8px 24px rgba(0,0,0,0.03);">
    <div class="payoneer-guide">

     <?php if ($method === 'payoneer'): ?>
  <div class="payoneer-guide" style="background: #eff6ff; border-radius: 16px; padding: 30px 40px; margin-bottom: 40px; font-family: 'Inter', sans-serif; box-shadow: 0 6px 24px rgba(0,0,0,0.05); font-size: 15px; line-height: 1.65; color: #1e293b;">
    <h3 class="payoneer-title" style="font-size: 20px; color: #111827; margin-bottom: 16px;">üì© Request Payments in an Instant</h3>
    <p style="margin-bottom: 20px;">
      Getting paid by your global clients should be easy‚Äîno matter where they‚Äôre from.
      Requesting a payment with Payoneer takes only a few clicks and lets you track it every step of the way.
    </p>

    <div class="payoneer-steps">
      <div class="step" style="display:flex; gap:20px; margin-bottom: 18px;">
        <div class="step-number" style="font-size:18px; font-weight:700; color:#3b82f6; width:30px;">01</div>
        <div>
          <strong>Create a Payoneer Account</strong>
          <p style="margin:6px 0;">
            If you don‚Äôt have a Payoneer account yet, create one using the link below:
          </p>
          <p><a href="https://payouts.payoneer.com/partners/or.aspx?pid=YOYIZC74IO2s4KZQp7tgsw%3d%3d" target="_blank" style="color:#3b82f6;font-weight:600;text-decoration:underline;">Click here to create a Payoneer Account ‚Üí</a></p>
        </div>
      </div>

      <div class="step" style="display:flex; gap:20px; margin-bottom: 18px;">
        <div class="step-number" style="font-size:18px; font-weight:700; color:#3b82f6; width:30px;">02</div>
        <div>
          <strong>Pick Your Payer</strong>
          <p style="margin:6px 0;">Go to <strong>"Request a payment"</strong> and select or add a client.</p>
        </div>
      </div>

      <div class="step" style="display:flex; gap:20px; margin-bottom: 18px;">
        <div class="step-number" style="font-size:18px; font-weight:700; color:#3b82f6; width:30px;">03</div>
        <div>
          <strong>Input Invoice Details</strong>
          <p style="margin:6px 0;">Enter amount, currency, due date, and optionally add attachments.</p>
        </div>
      </div>

      <div class="step" style="display:flex; gap:20px;">
        <div class="step-number" style="font-size:18px; font-weight:700; color:#3b82f6; width:30px;">04</div>
        <div>
          <strong>Send & Track</strong>
          <p style="margin:6px 0;">Your client will receive the request by email and can pay instantly.</p>
        </div>
      </div>
    </div>

    <div style="margin-top: 24px; font-size: 14px;">
      <a href="https://www.payoneer.com/en-in/get-paid-by-clients/" target="_blank" class="payoneer-learn-btn" style="color:#15803d; font-weight: 500;">Learn More at Payoneer ‚Üí</a>
    </div>
  </div>

<?php elseif ($method === 'paypal'): ?>
  <div class="payoneer-guide" style="background: #eff6ff; border-radius: 16px; padding: 30px 40px; margin-bottom: 40px; font-family: 'Inter', sans-serif; box-shadow: 0 6px 24px rgba(0,0,0,0.05); font-size: 15px; line-height: 1.65; color: #1e293b;">
    <h3 class="payoneer-title" style="font-size: 20px; color: #111827; margin-bottom: 16px;">üí∏ How PayPal Payouts Work</h3>
    <p style="margin-bottom: 20px;">
      Once your PayPal email is added and verified, payments can be sent instantly to your account.
    </p>

    <div class="payoneer-steps">
      <div class="step" style="display:flex; gap:20px; margin-bottom: 18px;">
        <div class="step-number" style="font-size:18px; font-weight:700; color:#3b82f6; width:30px;">01</div>
        <div>
          <strong>Verify Your PayPal Email</strong>
          <p style="margin:6px 0;">Use an active, verified PayPal email ID to receive payments.</p>
        </div>
      </div>

      <div class="step" style="display:flex; gap:20px; margin-bottom: 18px;">
        <div class="step-number" style="font-size:18px; font-weight:700; color:#3b82f6; width:30px;">02</div>
        <div>
          <strong>Watch for Incoming Funds</strong>
          <p style="margin:6px 0;">You'll receive an email notification when payment is sent to your PayPal.</p>
        </div>
      </div>

      <div class="step" style="display:flex; gap:20px;">
        <div class="step-number" style="font-size:18px; font-weight:700; color:#3b82f6; width:30px;">03</div>
        <div>
          <strong>Withdraw Funds</strong>
          <p style="margin:6px 0;">You can transfer funds to your linked bank account or debit card.</p>
        </div>
      </div>
    </div>

    <div style="margin-top: 24px; font-size: 14px;">
      <a href="https://www.paypal.com/in/smarthelp/article/how-do-i-receive-payments-faq1750" target="_blank" class="payoneer-learn-btn" style="color:#15803d; font-weight: 500;">
        How to receive PayPal payments ‚Üí
      </a>
    </div>
  </div>


     <?php elseif ($method === 'bank'): ?>
  <div class="payoneer-guide" style="background: #eff6ff; border-radius: 16px; padding: 30px 40px; margin-bottom: 40px; font-family: 'Inter', sans-serif; box-shadow: 0 6px 24px rgba(0,0,0,0.05); font-size: 15px; line-height: 1.65; color: #1e293b;">
    <h3 class="payoneer-title" style="font-size: 20px; color: #111827; margin-bottom: 16px;">üè¶ How Bank Transfers Work</h3>

    <p style="margin-bottom: 20px;">
      If you‚Äôve selected <strong>Bank Transfer</strong> as your payout method, we will transfer funds directly to your bank account using NEFT, IMPS, RTGS (for India), or SWIFT (for international transfers).
    </p>

    <div class="payoneer-steps">
      <div class="step" style="display:flex; gap:20px; margin-bottom: 18px;">
        <div class="step-number" style="font-size:18px; font-weight:700; color:#3b82f6; width:30px;">01</div>
        <div>
          <strong>Add Your Bank Details</strong>
          <p style="margin: 6px 0 0;">
            Fill in your account number, account holder name, IFSC/SWIFT code, and bank name exactly as registered with your bank.
          </p>
          <p style="color:#475569; font-size:14px;">üîí All information is encrypted and securely stored.</p>
        </div>
      </div>

      <div class="step" style="display:flex; gap:20px; margin-bottom: 18px;">
        <div class="step-number" style="font-size:18px; font-weight:700; color:#3b82f6; width:30px;">02</div>
        <div>
          <strong>Verify Your Account</strong>
          <p style="margin: 6px 0 0;">
            We will send a small test deposit (e.g. ‚Çπ1 or $0.01) to confirm the account is valid.
            You‚Äôll need to enter the exact amount received to verify your account.
          </p>
        </div>
      </div>

      <div class="step" style="display:flex; gap:20px;">
        <div class="step-number" style="font-size:18px; font-weight:700; color:#3b82f6; width:30px;">03</div>
        <div>
          <strong>Receive Payments</strong>
          <p style="margin: 6px 0;">
            Once verified, all future payouts will be sent directly to your bank account.
          </p>
          <ul style="margin-top: 8px; font-size: 14px;">
            <li>üíº <strong>Indian Accounts:</strong> Paid via NEFT/IMPS within 24‚Äì48 hours</li>
            <li>üåç <strong>International Accounts:</strong> Paid via SWIFT within 2‚Äì5 business days</li>
          </ul>
        </div>
      </div>
    </div>

    <div style="margin-top: 24px; font-size: 14px;">
      <a href="https://www.rbi.org.in/Scripts/FAQView.aspx?Id=65" target="_blank" class="payoneer-learn-btn" style="color:#15803d; font-weight: 500;">
        Learn about NEFT transfers ‚Üí
      </a>
      <a href="https://www.primebackstage.in/tickets" target="_blank" class="payoneer-learn-btn" style="color:#92400e; font-weight: 500; margin-left: 16px;">
        Contact Support for help ‚Üí
      </a>
    </div>
  </div>
        
      <?php endif; ?>

    </div>
  </div>
<?php endif; ?>

  <?php endif; ?>



  <!-- Form block -->
<?php if ((!$submitted || $isResubmitting) && !$isAdmin): ?>
<div id="payoutFormBlock" style="display: none;">
  <form method="post" action="/settings/submitbank">
    <input type="hidden" name="method" value="<?php echo htmlspecialchars($method); ?>">
    <div class="form-section">
      <?php if ($method === 'payoneer'): ?>
        <?= label('Payoneer Email', 'Enter the email you use for Payoneer payouts') ?>
<input type="email" name="email" required>
        
  <?= label('Account ID', 'Payoneer account ID (e.g. PDAI00051)') ?>
  <input type="text" name="account_id" required>

  <?= label('Account Name', 'Name as registered in your Payoneer account') ?>
  <input type="text" name="account_name" required>

<?php elseif ($method === 'paypal'): ?>
  <?= label('PayPal Email', 'Your PayPal login email') ?>
  <input type="email" name="email" required>

  <?= label('Account Name', 'Name as it appears on your PayPal account') ?>
  <input type="text" name="account_name" required>

<?php elseif ($method === 'bank'): ?>
  <?= label('Bank Name', 'Full name of your bank') ?>
  <input type="text" name="bank_name" required>

  <?= label('Account Number', 'Enter your complete bank account number') ?>
  <input type="text" name="account_number" required>

  <?= label('SWIFT/IFSC Code', 'Branch IFSC (India) or SWIFT (International)') ?>
  <input type="text" name="ifsc" required>

  <?= label('Account Holder Name', 'Exact name on your bank account') ?>
  <input type="text" name="holder_name" required>

  <?= label('Country', 'Country where your bank is registered') ?>
  <input type="text" name="country" required>

  <?= label('State', 'State or province of your bank') ?>
  <input type="text" name="state" required>

  <?= label('Pincode', 'Postal or ZIP code for your location') ?>
  <input type="text" name="pincode" required>

  <?= label('Mobile (with code)', 'Include country code, e.g. +91XXXXXXXXXX') ?>
  <input type="text" name="mobile" required>


      <?php endif; ?>
      <button type="submit" style="margin-top:20px;background:#3b82f6;color:white;padding:10px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Submit</button>
    </div>
  </form>
</div>
<?php endif; ?>



    
  <?php elseif ($submitted): ?>
  <!-- STATUS BLOCK -->
    <div class="status-block <?= $status === 'active' ? 'status-active' : ($status === 'rejected' ? 'status-rejected' : '') ?>">
      <strong>Status:</strong> <?= ucfirst($status) ?>
      <?php if ($status === 'rejected' && !empty($this->payoutData['rejection_reason'])): ?>
        <div><em>Reason: <?= htmlspecialchars($this->payoutData['rejection_reason']) ?></em></div>
      <?php endif; ?>
    </div>
    
    <?php if (isset($_GET['success']) && $_GET['success'] == '1'): ?>
  <div id="successBox" style="background: #f0fdf4; border: 1px solid #bbf7d0; padding: 20px 30px; margin-top: 30px; border-radius: 16px; font-family: 'Inter', sans-serif; box-shadow: 0 4px 12px rgba(0,0,0,0.03); display: flex; align-items: flex-start; gap: 15px;">
    <img src="https://media.tenor.com/I6kN-6X7nhAAAAAi/success-tick.gif" alt="Success" style="width: 60px; height: auto;">
    <div>
      <h4 style="margin: 0 0 5px; color: #15803d;">‚úî Payout details submitted successfully</h4>
      <p style="margin: 0; color: #166534;">Thank you. Our team will now verify the details.</p>
    </div>
  </div>

  <script>
    // Hide the success box after 3 seconds
    setTimeout(() => {
      const box = document.getElementById('successBox');
      if (box) box.style.display = 'none';

      // Clean the ?success=1 from URL without reloading
      const url = new URL(window.location.href);
      url.searchParams.delete('success');
      window.history.replaceState({}, document.title, url.toString());
    }, 3000);
  </script>
<?php endif; ?>
    <!-- INFO DISPLAY (USER + ADMIN) -->
<?php if ($status === 'active' && !$isAdmin): ?>
  <div class="form-section" style="margin-top: 30px;">
    <h3 style="margin-bottom: 20px;">Payout Summary</h3>
    <div class="grid-boxed-fields">
      <?= boxedField('Method:', ucfirst($method)) ?>
      <?= boxedField('Status:', 'üü¢ Eligible for payment') ?>
      <?= boxedField('Updated:', $this->payoutData['updated_at']) ?>

      <?php if ($method === 'payoneer'): ?>
        <?= boxedField('Email:', $this->payoutData['email']) ?>
        <?= boxedField('Account ID:', $this->payoutData['account_id']) ?>
        <?= boxedField('Name:', $this->payoutData['account_name']) ?>

      <?php elseif ($method === 'paypal'): ?>
        <?= boxedField('Email:', $this->payoutData['email']) ?>
        <?= boxedField('Name:', $this->payoutData['account_name']) ?>

      <?php elseif ($method === 'bank'): ?>
        <?= boxedField('Name of the Bank:', $this->payoutData['bank_name']) ?>
        <?= boxedField('Account Number: #', $this->payoutData['account_number']) ?>
        <?= boxedField('Account Holder Name:', $this->payoutData['holder_name']) ?>
        <?= boxedField('IFSC & SWIFT Code:', $this->payoutData['ifsc']) ?>
        <?= boxedField('Country:', $this->payoutData['country']) ?>
        <?= boxedField('Mobile:', $this->payoutData['mobile']) ?>
      <?php endif; ?>
    </div>
  </div>
<?php else: ?>
  <div class="form-section">
    <h3>Submitted Payout Information</h3>
    <?= boxedField('Payment Method', ucfirst($method)) ?>

    <?php if ($method === 'payoneer'): ?>
      <?= boxedField('Payoneer ID', $this->payoutData['account_id']) ?>
      <?= boxedField('Email', $this->payoutData['email']) ?>
      <?= boxedField('Account Name', $this->payoutData['account_name']) ?>

    <?php elseif ($method === 'paypal'): ?>
      <?= boxedField('Email', $this->payoutData['email']) ?>
      <?= boxedField('Account Name', $this->payoutData['account_name']) ?>

    <?php elseif ($method === 'bank'): ?>
      <?= boxedField('Bank Name', $this->payoutData['bank_name']) ?>
      <?= boxedField('Account Number', $this->payoutData['account_number']) ?>
      <?= boxedField('IFSC / SWIFT', $this->payoutData['ifsc']) ?>
      <?= boxedField('Holder Name', $this->payoutData['holder_name']) ?>
      <?= boxedField('Country', $this->payoutData['country']) ?>
      <?= boxedField('State', $this->payoutData['state']) ?>
      <?= boxedField('Pincode', $this->payoutData['pincode']) ?>
      <?= boxedField('Mobile', $this->payoutData['mobile']) ?>
    <?php endif; ?>

    <?= boxedField('Created At', $this->payoutData['created_at']) ?>
    <?= boxedField('Updated At', $this->payoutData['updated_at']) ?>
  </div>
<?php endif; ?>


    
<?php if ($status === 'rejected' && !$isAdmin): ?>
  <div class="status-block status-rejected" style="margin-top: 30px;">
    <strong>Your previous submission was rejected.</strong><br>
    <a href="/settings/bankinformation?resubmit=1" 
   style="display:inline-block; margin-top:10px; padding:10px 15px; background:#ef4444; color:white; border-radius:6px; text-decoration:none;">
   Try Again (Re-submit)
</a>

  </div>
  
<?php endif; ?>
  
  <?php if (!empty($this->submissionHistory) && !$isAdmin): ?>
  <div style="margin-top: 50px;">
    <h3 style="margin-bottom: 15px;">Submission History</h3>

    <style>
      
      .grid-boxed-fields {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
  margin-top: 20px;
}
.grid-boxed-fields .field-box {
  margin-bottom: 0;
}

      .history-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      .history-table th, .history-table td {
        padding: 10px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
      }
      .history-table thead th {
        background: #f9fafb;
        font-weight: 600;
        border-bottom: 2px solid #ccc;
      }
      .status-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        display: inline-block;
      }
      .status-active   { background: #dcfce7; color: #166534; }
      .status-rejected { background: #fee2e2; color: #991b1b; }
      .status-pending  { background: #fef3c7; color: #92400e; }
      
      .payoneer-guide {
  background: #f9fafb;
  border-radius: 16px;
  padding: 30px 40px;
  margin-top: 40px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.04);
  font-family: 'Inter', sans-serif;
}

.payoneer-title {
  font-size: 22px;
  color: #111827;
  margin-bottom: 10px;
}

.payoneer-desc {
  color: #4b5563;
  margin-bottom: 30px;
  font-size: 15px;
}

.payoneer-steps {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin-bottom: 30px;
}

.step {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

.step-number {
  font-size: 18px;
  font-weight: 700;
  color: #3b82f6;
  width: 30px;
  flex-shrink: 0;
}

.step p {
  margin: 5px 0 0 0;
  color: #374151;
  font-size: 14px;
}

.payoneer-learn-btn {
  display: inline-block;
  background: #3b82f6;
  color: white;
  padding: 10px 18px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
}
.payoneer-learn-btn:hover {
  background: #2563eb;
}

    </style>

    <table class="history-table">
      <thead>
        <tr>
          <th>Submitted On</th>
          <th>Method</th>
          <th>Status</th>
          <th>Rejection Reason</th>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($this->submissionHistory as $entry): ?>
          <tr>
            <td><?= htmlspecialchars($entry['created_at']) ?></td>
            <td><?= ucfirst($entry['method']) ?></td>
            <td>
              <?php
                $status = strtolower($entry['status']);
                if ($status === 'active') {
                  echo '<span class="status-badge status-active">‚úî Approved</span>';
                } elseif ($status === 'rejected') {
                  echo '<span class="status-badge status-rejected">‚ùå Rejected</span>';
                } else {
                  echo '<span class="status-badge status-pending">‚è≥ Pending</span>';
                }
              ?>
            </td>
            <td><?= !empty($entry['rejection_reason']) ? htmlspecialchars($entry['rejection_reason']) : '-' ?></td>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  </div>
<?php endif; ?>
  
  <?php if ($method === 'payoneer' && $status === 'active'): ?>
<div class="payoneer-guide">
  <h3 class="payoneer-title">üì© Request payments in an instant</h3>
  <p class="payoneer-desc">
    Getting paid by your global clients should be easy‚Äîno matter where they‚Äôre from.
    Requesting a payment with Payoneer takes only a few clicks and lets you track it every step of the way.
  </p>
  
  <div class="payoneer-steps">
  <div class="step">
    <div class="step-number">01</div>
    <div>
      <strong>Create a Payoneer Account</strong>
      <p>If you don‚Äôt have a Payoneer account yet, create one using the link below:</p>
      <p><a href="https://payouts.payoneer.com/partners/or.aspx?pid=YOYIZC74IO2s4KZQp7tgsw%3d%3d&BusinessLine=3&Volume=below-10000&web_interaction=webpage_accounts|website_traffic&langid=1&locale=en&_gl=1*1yo48l1*_up*MQ..*_gs*MQ..&gclid=CjwKCAjwvuLDBhAOEiwAPtF0Vh0cVqjjtes7TatBEF_7US-F-W97YM3LCRTWi8AocvT_GhTEjJZ5uhoCN4AQAvD_BwE&gbraid=0AAAAADmHOchu8xv8cnHkkMvZfWHzZu-aL" target="_blank" style="color:#3b82f6;font-weight:600;text-decoration:underline;">Click here to create a Payoneer Account ‚Üí</a></p>
    </div>
  </div>

  <div class="step">
    <div class="step-number">02</div>
    <div>
      <strong>Pick your payer</strong>
      <p>Go to <strong>"Request a payment"</strong> in your Payoneer dashboard and select the client, or add a new one.</p>
    </div>
  </div>

  <div class="step">
    <div class="step-number">03</div>
    <div>
      <strong>Input invoice details</strong>
      <p>Enter amount, currency, due date, description, and optionally attach supporting documents.</p>
    </div>
  </div>

  <div class="step">
    <div class="step-number">04</div>
    <div>
      <strong>Send & track</strong>
      <p>Send the request via Payoneer. Your client will receive it by email and can pay instantly.</p>
    </div>
  </div>
</div>


  <a href="https://www.payoneer.com/en-in/get-paid-by-clients/" target="_blank" class="payoneer-learn-btn">Learn More at Payoneer ‚Üí</a>
</div>
<?php endif; ?>

    <?php if ($isAdmin): ?>
      <!-- ADMIN ACTION PANEL -->
      <div class="admin-controls">
        <form method="post" action="/settings/verifybank">
          <input type="hidden" name="id" value="<?= $this->payoutData['id'] ?>">
          <input type="hidden" name="user_id" value="<?= $this->payoutData['user_id'] ?? $this->user['id'] ?? '' ?>">


          <?= label('Change Status') ?>
          <select name="status" required>
  <option value="">Select</option>
  <option value="active" <?= ($row['status'] === 'active') ? 'selected' : '' ?>>Approve</option>
  <option value="rejected" <?= ($row['status'] === 'rejected') ? 'selected' : '' ?>>Reject</option>
</select>
          <?= label('Rejection Reason (optional)') ?>
          <textarea name="rejection_reason"></textarea>
          <button type="submit" style="background:#10b981;color:white;padding:10px 20px;border:none;border-radius:8px;margin-top:10px;">Update</button>
        </form>
      </div>
    <?php endif; ?>
  <?php endif; ?>
</div>


<?php if ($isAdmin): ?>
<form method="get" style="margin-bottom: 20px;">
  <input type="text" name="q" value="<?= htmlspecialchars($this->searchQuery) ?>" placeholder="Search name, email, company" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc;">
  <button type="submit" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px;">Search</button>
</form>


  <style>
    table.admin-payouts {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 20px;
    }
    table.admin-payouts th, table.admin-payouts td {
      padding: 12px 10px;
      border: 1px solid #e5e7eb;
      
      text-align: left;
    }
    table.admin-payouts th {
      background: #f3f4f6;
      font-weight: 600;
    }
    .status-active { color: green; font-weight: bold; }
    .status-rejected { color: red; font-weight: bold; }
    .status-pending { color: orange; font-weight: bold; }
    .rejection-note { color: #6b7280; font-size: 12px; margin-top: 5px; }
    .btn-delete {
      background: none;
      border: none;
      color: red;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-delete:hover {
      text-decoration: underline;
    }
    button {
    background-color: #388eeb;
    border-radius: 2rem;
    color: #fff;
    padding: .5rem 2.5rem;
    font-size: 14px;
    letter-spacing: 1.4px;
    text-transform: uppercase;
    cursor: not-allowed;
}
    
    button, optgroup, textarea {
    margin: 0;
    font: inherit;
    color: #ffffff;
}
  </style>

  <div style="margin-top: 60px;">
    <h3 style="margin-bottom: 20px;">üè¶ Payout Entries</h3>

    <?php if (!empty($this->allPayouts)): ?>
      <table class="admin-payouts">
        <thead>
          <tr>
            <th>#</th>
            <th>Company</th>
            <th>User Name</th>
            <th>Payee Name</th>
            <th>Method</th>
            <th>Details</th>
            <th>Status</th>
            <th>Update</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          <?php
$startSerial = (($this->currentPage ?? 1) - 1) * ($this->perPage ?? 10) + 1;
foreach ($this->allPayouts as $i => $row):
?>

            <tr>
  <td><?= $startSerial + $i ?></td>
  <td><?= htmlspecialchars($row['company_name'] ?: '-') ?></td>
  <td><?= htmlspecialchars($row['full_name'] ?: '-') ?></td>
  <td><?= htmlspecialchars($row['account_name']) ?></td>
  <td><?= ucfirst($row['method']) ?></td>
  <td>
    <button onclick="showDetailsModal(<?= htmlspecialchars(json_encode($row)) ?>)">‚öôÔ∏èView</button>
  </td>
  <td>
    <?php if ($row['status'] == 'active'): ?>
      <span class="status-active">‚úî Active</span>
    <?php elseif ($row['status'] == 'rejected'): ?>
      <span class="status-rejected">‚ùå Rejected</span>
      <?php if (!empty($row['rejection_reason'])): ?>
        <div class="rejection-note"><em><?= htmlspecialchars($row['rejection_reason']) ?></em></div>
      <?php endif; ?>
    <?php else: ?>
      <span class="status-pending">Pending</span>
    <?php endif; ?>
  </td>
  <td>
    <form method="post" action="/settings/verifybank" style="margin:0;">
      <input type="hidden" name="id" value="<?= $row['id'] ?>">
      <input type="hidden" name="user_id" value="<?= $row['user_id'] ?>">
      <select name="status" required>
        <option value="">Select</option>
        <option value="active">Approve</option>
        <option value="rejected">Reject</option>
      </select>
      <input type="text" name="rejection_reason" placeholder="Reason (optional)" style="width: 150px; margin-top: 6px;" />
      <br>
      <button type="submit" style="margin-top:6px;">Update</button>
    </form>
  </td>
  <td>
    <form method="post" action="/settings/deletebank" onsubmit="return confirm('Are you sure to delete this payout entry?');" style="margin:0;">
      <input type="hidden" name="id" value="<?= $row['id'] ?>">
      <button type="submit" class="btn-delete">Delete</button>
    </form>
  </td>
</tr>
<?php endforeach; ?>
        </tbody>
      </table>
   
    <?php else: ?>
      <p style="color: #888;">No payout entries found.</p>
    <?php endif; ?>
  </div>
<?php endif; ?>
  
  <?php if ($this->totalPages > 1): ?>
  <div style="margin-top: 20px; text-align: center;">
    <?php for ($p = 1; $p <= $this->totalPages; $p++): ?>
      <a href="?page=<?= $p ?>" style="
        margin: 0 4px;
        padding: 6px 12px;
        border-radius: 6px;
        background: <?= ($this->currentPage == $p) ? '#3b82f6' : '#f3f4f6' ?>;
        color: <?= ($this->currentPage == $p) ? '#fff' : '#1f2937' ?>;
        text-decoration: none;
        font-weight: 600;
        border: 1px solid #d1d5db;
      ">
        <?= $p ?>
      </a>
    <?php endfor; ?>
  </div>
<?php endif; ?>

<!-- Modal Overlay -->
<div id="modalOverlay" onclick="closeModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9998;"></div>

<!-- Modal -->
<div id="detailsModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  background:white; padding:30px 40px; border-radius:16px; box-shadow:0 0 30px rgba(0,0,0,0.25); max-width:1000px; width:90%; z-index:9999; font-family:Inter, sans-serif;">

  <h2 style="margin-bottom:20px; font-size:22px; border-bottom:1px solid #eee; padding-bottom:10px;">üßæ Payout Details</h2>
  <div id="detailsContent" style="font-size:15px; color:#1e293b; line-height:1.6;"></div>

  <button onclick="closeModal()" style="margin-top:25px; background:#ef4444; color:white; padding:10px 20px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Close</button>
</div>
  
  
  
  
  
  <?php if ($_SESSION['STAFFUSER'] == '1' || $_SESSION['user_id'] == 0): ?>
  <!-- üîí Admin-only: MCN Requests Table and Modal -->

  <div class="section-card" style="margin-top: 40px;">
    <h3 style="margin-bottom: 20px;">üì∫ MCN Channel Requests</h3>
    <table class="table table-striped" style="width: 100%;">
      <thead>
        <tr>
          <th>#</th>
          <th>Company</th>
          <th>User Name</th>
          <th>Email</th>
          <th>Status</th>
          <th>Details</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <?php $i = 1; if (!empty($this->mcnRequests)): ?>
  <?php foreach ($this->mcnRequests as $row): ?>
    <tr>
      <td><?= $i++ ?></td>
      <td><?= htmlspecialchars($row['company_name']) ?></td>
      <td><?= htmlspecialchars($row['first_name'] . ' ' . $row['last_name']) ?></td>
      <td><?= htmlspecialchars($row['email']) ?></td>
      <td>
        <?php
          $status = strtolower($row['status']);
          $badge = $status === 'approved' ? '‚úÖ Approved' :
                   ($status === 'rejected' ? '‚ùå Rejected' : '‚è≥ Pending');
          echo $badge;
        ?>
      </td>
      <td>
  <button
    type="button"
    class="btn btn-primary btn-sm open-mcn"
    data-mcn='<?= htmlspecialchars(json_encode($row), ENT_QUOTES, "UTF-8") ?>'>
    VIEW
  </button>
</td>
      <td>
        <form action="/settings/updatemcn" method="post" style="display:flex; gap:6px; align-items:center;">
          <input type="hidden" name="mcn_id" value="<?= $row['id'] ?>">

          <select name="status" class="form-select form-select-sm" style="width: 120px;" onchange="toggleReasonBox(this)">
            <option value="">Select</option>
            <option value="approved" <?= $status == 'approved' ? 'selected' : '' ?>>Approve</option>
            <option value="rejected" <?= $status == 'rejected' ? 'selected' : '' ?>>Reject</option>
          </select>

          <input type="text" name="reason" class="form-control form-control-sm reason-box"
                 placeholder="Reason (if rejected)"
                 style="display:<?= $status == 'rejected' ? 'block' : 'none' ?>; width:150px;">

          <button type="submit" class="btn btn-success btn-sm">‚úÖ Save</button>
        </form>

        <form action="/settings/deletemcn" method="post" onsubmit="return confirm('Delete this request?')">
          <input type="hidden" name="mcn_id" value="<?= $row['id'] ?>">
          <button class="btn btn-danger btn-sm mt-1" type="submit">üóë Delete</button>
        </form>
      </td>
    </tr>
  <?php endforeach; ?>
<?php else: ?>
  <tr>
  <td colspan="7" style="text-align: center; padding: 60px 20px; background: #f9fafb;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
      <img src="https://cdn-icons-png.flaticon.com/512/6598/6598512.png" alt="No Data"
           style="width: 72px; height: auto; opacity: 0.7;" />

      <div style="font-size: 16px; font-weight: 500; color: #6b7280;">
        No MCN Requests Found
      </div>
    </div>
  </td>
</tr>
<?php endif; ?>
      </tbody>
    </table>
  </div>

  <script>
    function toggleReasonBox(select) {
      const reasonInput = select.closest('form').querySelector('.reason-box');
      if (select.value === 'rejected') {
        reasonInput.style.display = 'block';
      } else {
        reasonInput.style.display = 'none';
      }
    }
  </script>
  <!-- ‚úÖ MODAL: MCN Channel Details -->
<div id="mcnDetailsModal" style="display:none; position:fixed; top:50px; left:50%; transform:translateX(-50%); background:#fff; border-radius:14px; padding:30px 32px 40px; width:850px; max-height:92vh; overflow-y:auto; z-index:9999; box-shadow:0 20px 50px rgba(0,0,0,0.25); font-family:'Inter',sans-serif;">
  <div style="text-align:right; margin-bottom:-10px;">
    <button onclick="closeMcnModal()" style="font-size:20px; border:none; background:none; cursor:pointer;">‚ùå</button>
  </div>
  <h2 style="margin-top:0; font-size:22px;">üì∫ Full MCN Channel Submission</h2>
  <hr style="margin: 12px 0 24px; border-color:#e5e7eb;">

  <div id="mcnModalContent"></div>
</div>

<div id="mcnBackdrop" onclick="closeMcnModal()" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9998;"></div>

<script>
function openMcnModal(data) {
  let field = (label, value) => `
    <div style="background:#f9fafb; padding:12px 16px; border-radius:10px; border:1px solid #e5e7eb; margin-bottom:10px;">
      <div style="font-size:12px; color:#6b7280;">${label}</div>
      <div style="font-size:15px; font-weight:500;">${value || '‚Äî'}</div>
    </div>
  `;

  let html = `
    <h4 style="margin-top:0; margin-bottom:10px;">üë§ User Info</h4>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
      ${field('User', `${data.first_name} ${data.last_name}`)}
      ${field('Company', data.company_name)}
      ${field('Email', data.email)}
    </div>

    <h4 style="margin-top:24px; margin-bottom:10px;">üì∫ Channel Info</h4>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
      ${field('Channel Link', `<a href="${data.channel_url}" target="_blank" style="color:#2563eb;">${data.channel_url}</a>`)}
      ${field('Type', data.channel_type)}
      ${field('Relationship', data.relationship)}
      ${field('Upload Type', data.upload_type)}
      ${field('Pattern', data.upload_pattern)}
    </div>

    <h4 style="margin-top:24px; margin-bottom:10px;">üí∞ Monetization</h4>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
      ${field('Subscribers', data.subscriber_count)}
      ${field('Watch Time 4000+', data.watchtime_eligible)}
      ${field('Monetized', data.monetized)}
      ${field('Revenue', data.estimated_earnings)}
    </div>

    <h4 style="margin-top:24px; margin-bottom:10px;">üéµ Content</h4>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
      ${field('Music Only', data.music_only)}
      ${field('Cover Songs', data.has_covers)}
      ${field('has_strikes', data.has_strikes)}
      ${field('Strike Reason', data.strike_reason)}
    </div>

    <h4 style="margin-top:24px; margin-bottom:10px;">üñº Screenshots</h4>
    <div style="display:flex; gap:20px; flex-wrap:wrap;">
      ${data.watchtime_proof ? `
        <div style="text-align:center;">
          <img src="/public/uploads/mcn/${data.watchtime_proof}" style="width:200px; border-radius:10px; border:1px solid #ddd; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
          <a href="/public/uploads/mcn/${data.watchtime_proof}" download style="display:block; margin-top:6px; font-size:13px; color:#2563eb;">üì• Download</a>
        </div>` : ''
      }
      ${data.screenshot ? `
        <div style="text-align:center;">
          <img src="/public/uploads/mcn/${data.screenshot}" style="width:200px; border-radius:10px; border:1px solid #ddd; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
          <a href="/public/uploads/mcn/${data.screenshot}" download style="display:block; margin-top:6px; font-size:13px; color:#2563eb;">üì• Download</a>
        </div>` : ''
      }
    </div>
  `;

  document.getElementById('mcnModalContent').innerHTML = html;
  document.getElementById('mcnDetailsModal').style.display = 'block';
  document.getElementById('mcnBackdrop').style.display = 'block';
}

function closeMcnModal() {
  document.getElementById('mcnDetailsModal').style.display = 'none';
  document.getElementById('mcnBackdrop').style.display = 'none';
}
</script>

<?php endif; ?>

<!-- ====================== -->
<!-- TAX TAB SECTION (UPDATED WITH INDIVIDUAL + COMPANY + SAVE) -->
<!-- ====================== -->
<form id="taxForm" method="post" action="<?php echo $this->basePath(); ?>/settings/submittax">
<div id="tax-section" class="tab-section" style="display:none;">
  <div class="section-card">

    <h3 style="margin-bottom:10px;">Tax Information</h3>
    <p style="color:#475569;margin-bottom:20px;">
      You must provide your tax information to receive payouts.
    </p>

    <!-- Country of Tax Residence -->
    <label class="form-label">Country of Tax Residence</label>
    <select id="taxCountry" name="tax_country" class="form-input">
      <option value="">Select</option>
      <option value="in" <?= $taxCountryVal === 'in' ? 'selected' : '' ?>>India</option>
      <option value="us" <?= $taxCountryVal === 'us' ? 'selected' : '' ?>>United States</option>
      <option value="gb" <?= $taxCountryVal === 'gb' ? 'selected' : '' ?>>United Kingdom</option>
      <option value="pk" <?= $taxCountryVal === 'pk' ? 'selected' : '' ?>>Pakistan</option>
      <option value="bd" <?= $taxCountryVal === 'bd' ? 'selected' : '' ?>>Bangladesh</option>
      <option value="ca" <?= $taxCountryVal === 'ca' ? 'selected' : '' ?>>Canada</option>
      <option value="ae" <?= $taxCountryVal === 'ae' ? 'selected' : '' ?>>UAE</option>
      <option value="sa" <?= $taxCountryVal === 'sa' ? 'selected' : '' ?>>Saudi Arabia</option>
    </select>

    <!-- ============ INDIA ONLY ============ -->
    <div id="indiaTaxBlock" style="display:none; margin-top:20px;">

      <!-- Tax Profile Type -->
      <label class="form-label">Tax Profile Type</label>
      <div style="display:flex; gap:18px; margin-bottom:16px;">
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="radio" name="tax_profile_type" value="individual"
                 <?= $taxProfileVal === 'individual' ? 'checked' : '' ?>>
          Individual
        </label>

        <label style="display:flex; align-items:center; gap:6px;">
          <input type="radio" name="tax_profile_type" value="company"
                 <?= $taxProfileVal === 'company' ? 'checked' : '' ?>>
          Company / Firm
        </label>
      </div>

      <!-- ========== INDIVIDUAL (TDS) ========== -->
      <div id="individualTaxBlock">
        <div style="background:#ecfdf3; border:1px solid #bbf7d0; padding:12px 14px; 
                    border-radius:10px; font-size:13px; color:#166534; margin-bottom:16px;">
          ‚úÖ <strong>Individual selected.</strong> TDS will be deducted from your payouts as per Income Tax rules.
        </div>

        <div class="grid-boxed-fields">
          <div>
            <label class="form-label">Full Name (as per PAN)</label>
            <input type="text" name="pan_full_name" class="form-input"
                   value="<?= htmlspecialchars($taxPanFullName) ?>"
                   placeholder="Exact name on PAN card">
          </div>

          <div>
            <label class="form-label">PAN Number</label>
            <input type="text" name="pan_number" class="form-input"
                   value="<?= htmlspecialchars($taxPanNumber) ?>"
                   placeholder="ABCDE1234F">
          </div>
        </div>

        <div class="grid-boxed-fields" style="margin-top:20px;">
          <div>
            <label class="form-label">Address</label>
            <input type="text" name="address" class="form-input"
                   value="<?= htmlspecialchars($taxAddress) ?>"
                   placeholder="Address as per ID proof">
          </div>
          <div>
            <label class="form-label">State</label>
            <input type="text" name="state" class="form-input"
                   value="<?= htmlspecialchars($taxState) ?>">
          </div>
          <div>
            <label class="form-label">Pincode</label>
            <input type="text" name="pincode" class="form-input"
                   value="<?= htmlspecialchars($taxPincode) ?>">
          </div>
        </div>
      </div>

      <!-- ========== COMPANY (GST) ========== -->
      <div id="companyTaxBlock" style="display:none;">
        <div style="background:#eff6ff; border:1px solid #bfdbfe; padding:12px 14px; 
                    border-radius:10px; font-size:13px; color:#1d4ed8; margin-bottom:16px;">
          üè¢ <strong>Company / Firm selected.</strong> GST and business details are required.
        </div>

        <div class="grid-boxed-fields">
          <div>
            <label class="form-label">Legal Business Name</label>
            <input type="text" name="business_name" class="form-input"
                   value="<?= htmlspecialchars($taxBusinessName) ?>"
                   placeholder="Registered company name">
          </div>

          <div>
            <label class="form-label">GSTIN</label>
            <input type="text" name="gstin" class="form-input"
                   value="<?= htmlspecialchars($taxGstin) ?>"
                   placeholder="22AAAAA0000A1Z5">
          </div>

          <div>
            <label class="form-label">Company PAN</label>
            <input type="text" name="company_pan" class="form-input"
                   value="<?= htmlspecialchars($taxCompanyPan) ?>"
                   placeholder="ABCDE1234F">
          </div>
        </div>

        <div class="grid-boxed-fields" style="margin-top:20px;">
          <div>
            <label class="form-label">Registered Address</label>
            <input type="text" name="company_address" class="form-input"
                   value="<?= htmlspecialchars($taxCompanyAddress) ?>">
          </div>

          <div>
            <label class="form-label">State</label>
            <input type="text" name="company_state" class="form-input"
                   value="<?= htmlspecialchars($taxCompanyState) ?>">
          </div>

          <div>
            <label class="form-label">Pincode</label>
            <input type="text" name="company_pincode" class="form-input"
                   value="<?= htmlspecialchars($taxCompanyPincode) ?>">
          </div>
        </div>
      </div>
      <!-- END COMPANY BLOCK -->

    </div>
    <!-- END INDIA BLOCK -->

    <!-- NON-INDIA NOTE -->
    <div id="nonIndiaNote" style="display:none; margin-top:20px;">
      <div style="background:#f1f5f9; padding:14px 18px; border-radius:10px; border:1px solid #e2e8f0;">
        ‚úî No additional tax documentation is required for your selected country.
      </div>
    </div>

    <!-- SAVE BUTTON (normal form submit) -->
    <button 
      type="submit"
      class="primary-btn"
      style="margin-top:20px;">
      Save Tax Details
    </button>

  </div>
</div>
</form>


<script>
// Top tabs: Bank Details / Tax Information
function switchTab(tab) {
  var bankingSection = document.getElementById('banking-section');
  var taxSection     = document.getElementById('tax-section');
  var tabBanking     = document.getElementById('tab-banking');
  var tabTax         = document.getElementById('tab-tax');

  if (!bankingSection || !taxSection || !tabBanking || !tabTax) return;

  if (tab === 'banking') {
    bankingSection.style.display = 'block';
    taxSection.style.display     = 'none';

    tabBanking.classList.add('active');
    tabTax.classList.remove('active');
  } else if (tab === 'tax') {
    bankingSection.style.display = 'none';
    taxSection.style.display     = 'block';

    tabBanking.classList.remove('active');
    tabTax.classList.add('active');
  }
}

// Tax form toggles + AJAX submit
document.addEventListener("DOMContentLoaded", function () {
  // ====== Tax country / profile toggle ======
  var country       = document.getElementById("taxCountry");
  var indiaBlock    = document.getElementById("indiaTaxBlock");
  var nonIndia      = document.getElementById("nonIndiaNote");

  var individualBlock = document.getElementById("individualTaxBlock");
  var companyBlock    = document.getElementById("companyTaxBlock");
  var radios          = document.querySelectorAll('input[name="tax_profile_type"]');

  function updateCountry() {
    if (!country || !indiaBlock || !nonIndia) return;

    if (country.value === "in") {
      indiaBlock.style.display = "block";
      nonIndia.style.display   = "none";
    } else if (country.value === "") {
      indiaBlock.style.display = "none";
      nonIndia.style.display   = "none";
    } else {
      indiaBlock.style.display = "none";
      nonIndia.style.display   = "block";
    }
  }

  function updateProfile() {
    if (!individualBlock || !companyBlock) return;

    var checked = document.querySelector('input[name="tax_profile_type"]:checked');
    var type = checked ? checked.value : 'individual';

    if (type === "company") {
      companyBlock.style.display    = "block";
      individualBlock.style.display = "none";
    } else {
      companyBlock.style.display    = "none";
      individualBlock.style.display = "block";
    }
  }

  if (country) {
    country.addEventListener("change", updateCountry);
  }
  radios.forEach(function(r) {
    r.addEventListener("change", updateProfile);
  });

  // initial state
  updateCountry();
  updateProfile();

  // ====== Open correct tab from URL (?tab=tax) ======
  try {
    var params = new URLSearchParams(window.location.search);
    var tab = params.get('tab');
    if (tab === 'tax') {
      switchTab('tax');
    } else {
      switchTab('banking');
    }
  } catch (e) {
    // fallback
    switchTab('banking');
  }

  // ====== TAX FORM AJAX SUBMIT ======
  var taxBtn = document.getElementById('taxSaveBtn');
  if (taxBtn) {
    taxBtn.addEventListener('click', function (e) {
      e.preventDefault();

      taxBtn.disabled = true;
      var oldText = taxBtn.textContent;
      taxBtn.textContent = 'Saving...';

      // collect only tax-section inputs
      var els = document.querySelectorAll('#tax-section input, #tax-section select, #tax-section textarea');
      var paramsArr = [];

      els.forEach(function (el) {
        if (!el.name) return;

        if ((el.type === 'radio' || el.type === 'checkbox') && !el.checked) {
          return;
        }

        paramsArr.push(
          encodeURIComponent(el.name) + '=' + encodeURIComponent(el.value)
        );
      });

      var body = paramsArr.join('&');

      fetch('<?php echo $this->basePath(); ?>/settings/submittax', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
        },
        body: body
      })
      .then(function (resp) {
        // success ‚Üí same page with flag
        window.location.href = '<?php echo $this->basePath(); ?>/settings/bankinformation?tab=tax&tax_saved=1';
      })
      .catch(function (err) {
        console.error(err);
        alert('Unable to save tax details. Please try again.');
        taxBtn.disabled = false;
        taxBtn.textContent = oldText;
      });
    });
  }
});
</script>

   
        
  <!-- ‚úÖ Footer -->
<div style="
  margin-top: 80px;
  padding: 30px 40px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  color: #6b7280;
  text-align: center;
">
  <div style="margin-bottom: 10px;">
    Need help? <a href="https://www.primebackstage.in/tickets" style="color: #3b82f6; text-decoration: none; font-weight: 500;">Contact Support</a> or visit our <a href="https://www.primebackstage.in/faq" style="color: #3b82f6; text-decoration: none; font-weight: 500;">FAQ</a>.
  </div>
  <div style="font-size: 13px; color: #9ca3af;">
    &copy; <?php echo date('Y'); ?> Prime Digital Arena. All rights reserved.
  </div>
</div>


        
        <style>
.toggle-tabs {
  display: flex;
  border-bottom: 2px solid #e5e7eb;
  margin-bottom: 30px;
}

.tab {
  padding: 14px 24px;
  font-weight: 600;
  color: #6b7280;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.3s ease;
}

.tab.active {
  color: #1f2937;
  border-color: #3b82f6;
}

.tab-section {
  animation: fadeIn 0.25s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.section-card {
  background: #fff;
  border-radius: 16px;
  padding: 30px 40px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
}

.form-section {
  margin-top: 20px;
}

.form-label {
  display: block;
  font-weight: 500;
  margin-bottom: 6px;
  color: #374151;
  font-size: 14px;
}

.form-input {
  width: 100%;
  padding: 10px 12px;
  margin-bottom: 16px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  background: #f9fafb;
}

.submit-btn {
  background-color: #3b82f6;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}
          
          .grid-boxed-fields {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
  margin-top: 10px;
}

.field-box {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px 16px;
}

.field-label {
  font-size: 13px;
  color: #6b7280;
  margin-bottom: 4px;
}

.field-value {
  font-weight: 500;
  font-size: 15px;
  color: #111827;
}

</style>

<script>
function showDetailsModal(data) {
  const method = (data.method || '').toLowerCase();
  const status = (data.status || '').toLowerCase();
  const testAmount = data.test_amount || '';

  // Status badge
  let statusBadge = '';
  if (status === 'active') {
    statusBadge = `<span style="margin-left:12px; background:#dcfce7; color:#166534; font-size:13px; font-weight:600; padding:4px 10px; border-radius:6px;">‚úî Active</span>`;
  } else if (status === 'rejected') {
    statusBadge = `<span style="margin-left:12px; background:#fee2e2; color:#991b1b; font-size:13px; font-weight:600; padding:4px 10px; border-radius:6px;">‚ùå Rejected</span>`;
  } else {
    statusBadge = `<span style="margin-left:12px; background:#fef3c7; color:#92400e; font-size:13px; font-weight:600; padding:4px 10px; border-radius:6px;">‚è≥ Pending</span>`;
  }

  document.querySelector('#detailsModal h2').innerHTML = `üßæ Payout Details ${statusBadge}`;

  const copyIcon = (text) => {
  return `<button onclick="copyToClipboard('${text}')" title="Copy" style="
    position: absolute;
    top: 8px;
    right: 10px;
    padding: 2px 8px;
    font-size: 11px;
    font-weight: 600;
    background: #757eff;
    color: #ffffff;
    border: 1px solid #bae6fd;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Inter', sans-serif;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    transition: background 0.2s ease;
  " onmouseover="this.style.background='#bae6fd'" onmouseout="this.style.background='#757eff'">üìã Copy</button>`;
};


  const addField = (label, value) => {
    if (!value) return '';
    return `<div class="field-box" style="position:relative;">
      ${copyIcon(value)}
      <div class="field-label">${label}</div>
      <div class="field-value">${value}</div>
    </div>`;
  };

  let html = '';

  // ‚úÖ Compact User Info Summary (inline format)
  const userName = data.full_name || '-';
  const companyName = data.company_name || '-';
  const userId = "PDA|" + String(data.user_id).padStart(5, '0');

  html += `
    <div style="font-size:14px; color:#374151; margin-bottom: 20px; font-weight: 500;">
      üë§ <strong>Submitted By:</strong> ${userName} (${companyName}) &nbsp; ‚Ä¢ &nbsp; <strong>User ID:</strong> ${userId}
    </div>
  `;

  // ‚úÖ Payout Section Heading
  html += `
    <div style="font-weight: 600; font-size: 16px; margin-bottom: 12px;">üè¶ Payout Details</div>
    <div class="grid-boxed-fields">
  `;

  // ‚úÖ Payout Fields
  html += addField("Method", data.method);
  html += addField("Email", data.email);

  if (method.includes('paypal')) {
    html += addField("Account Name", data.account_name);
  } else if (method.includes('payoneer')) {
    html += addField("Account ID", data.account_id);
    html += addField("Account Name", data.account_name);
  } else if (method.includes('bank')) {
    html += addField("Bank Name", data.bank_name);
    html += addField("Account Number", data.account_number);
    html += addField("Holder Name", data.holder_name);
    html += addField("IFSC / SWIFT", data.ifsc);
    html += addField("Country", data.country);
    html += addField("State", data.state);
    html += addField("Pincode", data.pincode);
    html += addField("Mobile", data.mobile);

    if (testAmount) {
      html += addField("Test Deposit", `‚Çπ${testAmount}`);
    }
  }

  html += `</div>`;

  // ‚úÖ Rejection reason (if any)
  if (status === 'rejected' && data.rejection_reason) {
    html += `<div style="margin-top:12px; padding:12px; background:#fef2f2; border:1px solid #fecaca; border-radius:6px;">
      <div style="font-size:14px; color:#991b1b;"><strong>Rejection Reason:</strong><br>
      <em>${data.rejection_reason}</em></div>
    </div>`;
  }

  document.getElementById('detailsContent').innerHTML = html;
  document.getElementById('detailsModal').style.display = 'block';
  document.getElementById('modalOverlay').style.display = 'block';
}

// Modal close
function closeModal() {
  document.getElementById('detailsModal').style.display = 'none';
  document.getElementById('modalOverlay').style.display = 'none';
}

// Copy helper
function copyToClipboard(value) {
  navigator.clipboard.writeText(value).then(() => {
    showToast('Copied!');
  });
}

// Toast
function showToast(msg) {
  let toast = document.createElement('div');
  toast.innerText = msg;
  toast.style.position = 'fixed';
  toast.style.bottom = '30px';
  toast.style.left = '50%';
  toast.style.transform = 'translateX(-50%)';
  toast.style.background = '#111827';
  toast.style.color = '#fff';
  toast.style.padding = '10px 18px';
  toast.style.borderRadius = '6px';
  toast.style.fontSize = '14px';
  toast.style.zIndex = '99999';
  toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2000);
}

</script>
        
        
<script>
  function showPayoutForm() {
    var formBlock = document.getElementById('payoutFormBlock');
    if (formBlock) {
      formBlock.style.display = 'block';
      formBlock.scrollIntoView({ behavior: 'smooth' });

      // Optional: hide warning etc
      const warn = document.getElementById('noPayoutWarning');
      if (warn) warn.style.display = 'none';
      const how = document.getElementById('howItWorks');
      if (how) how.style.display = 'none';
    }
  }
</script>
        <script>
function switchTab(tab) {
  document.getElementById('banking-section').style.display = tab === 'banking' ? 'block' : 'none';
  document.getElementById('tax-section').style.display = tab === 'tax' ? 'block' : 'none';

  document.getElementById('tab-banking').classList.remove('active');
  document.getElementById('tab-tax').classList.remove('active');

  document.getElementById('tab-' + tab).classList.add('active');
}
          
  ${field('Subscribers', data.subscriber_count ?? data.subscribers ?? '‚Äî')}
${field('Revenue', data.estimated_earnings ?? data.estimated_revenue ?? data.revenue ?? '‚Äî')}
${field('Copyright Strikes', data.copyright_strikes ?? data.copyright_strike ?? '‚Äî')}
        
          
</script>
<script>
document.addEventListener('click', function(e){
  const btn = e.target.closest('.open-mcn');
  if(!btn) return;

  try {
    const raw = btn.getAttribute('data-mcn');
    // Parse safely
    const data = JSON.parse(raw);
    openMcnModal(data); // reuse your existing function
  } catch (err) {
    console.error('MCN modal data parse error:', err);
    alert('Could not open details. (Invalid data)');
  }
});
</script>
