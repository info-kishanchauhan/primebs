var RoyaltiesReportManager = {};
var reportType = 'automatic reports';
var reportOption;
var customReportInterested = false;

 
//app.ChildReport
(function (app) {

    var self = {};

    self.init = function () {

        $('[name=childSelect]').change(function () {

            var getParametersStart = document.location.href.indexOf('?');

            if (getParametersStart > 0) {
                var cuUrlAnyParameters = document.location.href.substr(0, getParametersStart);
            } else {
                var cuUrlAnyParameters = document.location.href;
            }

            location.href = cuUrlAnyParameters + '?idChild=' + $(this).val();
        });
    };

    app.ChildReport = self;

})(RoyaltiesReportManager);

//app.AutoGeneratedReport
(function (app) {

    var self = {};

    self.init = function () {
        $.ajax({
            url: selfUrlBegin + 'checkDisplayAutoGeneratedReport',
            success: function (response) {
                let popinHeader = $('#auto-generated-report-popin p.popin-header');
                popinHeader.html(popinHeader.text().replace('%s', response.displayDate));

                if(true === response.canDisplay
                    && isFirstTimeShown(response.idReport)
                ){
                    var autoReportLink =  $('#auto-generated-report-popin a#autogenerated-report-link')
                    autoReportLink.attr('href', autoReportLink.attr('href') + response.idReport);
                    $('#auto-generated-report-popin').modal('show');

                }
            },
        });
    };

    function isFirstTimeShown (idReport) {
        if (!window.localStorage || (localStorage.getItem( 'autogeneratedReportId') === idReport)) {
            return false;
        }
        localStorage.setItem( 'autogeneratedReportId', idReport );
        return true;
    }

    app.AutoGeneratedReport = self;

})(RoyaltiesReportManager);

//app.OneClickReport
(function (app) {

    var self = {};
    var clickOnCloseButton = false;

    function checkDisplay()
    {
        $.ajax({
            url: selfUrlBegin + 'checkDisplayOneClickReport',
            success: function (response) {
                if(true === response.canDisplay){
                    display();
                }
            },
        });
    }

    function setAvailability()
    {
        $.ajax({url: selfUrlBegin + 'setOneClickReportAvailability'});
    }

    function display()
    {
        displayTimeout = setInterval(function() {
            if (false === $('#carousel-modal').hasClass('in')) {
                clearInterval(displayTimeout);
                $.ajax({
                    url: selfUrlBegin + 'getOneClickReport',
                    success: function (response) {
                        $('body').append(response).promise().done(function(){
                            $('#handyReportPopin').modal('show');

                            $(document).on('click', '#remindMeLater', function(){
                                clickOnCloseButton = true;
                                RoyaltiesReportManager.gaEvent.sendEvent('quick_report_remind');
                                $('#handyReportPopin').modal('hide');
                            });

                            $(document).on('click', '#sendOneClickReport', function(){
                                clickOnCloseButton = true;
                                RoyaltiesReportManager.gaEvent.sendEvent('quick_report_generate');
                                $('#handyReportPopin').modal('hide');
                            });

                            $('#handyReportPopin').on('hide.bs.modal', function (e) {
                                if (false == clickOnCloseButton) {
                                    RoyaltiesReportManager.gaEvent.sendEvent('quick_report_outside');
                                }

                            });
                        });
                    },
                });
            }
        }, 1000);

    }

    function forceSteps(callback)
    {
        var nbSteps = app.Stepper.nbSteps - 1;
        var startDate = $('#startDateOneClickReport').val().split('-');
        var endDate = $('#endDateOneClickReport').val().split('-');
        $('#datetimepicker1').datepicker('setDate', startDate[0] + '-' + ("0" + startDate[1]).slice(-2));
        $('#datetimepicker2').datepicker('setDate', endDate[0] + '-' + ("0" + endDate[1]).slice(-2));

        $('#useDedicatedReport').click().promise().done(function(){
            $('#dedicatedMyReport input:eq(0)').click().promise().done(function(){

                if ($("#wizardStepGenerateReport").steps("setStep", nbSteps)) {

                    $('.steps ul[role="tablist"] li:lt('+nbSteps+')')
                        .attr('aria-disabled', 'false')
                        .attr('aria-selected', 'false')
                        .toggleClass('done', true)
                        .toggleClass('disabled', false);

                    $('.steps ul[role="tablist"] li:lt('+nbSteps+') .number').html('<i class="fa fa-check"></i>');

                    if (callback && typeof(callback) === "function") {
                        callback();
                    }
                }

            });
        });
    }

    self.init = function () {
        checkDisplay();

        $(document).on("click", "#sendOneClickReport", function () {
            setAvailability();
            forceSteps(function(){app.Stepper.askGeneration((app.Stepper.getAllStepsData()));});
        });

        $(document).on("click", "#closeOneClickReport", function () {
            setAvailability();
        });
    };

    app.OneClickReport = self;

})(RoyaltiesReportManager);

//app.Tour
(function (app) {

    var self = {};

    self.init = function () {

        $(document).on("click", "#tourReportManager_reportmanager_56e69b893670e_startTourButton", function () {

            var idChild = $('[name=childSelect]').val();

            $.ajax({
                url: selfUrlBegin + 'logUsageTour',
                data: {'idChild': idChild},
                success: function (response) {
                }
            });
        });
    };

    app.Tour = self;

})(RoyaltiesReportManager);

//app.AvailableReport
(function (app) {

    var self = {};
    self.currentTab = 'monthlyGeneratedReports';
    self.waitingRefreshReportTime = 15000;
    var myTimeout = '';
    var dataPager = '';
    var reportAlreadyLaunchList = [];
    var beginStrForTrReportId = 'report_';


    function lockReportGeneration()
    {
        RoyaltiesReportManager.Stepper.stopGenerate = true;
        $("#wizardStepGenerateReport .actions li:last a").toggleClass('disabled', true);
        $("#wizardStepGenerateReport .actions li:last a").toggleClass('loadingGenerate', true);
        $("#wizardStepGenerateReport .actions li:last a").html(VAR_LANG_REPORT_PAYMENT['LOADING_TEXT']);
    }

    function unlockReportGeneration()
    {
        RoyaltiesReportManager.Stepper.stopGenerate = false;
        $("#wizardStepGenerateReport .actions li:last a").toggleClass('disabled', false);
        $("#wizardStepGenerateReport .actions li:last a").toggleClass('loadingGenerate', false);
        $("#wizardStepGenerateReport .actions li:last a").html(VAR_LANG_LANG_COMMON["COMMON_GENERATE"]);
    }

    function showWaitingLightbox()
    {
        if($('#waitingReportBox').length > 0) {
            return false;
        }

        var boxHtml =
            '<div  id="waitingReportBox" >' +
            '<div class="waitingReportBoxBackground">' +
            '<div class="waitingReportBoxContent">' +
            '<p class="text-center">'+VAR_LANG_GLOBALS['WORK_IN_PROGRESS_WAIT']+'</p>'+
            '<p class="waitingReportMessage text-center"><i class="fa fa-circle-o-notch fa-spin fa-3x"></i></p>'+
            '</div>' +
            '</div>' +
            '</div>';

        $('#wizardStepGenerateReport').closest('div').prepend(boxHtml);
    }

    function hideWaitingLightbox()
    {
        $('#waitingReportBox').remove();
    }

    function bindConfirmOnDeleteReport() {

        $(".deleteReport").confirmation({

            title: VAR_LANG_REPORT_PAYMENT['CONFIRM_DELETE_REPORT_TEXT'],
            placement: "bottom",
            btnOkLabel: VAR_LANG_GLOBALS['YES'],
            btnCancelLabel: VAR_LANG_GLOBALS['NO'],
            onConfirm: function (e, data) {

                e.preventDefault();
                var idRequestTr = $(data).closest('tr').attr("id");
                var idRequestFinal = idRequestTr.replace(beginStrForTrReportId, "");

                $.ajax({
                    url: selfUrlBegin + 'delete/' + idRequestFinal,
                    success: function (response) {

                        if (response.statusDelete == 1) {
                            $('#' + idRequestTr).find('td').wrapInner('<div style="display: block;" /></div>').parent().find('td > div').slideUp(500);
                            setTimeout(function () {
                                $('#' + idRequestTr).remove();
                                self.getLogReport(self.currentTab);
                            }, 500);
                        }
                    }
                });
            }
        });
    }

    self.handleReportGeneration = function() {
        var idChild = $('[name=childSelect]').val();
        $.ajax({
            url: selfUrlBegin + 'isProcessLocked',
            data: 'idChild=' + idChild,
            success: function (response) {
                if(response.isProcessLocked === true) {
                    lockReportGeneration();
                    showWaitingLightbox();
                }else{
                    unlockReportGeneration();
                    hideWaitingLightbox();
                }
            }
        });
    };


    self.refreshByIntervalTimeMyRequestedReport = function () {

        clearTimeout(myTimeout);
        if (self.currentTab != 'requestedReports') {
            return false;
        }
        myTimeout = setTimeout(function () {

            var nbElFinished = $("#requestedReports .finishGenerationReport").length;
            var nbElTotal = $("#requestedReports tbody:first tr").length;

            if (nbElTotal == 0) {
                return false;
            }

            if (nbElFinished < nbElTotal) {

                self.getLogReport('requestedReports');

                setTimeout(function () {

                    nbElFinished = $("#requestedReports .finishGenerationReport").length;
                    nbElTotal = $("#requestedReports tbody:first tr").length;

                    if (nbElFinished >= nbElTotal) {
                        self.handleReportGeneration();
                    } else {
                        self.refreshByIntervalTimeMyRequestedReport(true);
                    }

                }, 7000);
            }
        }, self.waitingRefreshReportTime);
    };

    self.getLogReport = function (requestMode) {

        var requestMode = typeof requestMode !== 'undefined' ? requestMode : 'monthlyGeneratedReports';
        var timerSpecialForRefresh = 0;

        if (requestMode == 'monthlyGeneratedReports') {
            $('#requestedReports').toggleClass("active", false);
        } else {
            $('#monthlyGeneratedReports').toggleClass("active", false);
        }

        var idChild = $('[name=childSelect]').val();

        $.ajax({

            url: selfUrlBegin + 'getReports/' + requestMode,
            data: dataPager + '&idChild=' + idChild,

            success: function (response) {

                //smoothy progress Bar
                if (response.logFormattingCsvRequest !== undefined) {

                    $.each(response.logFormattingCsvRequest, function (logRequestKey, logRequestVal) {

                        if ($('#report_' + logRequestVal['id']).find('.progress-bar').length > 0) {

                            timerSpecialForRefresh = 2000;

                            if ((logRequestVal['finalPercentProgress'] == 100) && (logRequestVal['statusNumber'] != 2)) {
                                logRequestVal['finalPercentProgress'] = 99;
                            }

                            $('#report_' + logRequestVal['id']).find('.progress-bar').css('width', logRequestVal['finalPercentProgress'] + '%');
                            $('#report_' + logRequestVal['id']).find('.progress-bar').html(logRequestVal['finalPercentProgress'] + '%');
                            $('#report_' + logRequestVal['id']).find('.progress-bar').attr('data-original-title', logRequestVal['statusDisplay']);
                        }
                    });
                }
                //end smoothy progress Bar

                if ((requestMode == 'monthlyGeneratedReports')) {
                    //$('#monthlyGeneratedReports').html(response.logRender).toggleClass("active", true);
                    $('#monthlyGeneratedReports').toggleClass("active", true);
                    $('#pregen-reports').DataTable({
                        dom: 'tp',
                        destroy: true,
                        paging: true,
                        pagingType: 'numbers',
                        info: false,
                        ordering: false,
                        data: response.result,
                        columns: [
                            {data: 'period'},
                            {data: 'reportType'},
                            {data: 'formattedTotalInCurrency'},
                            {
                                data: 'status',
                                className: 'text-center',
                                render: function (data, type, row) {
                                    if (isVisitor) {
                                        if (data === 2) {
                                            return '<i class="fa fa-check finishGenerationReport" data-toggle="tooltip" title="' + row.statusDisplay + '"></i>';
                                        } else if (data === 0 || data === 1) {
                                            return '<i class="fa fa-spinner fa-spin" data-toggle="tooltip" title="' + row.statusDisplay + '"></i>';
                                        } else {
                                            return '<i class="fa fa-spinner fa-exclamation" data-toggle="tooltip" title="' + row.statusDisplay + '"></i>';
                                        }
                                        return row.statusDisplay;

                                    } else {
                                        if (data === 6) {
                                            return '<i class="fa fa-check finishGenerationReport" data-toggle="tooltip" title="Success"></i>';
                                        }
                                        return '<i class="fa fa-spinner fa-spin" data-toggle="tooltip" title="In progress"></i>';
                                    }
                                }
                            },
                            {
                                data: 'reportPath',
                                className: 'text-center td-flex',
                                render: function (data, type, row) {
                                    if (isVisitor) {
                                        if (row.status === 2) {
                                            return '<a class="fa fa-download"  href="' + selfUrlBegin + 'download/' + row.id + '" data-toggle="tooltip"></a>';
                                        }
                                        return '';
                                    } else {
                                        if (data) {
                                            let dateFrom = row.dateFrom;
                                            let dateTo = row.dateTo;
                                            let createdAt = row.createdAt;
                                            return '' +
                                                '<a class="fa fa-download"  onclick="downloadReport(\''+ row.id +'\', \''+ row.fileName + '\')" data-toggle="tooltip"></a>'
                                             +  '<a style="    font-size: large;\n' +
                                                '    color: black;\n' +
                                                '    padding-left: 10px;cursor: pointer;" class="fa fa-file-pdf-o fa-4"  onclick="downloadPdfReport(\''+ row.id +'\', \''+ dateFrom + '\', \''+ dateTo +'\', \''+ row.period +'\', \''+ createdAt +'\')" data-toggle="tooltip"></a>';
                                        }
                                        return '';
                                    }
                                }
                            }
                        ],
                        pageLength: 5,
                    });

                    if (response.result.length == 0) {
                        $("#availableReport .nav-tabs").toggle(false);
                        self.currentTab = 'requestedReports';
                        self.getLogReport('requestedReports');
                        return false;
                    } else {
                        $("#availableReport .nav-tabs").toggle(true);
                    }
                }

                if ((requestMode == 'requestedReports')) {
                    $('#requestedReports').html('');
                    setTimeout(function () {
                        $('#requestedReports').html(response.logRender).toggleClass("active", true);
                    }, timerSpecialForRefresh);
                }

                setTimeout(function () {
                    $("[data-toggle='tooltip']").bootstrapTooltip({html: true});
                    bindConfirmOnDeleteReport();
                }, timerSpecialForRefresh + 300);
            }
        });
        downloadReport = function (idReport, reportPath) {

            // Use split to get an array of path components
            let pathComponents = reportPath.split('/');
            // Get the last element of the array (which is the filename)
            let reportFileName = pathComponents[pathComponents.length - 1];

            // Use split to get an array of filename and extension
            let fileNameComponents = reportPath.split('.');
            // Get the last element of the array (which is the file extension)
            let reportFileExtension = fileNameComponents[fileNameComponents.length - 1];

            pushEventForTracking('file_download', {
                file_extension: '.' + reportFileExtension,
                file_name: reportFileName,
                file_type: reportType
            });

            $.ajax({
                url: selfUrlBegin + 'pregenDownload',
                data: 'idReport=' + idReport,
                success: function (response) {
                    if (response.url === undefined || response.url.length === 0) {
                        window.location.href = selfUrlBegin + '?errorDownload=1';
                    } else {
                        window.open(response.url);
                    }
                }
            });
        }
        downloadPdfReport= function (idReport, dateFrom, dateTo, periodicity, createdAt) {
            let url = selfUrlBegin + 'pregenDownloadPdf';
            url += '?idReport=' + idReport + '&dateFrom=' + dateFrom + '&dateTo=' + dateTo + '&periodicity=' + periodicity + '&createdAt=' + createdAt;
            pushEventForTracking('file_download', {
                file_extension: '.pdf',
                file_name: 'report_' + periodicity,
                file_type: 'automatic reports'
            });
            window.open(url, '_blank');
        }
        self.refreshByIntervalTimeMyRequestedReport();
    };
    self.getPregeneratedReport = function () {
        var idChild = $('[name=childSelect]').val();
        $.ajax({
            url: selfUrlBegin + 'getReportsPregen',
            success: function (response) {
            }
        });
    }

    self.init = function () {

        //pager
        $(document).on("click", "#requestedReports .pager-list li a", function (e) {
            e.preventDefault();
            reportAlreadyLaunchList = [];
            var nextUrl = $(this).attr('href');
            var getParametersStart = nextUrl.indexOf('?');
            var getParameters = nextUrl.substr(getParametersStart + 1);
            dataPager = getParameters;
            self.getLogReport(self.currentTab);
        });

        //tab monthly or requested
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            //shown.bs.tab is bootstrap js
            reportAlreadyLaunchList = [];
            dataPager = '';//important to reload pager
            var strLink = e.target.toString();
            var chooseNav = strLink.substr(strLink.indexOf("#") + 1, strLink.length);
            self.currentTab = chooseNav;
            self.getLogReport(chooseNav);
        });

        self.getLogReport();
    };

    app.AvailableReport = self;

})(RoyaltiesReportManager);

//app.Stepper
(function (app) {

    var self = {};
    self.stopGenerate = false;
    self.nbSteps = 4;
    self.jump = false;

    self.getAllStepsData = function() {

        var idChild = $('[name=childSelect]').val();

        var data = {
            'idChild': idChild,
            'scopeDateFrom': app.Stepper.Generate.scopeDateFromStr,
            'scopeDateTo': app.Stepper.Generate.scopeDateToStr,
            'reportType': app.Stepper.Generate.reportType,
            'dedicatedPrecision': app.Stepper.Generate.dedicatedPrecisionStr,
            'dedicatedOptionsList': app.Stepper.Generate.dedicatedOptionsList,
            'splitPrecision': app.Stepper.Generate.splitPrecisionStr,
            'templateType': app.Stepper.Generate.templateType
        };

        return data;
    };

    function addAnalytics(currentIndex, newIndex)
    {
        if (newIndex < currentIndex) {
            var tagList = [];
            tagList[0] = 'period_tab';
            tagList[1] = 'type_tab';
            tagList[2] = 'columns_tab';

            if(tagList[newIndex]) {
                RoyaltiesReportManager.gaEvent.sendEvent(tagList[newIndex]);
            }
        }
    }

    function changeStepTitle(curIndex) {
        var corr = [];
        corr[0] = 'PERIOD';
        corr[1] = 'REPORT_TYPE';

        if (isVisitor) {
            corr[2] = 'GENERATE';
        } else {
            corr[2] = 'CUSTOM_REPORT';
            corr[3] = 'GENERATE';
        }

        var oldHtml = '';
        var newHtml = '';

        $.each(corr, function (key, val) {
            oldHtml = $('#wizardStepGenerateReport-t-' + key).html();
            newHtml = oldHtml.replace(VAR_LANG_REPORT_PAYMENT['SELECTED_STEPPER_' + val + '_TEXT'], VAR_LANG_REPORT_PAYMENT['UNSELECT_STEPPER_' + val + '_TEXT']);
            $('#wizardStepGenerateReport-t-' + key).html(newHtml);
        });

        oldHtml = $('#wizardStepGenerateReport-t-' + curIndex).html();
        newHtml = oldHtml.replace(VAR_LANG_REPORT_PAYMENT['UNSELECT_STEPPER_' + corr[curIndex] + '_TEXT'], VAR_LANG_REPORT_PAYMENT['SELECTED_STEPPER_' + corr[curIndex] + '_TEXT']);
        $('#wizardStepGenerateReport-t-' + curIndex).html(newHtml);
    }

    function isNextStepPossible(currentStep, alertMe, newIndex) {

        var isNextStepPossible = true;
        var alertMe = typeof alertMe !== 'undefined' ? alertMe : false;
        var newIndex = typeof newIndex !== 'undefined' ? newIndex : false;
        var lastIndex = (isVisitor) ? 2 : 3;

        //LITTLE STOP STEP 1
        if (currentStep == 0) {
            if ($('#datetimepicker1').datepicker('getDate') == null || $('#datetimepicker2').datepicker('getDate') == null) {
                isNextStepPossible = false;
            }

            if (newIndex > currentStep) {
                RoyaltiesReportManager.gaEvent.sendEvent('period_to_type');
                let startDate = new Date($('#datetimepicker1').datepicker('getDate'));
                let endDate = new Date($('#datetimepicker2').datepicker('getDate'));

                pushEventForTracking('search', {
                    search_period_from: moment(startDate).format('DD-MM-YYYY'),
                    search_period_to: moment(endDate).format('DD-MM-YYYY')
                });
            }
        }

        if (currentStep == 1) {
            if ($('#reportType').val() == '') {
                isNextStepPossible = false;
            } else {
                if ($('#reportType').val() == 'useDedicatedReport') {
                    if (app.Stepper.Report.getAllDedicatedOptionId().length == 0) {
                        isNextStepPossible = false;
                        if (alertMe) {
                            if ($('#selectDedicatedMyReport ul').length == 0) {
                            }
                        }
                    }
                }
                if ($('#reportType').val() == 'useSplitReport') {
                    if (!$("#splitMyReport input[name='splitReport']").is(':checked')) {
                        isNextStepPossible = false;
                    }
                }
            }

            if(newIndex > currentStep) {
                RoyaltiesReportManager.gaEvent.sendEvent('type_to_columns');
                pushEventForTracking('financial_report_step', {
                    step_name: reportOption
                });
            }
        }

        if (currentStep == 2) {
            if ($('#templateType').val() == '') {
                isNextStepPossible = false;
            } else {

                if (!isVisitor) {
                    if ($('#templateType').val() == 'useCustomizedCsv') {
                        //forced layout if breakdown report
                        if ($('#fieldSectionToCustomizeCsv li').length > 0) {
                            app.Stepper.Custom.handleForcedSelectToCustomizeCsv();
                            isNextStepPossible = app.Stepper.Custom.verifyCoherenceEachSelect();
                        }


                        if (isNextStepPossible) {
                            if (newIndex) {
                                app.Stepper.Custom.saveCsvLayout();
                            }
                        }
                    }
                }
            }

            if(newIndex > currentStep) {
                RoyaltiesReportManager.gaEvent.sendEvent('columns_to_generate');
                pushEventForTracking('financial_report_step', {
                    step_name: 'columns'
                });
            }
        }

        if (newIndex !== undefined) {
            if (newIndex == lastIndex) {
                if (isNextStepPossible) {
                    app.Stepper.Generate.fillSummary();
                    if ($("#wizardStepGenerateReport .actions li:last a").hasClass('loadingGenerate')) {
                        $("#wizardStepGenerateReport .actions li:last a").toggleClass('disabled', true);
                    }
                }

                if(newIndex > currentStep) {
                    RoyaltiesReportManager.gaEvent.sendEvent('generate_generate');
                    pushEventForTracking('financial_report_step', {
                        step_name: 'generate'
                    });

                }
            }
        }

        return isNextStepPossible;
    }

    function forceLegacySummary()
    {
        $('#templateType').val('useLegacyCsv');
        self.jump = true;
        if($("#wizardStepGenerateReport").steps("setStep", (self.nbSteps - 1))) {

            $('.steps ul[role="tablist"] li:eq(2)')
                .attr('aria-disabled', 'true')
                .attr('aria-selected', 'true')
                .toggleClass('done', false)
                .toggleClass('disabled', true);

            self.jump = false;
        }
    }

    self.askGeneration = function(dataToSend)
    {
        $.ajax({
            url: selfUrlBegin + 'askCsvGeneration',
            type: "POST",
            data: dataToSend,
            success: function (response) {

                if (typeof response.error === "undefined") {
                    RoyaltiesReportManager.AvailableReport.handleReportGeneration();

                    if (app.AvailableReport.currentTab != 'requestedReports') {
                        $('#hrefToRequestedReports').click();
                    } else {
                        app.AvailableReport.currentTab = 'requestedReports';
                        app.AvailableReport.getLogReport('requestedReports');
                    }
                } else {
                    app.ManageError.displayAModalError(response.error);
                }

            }
        });
    };

    self.resizeHeightJquerySteps = function (addHeight) {
        var addHeight = typeof addHeight !== 'undefined' ? addHeight : 0;
        setTimeout(function () {
            $('.wizard .content').height($('.body.current div:first').outerHeight() + 50 + addHeight);
        }, 100);
    };

    function handleCustom()
    {
        if (true === app.Stepper.Custom.firstTimeCreateCsv) {
            app.Stepper.Custom.handleForcedSelectToCustomizeCsv();
            app.Stepper.resizeHeightJquerySteps();
        } else {
            app.Stepper.Custom.createSelectToCustomizeCsv();
            app.Stepper.Custom.firstTimeCreateCsv = true;
        }

        $("#templateType").val('useCustomizedCsv');
    }

    self.init = function () {

        if (isVisitor) {
            self.nbSteps = 3;
        }

        $(window).resize(function () {
            self.resizeHeightJquerySteps(50);
        });

        
    };

    app.Stepper = self;

})(RoyaltiesReportManager);

//app.Stepper.Scope
(function (app) {
    let self = {
        datepickerFrom : null,
        datepickerTo : null,
        maxNbSelectedMonths : 2,
        datepickerFormat: 'YYYY-MM'
    };

    self.accountingDate = moment().subtract(2, "months");
    self.blvStartDate = moment('2005-01-01');

    if (maxReportEndDate !== null) {
        self.accountingDate = moment(maxReportEndDate);
    }

    self.pickerOptions = {
        format: 'yyyy-mm',
        minViewMode: 'months',
        maxViewMode: 'years',
        endDate: self.accountingDate.format(self.datepickerFormat),
        startDate: self.blvStartDate.format(self.datepickerFormat),
        language: clientLanguage
    };

    self.init = function (elementFrom, elementTo) {
        self.datepickerFrom = $(elementFrom);
        self.datepickerTo = $(elementTo);

        self.datepickerFrom.datepicker(self.pickerOptions);
        self.datepickerTo.datepicker(self.pickerOptions);
        self.datepickerTo.datepicker('setStartDate', self.accountingDate.clone().subtract(self.maxNbSelectedMonths, "months").format(self.datepickerFormat));

        self.datepickerFrom.datepicker('update', self.accountingDate.format(self.datepickerFormat));
        self.datepickerTo.datepicker('update', self.accountingDate.format(self.datepickerFormat));
        self.setNextStepActionStatus();

        self.datepickerFrom.datepicker().on('changeDate', self.fromDatepickerChange);
        self.datepickerFrom.datepicker().on('changeDate', self.updateTooltips);

        self.updateTooltips();
    };

    self.updateTooltips = function (e) {
        self.datepickerTo.find('.month.disabled').prop('title', window.disabledMonthsTooltip).tooltip();
    };

    self.fromDatepickerChange = function (e) {
        e.stopPropagation();

        let fromDate = moment(self.datepickerFrom.datepicker('getDate'));
        self.setDateRange(self.datepickerTo, fromDate, self.plusDateRange(fromDate));
        self.setNextStepActionStatus();
    };

    self.setDateRange = function (elementPicker, minDate, maxDate) {
        let currentMinDate = moment(elementPicker.datepicker('getStartDate'));
        if (currentMinDate.format(self.datepickerFormat) !== minDate.format(self.datepickerFormat)) {
            elementPicker.datepicker('setStartDate', minDate.format(self.datepickerFormat));
            elementPicker.datepicker('setEndDate', maxDate.format(self.datepickerFormat));
            elementPicker.datepicker('update', minDate.format(self.datepickerFormat));
        }
    }

    self.plusDateRange = (date) => {
        let plusDate = date.clone().add(self.maxNbSelectedMonths, 'months');
        return moment.min(self.accountingDate, plusDate);
    }

    self.setNextStepActionStatus = () => {
        let toDate = self.datepickerTo.datepicker('getDate'),
            fromDate = self.datepickerFrom.datepicker('getDate');
        $(".wizard .actions li a").toggleClass('disabled', toDate == null || fromDate == null);
    };

    app.Stepper.Scope = self;
})(RoyaltiesReportManager);

//app.Countries
(function (app) {

    var self = {};
    self.selectedCountries = [];

    function resetCountries()
    {
        $("input[name='countries[]']").prop('checked', false);
        $("input[name='countries[]']").each(function( index ) {
            if (self.selectedCountries.indexOf($(this).val()) >= 0) {
                $(this).prop('checked', true);
            }
        });
    }

    function handleGeneralEvent()
    {
        self.displayNumberCountries();
        $totalCountriesChecked = $('.lr-inputCountry:checked').length;
        if($totalCountriesChecked > 0) {
            $(".wizard .actions li a").toggleClass('disabled', false);
        }else{
            $(".wizard .actions li a").toggleClass('disabled', true);
        }
    }

    self.displayAModalCountries = function() {

        $.ajax({
            url: selfUrlBegin + 'getCountriesForm',
            success: function (response) {
                $('#selectDedicatedMyReport').html(response).promise().done(function(){
                    self.displayNumberCountries();

                    $('#territoriesSelectorPopin').on('show.bs.modal, hide.bs.modal', function (e) {
                        resetCountries();
                        handleGeneralEvent();
                    });

                    $(document).on('change', '.lr-inputCountry', function() {
                        handleGeneralEvent();
                    });

                    $(document).on('click', '#territoriesSelectorPopinValidationButton', function() {
                        self.selectedCountries = $("input[name='countries[]']:checked").map(function() {return $(this).val();}).get();
                        $('#territoriesSelectorPopin').modal('hide');
                    });

                });
            }
        });
    };

    self.displayNumberCountries = function() {
        $totalCountries = $('.lr-inputCountry').length;
        $totalCountriesChecked = $('.lr-inputCountry:checked').length;

        if ($totalCountries == $totalCountriesChecked) {
            $('#territoriesSelectorCounter').html(VAR_LANG_GLOBALS['GLOBAL_ALL_TEXT']);
        } else {

            var territoriesWord = VAR_LANG_GLOBALS['GLOBAL_TERRITORIES_TEXT'];
            if($totalCountriesChecked < 2) {
                territoriesWord = VAR_LANG_GLOBALS['GLOBAL_TERRITORY_TEXT'];
            }

            $('#territoriesSelectorCounter').html($totalCountriesChecked + ' ' + territoriesWord);
        }
    };

    self.init = function () {

    };

    app.Countries = self;

})(RoyaltiesReportManager);

//app.Stepper.Report
(function (app) {

    var self = {};

    function launchSelect2ForAutoCompletion(type) {

        var mapReplace = {
            atLeastLabel: 'label',
            atLeastRelease: 'release',
            atLeastTrack: 'track',
            atLeastArtist: 'artist',
        };

        type = type.replace(/atLeastLabel|atLeastRelease|atLeastTrack|atLeastArtist/gi, function (matched) {
            return mapReplace[matched];
        });

        if (type == 'atLeastStore') {

            var dataStores = [];
            jQuery.each(storeList, function(index, item) {
                dataStores.push({id:index,text:item});
            });
            $(".dedicatedReportSelect").select2({
                minimumInputLength: 3,
                separator: ",",
                data: dataStores,
                multiple: true,
                formatNoMatches: function (term) {
                    return VAR_LANG_REPORT_PAYMENT['INPUT_NO_MATCHES_FOUND_TEXT'];
                },
                formatSearching: function () {
                    return VAR_LANG_REPORT_PAYMENT['INPUT_SEARCHING_TEXT'];
                },
                formatInputTooShort: function (term, minLength) {
                    var rest = minLength - term.length;
                    return VAR_LANG_REPORT_PAYMENT['INPUT_TOO_SHORT_TEXT'].replace("%number%", rest);
                }
            });
        }else{
            $(".dedicatedReportSelect").select2({

                minimumInputLength: 3,
                separator: "|",
                multiple: true,
                ajax: {
                    url: 'search/' + type,
                    dataType: "json",
                    quietMillis: 500,
                    data: function (term, page) {
                        return {
                            term: term,
                        };
                    },
                    results: function (data, page) {
                        return {
                            results: data
                        };
                    }
                },

                id: function (result) {
                    return result.id;
                },
                formatResult: function (result) {
                    return result.name;
                },
                formatSelection: function (result) {
                    return result.name;
                },
                formatNoMatches: function (term) {
                    return VAR_LANG_REPORT_PAYMENT['INPUT_NO_MATCHES_FOUND_TEXT'];
                },
                formatSearching: function () {
                    return VAR_LANG_REPORT_PAYMENT['INPUT_SEARCHING_TEXT'];
                },
                formatInputTooShort: function (term, minLength) {
                    var rest = minLength - term.length;
                    return VAR_LANG_REPORT_PAYMENT['INPUT_TOO_SHORT_TEXT'].replace("%number%", rest);
                }
            });
        }
    }

    self.getAllDedicatedOptionId = function () {

        var optionListMultipleArray = $('.dedicatedReportSelect').select2('data');
        var optionChosen = $('input[name=dedicatedReport]:checked').val();
        var finalOptionList = [];

        if (optionChosen == 'allCatalog') {
            return 'allCatalog';
        }

        if (optionChosen == 'atLeastCountry') {
            finalOptionList = app.Countries.selectedCountries;
        } else {
            $.each(optionListMultipleArray, function (optionListMultipleArrayKey, oneArrayOptions) {
                if(optionChosen == 'atLeastStore') {
                    finalOptionList.push(oneArrayOptions.id);
                }else{
                    var splitId = oneArrayOptions['id'].split(',');
                    $.each(splitId, function (splitIdKey, splitIdVal) {
                        finalOptionList.push(splitIdVal);
                    });
                }
            });
        }

        return finalOptionList;
    };

    self.getAllDedicatedOptionName = function () {

        var optionListMultipleArray = $('.dedicatedReportSelect').select2('data');
        var optionChosen = $('input[name=dedicatedReport]:checked').val();
        var finalOptionList = [];

        $.each(optionListMultipleArray, function (optionListMultipleArrayKey, oneArrayOptions) {
            if(optionChosen == 'atLeastStore') {
                finalOptionList.push(oneArrayOptions.text);
            }else{
                finalOptionList.push(oneArrayOptions['name']);
            }

        });

        return finalOptionList;
    };

    function handleReportButton()
    {
        $('#useDedicatedReport, #useLegacyDedicatedReport').toggleClass('like-btn-primary-outline', true).toggleClass('like-btn-primary', false);
        $('#useSplitReport').find('.subSquare_3').toggleClass('like-btn-primary-outline', true).toggleClass('like-btn-primary', false);
        $('#selectDedicatedMyReport').html('');

        $('#dedicatedMyReport').hide();
        $('#splitMyReport').hide();
    }

    self.init = function () {

        $(document).on('click', '#useDedicatedReport, #useLegacyDedicatedReport', function (e) {
            handleReportButton();
            $("#reportType").val($(this).attr('id'));
            $(this).toggleClass('like-btn-primary', true).toggleClass('like-btn-primary-outline', false);
        });

        $(document).on("click", "#useDedicatedReport", function (e) {
            $(".wizard .actions li a").toggleClass('disabled', true);
            $('#selectDedicatedMyReport').html('');
            $('#dedicatedMyReport').slideToggle('slow');
            $('input[name="dedicatedReport"]').prop('checked', false);
            $('#dedicatedReportAllCatalog').prop('checked', true);
            $(".wizard .actions li a").toggleClass('disabled', false);
        });

        $(document).on("click", "#useLegacyDedicatedReport", function (e) {
            $(".wizard .actions li a").toggleClass('disabled', false);
        });

        $(document).on("click", "#useSplitReport", function (e) {
            handleReportButton();
            $("#reportType").val($(this).attr('id'));
            $(this).find('.subSquare_3').toggleClass('like-btn-primary', true).toggleClass('like-btn-primary-outline', false);
            $(".wizard .actions li a").toggleClass('disabled', true);
            $('#splitMyReport').slideToggle('slow');
            $('input[name="splitReport"]').prop('checked', false);
        });

        $(document).on("click", "#dedicatedReportAllCatalog", function (e) {
            $('#selectDedicatedMyReport').html('');
            $(".wizard .actions li a").toggleClass('disabled', false);
        });

        $(document).on("click", "#dedicatedMyReport input[name='dedicatedReport']:not(#dedicatedReportCountry):not(#dedicatedReportAllCatalog)", function (e) {
            $(".wizard .actions li a").toggleClass('disabled', true);
            var placeHolderText = $(this).closest('label').find('span:first').text();
            $('#selectDedicatedMyReport').html('<input type="hidden" class="dedicatedReportSelect form-control" placeholder="' + placeHolderText + '" />');
            launchSelect2ForAutoCompletion($(this).val());
            app.Stepper.resizeHeightJquerySteps();
        });

        $(document).on("click", "#dedicatedReportCountry", function (e) {
            $(".wizard .actions li a").toggleClass('disabled', true);
            $('#selectDedicatedMyReport').html('<div class="text-center"><i class="fa fa-circle-o-notch fa-spin fa-2x"></i></div>');
            app.Countries.displayAModalCountries();
            app.Stepper.resizeHeightJquerySteps();
        });

        $(document).on("change", "#selectDedicatedMyReport .dedicatedReportSelect", function (e) {
            $(".wizard .actions li a").toggleClass('disabled', false);
            app.Stepper.resizeHeightJquerySteps();
        });

        $(document).on("change", "#splitMyReport input[name='splitReport']", function (e) {
            $(".wizard .actions li a").toggleClass('disabled', false);
        });
    };

    app.Stepper.Report = self;

})(RoyaltiesReportManager);

//app.Stepper.Custom
(function (app) {

    var self = {};
    self.firstTimeCreateCsv = false;
    self.lastForcedSelect = '';
    var lastIndice = 90; //Z in ASCII
    var firstIndice = 65; //A in ASCII
    var nbLetterMax = 50;
    var defaultLayoutWithCategory = [];
    var standardLayout = {'TCT.blank': 'TCT.blank'};

    function renameAllColumns() {

        var currrentLetterInt = firstIndice;
        var otherLetterToComplete = '';
        var nbElUse = 0;
        var nbEl = lastIndice - firstIndice + 1;

        $("#fieldSectionToCustomizeCsv li .beginColumnTitle .nbLetterAscii").each(function () {

            if (currrentLetterInt > lastIndice) {//AA or AB

                var numberMaybeMultiple = nbElUse / nbEl;

                if ((parseFloat(numberMaybeMultiple) == parseInt(numberMaybeMultiple)) && !isNaN(numberMaybeMultiple)) { // if not a float it s a multiple
                    otherLetterToComplete = firstIndice + numberMaybeMultiple - 1;
                    otherLetterToComplete = String.fromCharCode(otherLetterToComplete);
                    currrentLetterInt = firstIndice;
                }
            }

            $(this).text(otherLetterToComplete + String.fromCharCode(currrentLetterInt));
            currrentLetterInt = currrentLetterInt + 1;
            nbElUse++;

        });

    }

    function getNbOccurencesOption(optionValue) {
        valueOptionList = getAllSelectValue();

        nbOccurances = jQuery.grep(valueOptionList, function (nb) {
            return nb == optionValue
        }).length;

        return nbOccurances;
    }

    function addForcedSelectToCustomizeCsv(layoutList) {
        $.each(layoutList, function (keyForcedLayout, valForcedLayout) {

            if (getNbOccurencesOption(keyForcedLayout) > 0) {
                return;
            }

            htmlSelectForced = createForcedSelectElement(keyForcedLayout, valForcedLayout);
            $('#fieldSectionToCustomizeCsv').prepend('<li class="scopeSection panel-default forcedLayoutDisable">' + htmlSelectForced + '</li>');
        });

    }

    function createForcedSelectElement(keyForcedLayout, valForcedLayout) {
        htmlSelectForced = '<h6 class="text-center text-muted beginColumnTitle">' + VAR_LANG_REPORT_PAYMENT['COLUMN_TEXT'] + ' <span class="nbLetterAscii"></span></h6>';
        htmlSelectForced += '<i class="fa fa-ellipsis-v"></i>';
        htmlSelectForced += ' <i class="fa fa-ban invisible"></i>';
        htmlSelectForced += '<select disabled class="select2Basic disabled">';
        htmlSelectForced += '<option value="' + keyForcedLayout + '">' + valForcedLayout + '</option>';
        htmlSelectForced += '</select>';

        return htmlSelectForced;
    }

    function holdForcedSelectToCustomizeCsv(layoutList) {
        $.each(layoutList, function (keyForcedLayout, valForcedLayout) {

            $("#fieldSectionToCustomizeCsv select").each(function () {

                if ($(this).val() == keyForcedLayout) {
                    htmlSelectForced = createForcedSelectElement(keyForcedLayout, valForcedLayout);
                    $(this).closest('li').addClass('forcedLayoutDisable').html(htmlSelectForced);
                }
            });
        });
    }

    function createOneSelect(defaultOption, typeAdd, elToReplace) {

        var h6 = $('<h6 class="text-center text-muted beginColumnTitle">' + VAR_LANG_REPORT_PAYMENT['COLUMN_TEXT'] + ' <span class="nbLetterAscii"></span></h6>');
        var moveAndRemoveIcon = $('<i class="fa fa-ellipsis-v gaEvent" data-ga-event-type="columns_move"></i><i class="blv-font blv-font-remove gaEvent" data-ga-event-type="columns_delete"></i>');
        var selectButton = $('<select class="select2Basic"></select>');
        var promises = [];

        $.each(defaultLayoutWithCategory, function (key, val) {

            var dfd = $.Deferred();

            optGroup = $('<optgroup label="' + key + '"></optgroup>');

            selectButton.append('<optgroup label="' + key + '">');

            $.each(val, function (subKey, subVal) {

                selectedOption = '';

                if (subKey == defaultOption) {
                    selectedOption = 'selected="selected"';
                }

                optGroup.append('<option ' + selectedOption + ' value="' + subKey + '">' + subVal + '</option>');
                dfd.resolve();

            });

            selectButton.append(optGroup);
            promises.push(dfd);
        });

        $.when.apply($, promises).done(function() {
            selectButton.find('option[value*="blank"]').prependTo(selectButton);

            switch (typeAdd) {
                case 'producerOrigin':
                    var li = $('<li class="scopeSection panel-default producerCustomOrigin"></li>');
                    li.append(h6).append(moveAndRemoveIcon).append(selectButton.prop('outerHTML'));
                    $('#fieldSectionToCustomizeCsv').append(li);
                    break;
                case 'producerNotOrigin':
                    var li = $('<li class="scopeSection panel-default"></li>');
                    li.append(h6).append(moveAndRemoveIcon).append(selectButton.prop('outerHTML'));
                    $('#fieldSectionToCustomizeCsv').append(li);
                    break;
                case 'replaceThisEl':
                    elToReplace.html('');
                    elToReplace.append(h6).append(moveAndRemoveIcon).append(selectButton.prop('outerHTML'));
                    break;
            }

        });

    }

    function createTemplate(list, callback)
    {
        $('#fieldSectionToCustomizeCsv li.producerCustomOrigin').remove();
        $.each(list, function (keyCustomlLayout, valCustomlLayout) {

            if (keyCustomlLayout.indexOf('TCT.blank') >= 0) {
                keyCustomlLayout = 'TCT.blank';
            }

            createOneSelect(keyCustomlLayout, 'producerOrigin', false);
        });

        //move blank choice in first position
        $("#fieldSectionToCustomizeCsv select").each(function () {
            $(this).find('option[value*="blank"]').prependTo(this);
        });
        $(".select2Basic").select2('destroy');//important to reload select2
        $(".select2Basic").select2();
        $('#addSelectForCsv').toggleClass('disabled', false);
        renameAllColumns();

        var nbUseLetter = $("#fieldSectionToCustomizeCsv select").length;

        if (nbUseLetter >= nbLetterMax) {
            $('#addSelectForCsv').toggleClass('disabled', true);
        }

        //Sortable li
        $("#fieldSectionToCustomizeCsv").sortable({
            items: "li:not(.scopeSectionForButton)",
            update: function (event, ui) {
                RoyaltiesReportManager.gaEvent.sendEvent('columns_move');
                renameAllColumns();
            },
            placeholder: "portlet-placeholder",
            //connectWith: "#fieldSectionToCustomizeCsv",
            containment: "parent",
            tolerance: 'pointer'
        }).promise().done(function(){
            self.handleForcedSelectToCustomizeCsv();
            app.Stepper.resizeHeightJquerySteps();
        });




    }

    function getAllSelectValue() {
        var valueOptionList = [];
        $("#fieldSectionToCustomizeCsv select").each(function () {
            valueOptionList.push($(this).val());
        });
        return valueOptionList;
    }

    function replaceAllOriginForcedSelectToCustomizedCsv() {

        $("#fieldSectionToCustomizeCsv .forcedLayoutDisable.producerCustomOrigin").each(function () {

            createOneSelect($(this).find('select').val(), 'replaceThisEl', $(this));
            $(this).removeClass('forcedLayoutDisable');

        });
    }

    function removeAllForcedSelectToCustomizedCsv() {
        $("#fieldSectionToCustomizeCsv .forcedLayoutDisable").not('.producerCustomOrigin').remove();
    }

    self.createSelectToCustomizeCsv = function() {

        $.ajax({
            url: selfUrlBegin + 'getTemplateToCustomizeCsv',
            beforeSend: function(){
                $( '<div id="loaderCustomize" class="text-center"><i class="fa fa-circle-o-notch fa-spin fa-3x"></i></div>').insertAfter( "#fieldSectionToCustomizeCsv");
            },
            success: function (response) {

                if (response.error !== undefined) {
                    app.ManageError.displayAModalError(response.error);
                    return false;
                }

                var selectedOption = '';

                if (typeof response.standardLayout !== "undefined") {
                    standardLayout = response.standardLayout;
                }

                if (response.customizedLayout === undefined || response.customizedLayout == null || response.customizedLayout.length == 0) {
                    response.customizedLayout = standardLayout;
                }

                defaultLayoutWithCategory = response.defaultLayoutWithCategory;

                createTemplate(response.customizedLayout);

            },
            complete: function () {
                $('#loaderCustomize').remove();
            },
        });
    }

    self.saveCsvLayout = function () {
        var nbElement = $("#fieldSectionToCustomizeCsv select").length;
        var fieldsPosted = 'a:' + nbElement + ':{';

        $("#fieldSectionToCustomizeCsv select").each(function (i) {
            var nbChar = $(this).val().length;
            fieldsPosted += 'i:' + i + ';s:' + nbChar + ':"' + $(this).val() + '";';
        });

        fieldsPosted += '}';

        $.ajax({
            url: selfUrlBegin + 'saveCsvLayout',
            data: {'customReportSelectList': fieldsPosted},
            success: function (response) {

                if (response.error !== undefined) {
                    app.ManageError.displayAModalError(response.error);
                }
            }
        });
    };

    self.handleForcedSelectToCustomizeCsv = function () {
        //forced layout if breakdown report
        var splitVal = $("#splitMyReport input[name='splitReport']:checked").val();
        var reportType = $('#reportType').val();

        if (splitVal !== undefined && reportType == 'useSplitReport') {

            if(self.lastForcedSelect == splitVal) {
                if ($('#fieldSectionToCustomizeCsv .forcedLayoutDisable').length > 0) {
                    return false;
                }

            }else{
                self.lastForcedSelect = splitVal;
            }

            switch (splitVal) {
                case 'perLabels':
                    forcedLayout = {'LAB.label': defaultLayoutWithCategory[VAR_LANG_STATEMENT_DETAILS['CSV_CATALOG_SECTION']]['LAB.label']};
                    break;
                case 'perArtists':
                    forcedLayout = {'ART.artist': defaultLayoutWithCategory[VAR_LANG_STATEMENT_DETAILS['CSV_CATALOG_SECTION']]['ART.artist']};
                    break;
                case 'perReleases':
                    forcedLayout = {'ALB.album': defaultLayoutWithCategory[VAR_LANG_STATEMENT_DETAILS['CSV_CATALOG_SECTION']]['ALB.album']};
                    break;
                case 'perStores':
                    forcedLayout = {'TCT.name': defaultLayoutWithCategory[VAR_LANG_STATEMENT_DETAILS['CSV_ROYALTIES_SECTION']]['TCT.name']};
                    break;
                case 'perCountries':
                    forcedLayout = {'R.isoCountry': defaultLayoutWithCategory[VAR_LANG_STATEMENT_DETAILS['CSV_ROYALTIES_SECTION']]['R.isoCountry']};
                    break;
            }

            removeAllForcedSelectToCustomizedCsv();
            replaceAllOriginForcedSelectToCustomizedCsv();
            addForcedSelectToCustomizeCsv(forcedLayout);
            holdForcedSelectToCustomizeCsv(forcedLayout);

        } else {
            self.lastForcedSelect = '';
            removeAllForcedSelectToCustomizedCsv();
            replaceAllOriginForcedSelectToCustomizedCsv();
        }

        renameAllColumns();
        $(".select2Basic").select2('destroy');//important to reload select2
        $(".select2Basic").select2();
        self.verifyCoherenceEachSelect();
    }

    self.verifyCoherenceEachSelect = function () {

        var hasCoherence = true;
        var onlyBlank = true;

        $("#fieldSectionToCustomizeCsv .select2-chosen").toggleClass('alert alert-danger', false);
        $('#addSelectForCsv').toggleClass('disabled', false);
        $(".wizard .actions li a").toggleClass('disabled', false);

        $("#fieldSectionToCustomizeCsv select").each(function () {

            var optionValue = $(this).val();

            if (optionValue != 'TCT.blank') {
                onlyBlank = false;
                if (getNbOccurencesOption(optionValue) > 1) {

                    $(this).closest('li').find('.select2-chosen').toggleClass('alert alert-danger', true);
                    $('#addSelectForCsv').toggleClass('disabled', true);
                    $(".wizard .actions li a").toggleClass('disabled', true);
                    hasCoherence = false;
                }
            }
        });

        if (onlyBlank) {
            $(".wizard .actions li a").toggleClass('disabled', true);
            hasCoherence = false;
        }

        var nbSelectRemain = $("#fieldSectionToCustomizeCsv select").length;


        if (nbSelectRemain == 1) {
            $("#fieldSectionToCustomizeCsv .blv-font-remove").hide();
        }

        if (nbSelectRemain >= 1) {
            $('#addSelectForCsv').toggleClass('disabled', false);
        }

        if (nbSelectRemain > 1) {
            $("#fieldSectionToCustomizeCsv .blv-font-remove").show();
        }


        if (nbSelectRemain >= nbLetterMax - 1) {
            $('#addSelectForCsv').toggleClass('disabled', true);
        }

        if (nbSelectRemain == 0) {
            hasCoherence = false;
        }

        return hasCoherence;
    };

    self.init = function () {

        $(document).on("click", "#addSelectForCsv", function (e) {

            createOneSelect('TCT.blank', 'producerOrigin', false);
            renameAllColumns();

            $(".select2Basic").select2('destroy');//important to reload select2
            $(".select2Basic").select2();

            self.verifyCoherenceEachSelect();
            app.Stepper.resizeHeightJquerySteps();
        });

        $(document).on("click", "#fieldSectionToCustomizeCsv .blv-font-remove", function (e) {
            var nbSelect = $("#fieldSectionToCustomizeCsv select").length;
            if (nbSelect == 1) {
                return false;
            }
            $(this).closest('li').animate({opacity: 0}, 400, function () {
                $(this).closest('li').remove();
                renameAllColumns();
                self.verifyCoherenceEachSelect();
                app.Stepper.resizeHeightJquerySteps();
            });
        });

        $(document).on("change", "#fieldSectionToCustomizeCsv select", function (e) {
            self.verifyCoherenceEachSelect();
        });

        $(document).on("click", "#defaultTemplate", function (e) {
            var $firstLi = $('#fieldSectionToCustomizeCsv li:eq(0)');
            if (true === $firstLi.hasClass('forcedLayoutDisable')) {
                $firstLi.remove();
                renameAllColumns();
            }
            createTemplate(standardLayout);
        });
    };

    app.Stepper.Custom = self;

})(RoyaltiesReportManager);

//app.Stepper.Generate
(function (app) {

    var self = {};

    self.reportType;
    self.scopeDateFrom;
    self.scopeDateFromStr;
    self.scopeDateTo;
    self.scopeDateToStr;
    self.templateType;
    self.dedicatedOptionsList;
    self.dedicatedPrecisionStr;
    self.splitPrecisionStr;

    function setAllFieldStep() {
        self.reportType = $('#reportType').val();
        self.scopeDateFrom = $("#datetimepicker1").datepicker('getDate');
        self.scopeDateFromStr = parseInt(self.scopeDateFrom.getFullYear()) + '-' + parseInt(self.scopeDateFrom.getMonth() + 1);
        self.scopeDateTo = $("#datetimepicker2").datepicker('getDate');
        self.scopeDateToStr = parseInt(self.scopeDateTo.getFullYear()) + '-' + parseInt(self.scopeDateTo.getMonth() + 1);
        self.templateType = $('#templateType').val();
        self.dedicatedOptionsList = app.Stepper.Report.getAllDedicatedOptionId();

        if (self.reportType == 'useDedicatedReport') {
            self.dedicatedPrecisionStr = $("#dedicatedMyReport input[name='dedicatedReport']:checked").val();
        } else {
            self.dedicatedPrecisionStr = '';
        }
    }

    self.fillSummary = function () {

        var summaryCustomStr;
        var tooltipDetailOption;
        var summaryReportStr;
        var columns = [];

        setAllFieldStep();

        if (self.reportType == 'useDedicatedReport') {
            switch (self.dedicatedPrecisionStr) {
                case 'atLeastLabel':
                    summaryReportStr = VAR_LANG_REPORT_PAYMENT['DEDICATED_LABEL'];
                    break;
                case 'atLeastArtist':
                    summaryReportStr = VAR_LANG_REPORT_PAYMENT['DEDICATED_ARTIST'];
                    break;
                case 'atLeastRelease':
                    summaryReportStr = VAR_LANG_REPORT_PAYMENT['DEDICATED_ALBUM'];
                    break;
                case 'atLeastTrack':
                    summaryReportStr = VAR_LANG_REPORT_PAYMENT['DEDICATED_SONG'];
                    break;
                case 'atLeastStore':
                    summaryReportStr = VAR_LANG_REPORT_PAYMENT['DEDICATED_STORE'];
                    break;
                case 'atLeastCountry':
                    summaryReportStr = VAR_LANG_REPORT_PAYMENT['DEDICATED_COUNTRY'];
                    break;
                case 'allCatalog':
                    summaryReportStr = VAR_LANG_REPORT_MANAGER['UNIQUE_REPORT_ALL_CATALOG'];
                    break;
            }
        } else if (self.reportType == 'useLegacyDedicatedReport') {

            summaryReportStr = VAR_LANG_REPORT_PAYMENT['TABLE_DATA_GLOBAL_REPORT'];

        } else if (self.reportType == 'useSplitReport') {
            self.splitPrecisionStr = $("#splitMyReport input[name='splitReport']:checked").val();
            switch (self.splitPrecisionStr) {
                case 'perLabels':
                    summaryReportStr = VAR_LANG_REPORT_PAYMENT['SPLIT_PER_LABEL_TEXT'];
                    break;
                case 'perArtists':
                    summaryReportStr = VAR_LANG_REPORT_PAYMENT['SPLIT_PER_ARTIST_TEXT'];
                    break;
                case 'perReleases':
                    summaryReportStr = VAR_LANG_REPORT_PAYMENT['SPLIT_PER_ALBUM_TEXT'];
                    break;
                case 'perStores':
                    summaryReportStr = VAR_LANG_REPORT_PAYMENT['SPLIT_PER_STORE_TEXT'];
                    break;
                case 'perCountries':
                    summaryReportStr = VAR_LANG_REPORT_PAYMENT['SPLIT_PER_COUNTRY_TEXT'];
                    break;
            }
        }

        $("#fieldSectionToCustomizeCsv select option:selected").each(function (i) {
            columns.push($(this).html());
        });
        summaryCustomStr = columns.join(', ');

        tooltipDetailOption = '<ul>';

        $.each(app.Stepper.Report.getAllDedicatedOptionName(), function (key, value) {
            tooltipDetailOption += '<li> <strong>&middot; </strong> ' + value + '</li>';
        });
        tooltipDetailOption += '</ul>';

        displayFromToDate();
        $('#summaryReport').html(summaryReportStr + tooltipDetailOption);
        $('#summaryCustom').html(summaryCustomStr);
        $("[data-toggle='tooltip']").bootstrapTooltip({html: true});
    };

    function displayFromToDate() {

        var langVarScopeDate = VAR_LANG_REPORT_PAYMENT['SCOPE_REQUESTED_DATE_TEXT'];
        langVarScopeDate = langVarScopeDate.replace('#DATE_BEGIN_MONTH#', VAR_LANG_LANG_DATE['DATE_MONTH_' + parseInt(self.scopeDateFrom.getMonth() + 1)]);
        langVarScopeDate = langVarScopeDate.replace('#DATE_BEGIN_YEAR#', parseInt(self.scopeDateFrom.getFullYear()));
        langVarScopeDate = langVarScopeDate.replace('#DATE_END_MONTH#', VAR_LANG_LANG_DATE['DATE_MONTH_' + parseInt(self.scopeDateTo.getMonth() + 1)]);
        langVarScopeDate = langVarScopeDate.replace('#DATE_END_YEAR#', parseInt(self.scopeDateTo.getFullYear()));

        if (self.scopeDateFrom.getFullYear() == self.scopeDateTo.getFullYear()) {
            if (self.scopeDateFrom.getMonth() == self.scopeDateTo.getMonth()) {
                langVarScopeDate = VAR_LANG_LANG_DATE['DATE_MONTH_' + parseInt(self.scopeDateFrom.getMonth() + 1)] + ' ' + parseInt(self.scopeDateFrom.getFullYear());
            }
        }

        $('#summaryPeriod').html(langVarScopeDate);
    }

    app.Stepper.Generate = self;

})(RoyaltiesReportManager);

//app.ManageError
(function (app) {

    var self = {};

    self.displayAModalError = function (messageError) {
        var modalHtml =
            '<div class="modal fade" id="modalForError" role="dialog">' +
            '<div class="modal-dialog">' +
            '<div class="modal-content">' +
            '<div class="alert alert-danger">' +
            '<button type="button" class="close" data-dismiss="modal">X</button>' +
            '<h4 class="modal-title">Error</h4>' +
            '</div>' +
            '<div class="text-center">' +
            '<h5>' + messageError + '</h5>' +
            '</div>' +
            '<div class="modal-footer">' +
            '<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';
        $('body').append(modalHtml);
        $("#modalForError").modal({backdrop: "static"});
    };

    app.ManageError = self;

})(RoyaltiesReportManager);

//app.GoogleAnalytics
(function (app) {
    var self   = {};
    var gaEvents = null;
    var clickOnOnboardFinalButton = false;

    self.setGaEvents = function(events) {
        gaEvents = events;
    }

    self.sendEvent = function(eventType) {
        if(gaEvents != null) {
            if(eventType in gaEvents) {
                var event = gaEvents[eventType]
                ga('send', 'event', event['category'], event['action'], event['label'], 1);
            }
        }
    }

    self.sendPage = function() {
        ga('send', 'pageview', window.location.pathname);
    }

    self.init = function () {
        $.getJSON(gaEventsFile, function(){}).done(function(json) { self.setGaEvents(json); });

        $(document).on('click', '.gaEvent', function(){
            var eventType = $(this).data('ga-event-type');
            self.sendEvent(eventType);
        });

        $(document).on('click', '.trashReport .popover-content a.btn', function(e){

            e.preventDefault();
            e.stopPropagation();
            var eventType = $(this).closest('.trashReport').data('ga-event-type');


            if($(this)[0].hasAttribute('data-dismiss')) {
                eventType = eventType + '_cancel';
            }

            if($(this)[0].hasAttribute('data-apply')) {
                eventType = eventType + '_confirm';
            }

            self.sendEvent(eventType);
        });

        $("#preview-carousel").on("click", ".carousel-control.right.carousel-done", function () {
            clickOnOnboardFinalButton = true;
            self.sendEvent('onboarding_checkbox');
        });

        $('#carousel-modal').on('hide.bs.modal', function (e) {
            if(false == clickOnOnboardFinalButton) {
                self.sendEvent('onboarding_outside');
            }
        });

        $('#preview-carousel').on('slide.bs.carousel', function (e) {
            if (e.direction === 'left') {
                self.sendEvent('onboarding_to_step_' + e.relatedTarget.getAttribute('carousel-order'));
            }
        });

        $('[name=childSelect]').change(function () {
            self.sendEvent('agent_change');
        });

        $(document).on("change", "#fieldSectionToCustomizeCsv select", function (e) {
            self.sendEvent('columns_change');
        });

    }

    app.gaEvent = self;
}(RoyaltiesReportManager));


$(document).on('mouseenter',
    '#artist-tooltip, #release-tooltip, #multiple-artist-tooltip, #multiple-release-tooltip',
    function () {
        if (isVisitor) {
            return;
        }
        let selected_type = $(this).data('type');
        let content_text = ` ${VAR_LANG_REPORT_MANAGER['TOOLTIP_REDIRECT_DATAVIZ']}`;
        let url = '/royalties/financeanalytics#tops-tab-link';
        let click = ` ${VAR_LANG_REPORT_MANAGER['CLICK_HERE']}`;
        if (selected_type === 'artist') {
             content_text = ` ${VAR_LANG_REPORT_MANAGER['TOOLTIP_REDIRECT_SPLIT']}`;
             url = '/royalties/splitroyalties';
        }
    $(this).tooltip({
        content: function () {
            let tooltip = `
                    <div class="tooltip-single">
                        <div class="tooltip-single-content">${content_text}</div>
                        <div class="text-muted">
                            <strong><u><a id="redirect_link" data-url="${url}" class="text-muted" role="button"> ${click} </a></u></strong>                          
                        </div>
                    </div>`;
            return tooltip;
        },
        tooltipClass: "tooltip-single",
        position: {
            my: "center bottom-10",
            at: "center top",
        },
        close: function (event, ui) {
            ui.tooltip.hover(function () {
                $(this).stop(true).fadeTo(400, 1);
            },
                function () {
                    $(this).fadeOut("400", function () {
                        $(this).remove();
                    })
                });
        },
        hide: {
            effect: "fadeOut",
            duration: 400
        },

    });
});
// on click on button go to dataviz redirect to link with scroll
$(document).on('click', '#redirect_link', function () {
    let url = $(this).data('url');
    if (url.includes('financeanalytics')) {
        pushEventForTracking('financial_report_step', {popin_click: 'release report to dataviz'});
    }
    if (url.includes('splitroyalties')) {
        pushEventForTracking('financial_report_step', {popin_click: 'artist report to split'});
    }
    window.location.href = url;
});

function addWizardMessage(message) {
    if (isVisitor !== true) {
        $('#wizardStepGenerateReport .actions').append(
            '<div class="pull-left blvstep-message">' + message + '</div>'
        );
    }
}

$(document).ready(function () {
    RoyaltiesReportManager.AvailableReport.init();
    RoyaltiesReportManager.ChildReport.init();
    RoyaltiesReportManager.Tour.init();
    RoyaltiesReportManager.Stepper.init();
    RoyaltiesReportManager.Stepper.Scope.init('#datetimepicker1', '#datetimepicker2');
    RoyaltiesReportManager.Stepper.Report.init();
    RoyaltiesReportManager.Stepper.Custom.init();
    $(".select2Basic").select2();
    RoyaltiesReportManager.AvailableReport.handleReportGeneration();
    RoyaltiesReportManager.OneClickReport.init();
    RoyaltiesReportManager.AutoGeneratedReport.init();
    RoyaltiesReportManager.gaEvent.init();
    addWizardMessage(disabledMonthsText);
    pushEventForTracking('finance_view');
    if (window.location.href.indexOf("errorDownload") > -1) {
        $('#download-error-popin').modal('show');
    }
});

$('#hrefToRequestedReports').on('click', function () {
    $('#monthlyGeneratedReports').hide();
    $('#requestedReports').show();
    reportType = 'requested reports';
    pushEventForTracking('tab_open', {element_title: 'requested reports'});
});
$('#hrefToMonthlyGeneratedReports').on('click', function () {
    $('#monthlyGeneratedReports').show();
    $('#requestedReports').hide();
    reportType = 'automatic reports';
    pushEventForTracking('tab_open', {element_title: 'automatic reports'});
})

$(document).on('click', '.reportDownload', function () {
    let reportFileName = $(this).data('report-filename').split(".")[0];
    let reportFileExtension = $(this).data('report-filename').split(".")[1];

    pushEventForTracking('file_download', {
        file_extension: '.' + reportFileExtension,
        file_name: reportFileName,
        file_type: reportType
    });

})

$(document).on('click', '.reportPDFDownload', function () {
    let reportFileName = $(this).data('report-filename').split(".")[0];

    pushEventForTracking('file_download', {
        file_extension: 'pdf',
        file_name: reportFileName,
        file_type: 'requested reports pdf'
    })

})



$(document).on('click', '#useDedicatedReport', function () {
    reportOption = 'single full';
})
$(document).on('change', ".single-report :radio , .multiple-report :radio", function () {
    reportOption = $(this).data('report-option');
})

$(window).scroll(function () {
    if (customReportInterested === false
        && $(window).scrollTop() > ($(document).height()/2)
    ) {
        pushEventForTracking('financial-report_step', {
            step_name: 'period'
        });
        customReportInterested = true;
    }
});

function pushEventForTracking(eventToPush, parametersToPush = {})
{
    let data = {
        'event': eventToPush
    };

    for (const [key, value] of Object.entries(parametersToPush)) {
        data[key] = value;
    }
   
}


